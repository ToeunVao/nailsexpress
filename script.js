import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth,signInWithEmailAndPassword,createUserWithEmailAndPassword,onAuthStateChanged,signOut,signInAnonymously,updateEmail,updatePassword,EmailAuthProvider,reauthenticateWithCredential}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore,collection,addDoc,onSnapshot,query,doc,getDoc,deleteDoc,serverTimestamp,where,getDocs,orderBy,Timestamp,updateDoc,writeBatch,setDoc,arrayUnion,arrayRemove,runTransaction}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{getStorage,ref,uploadBytes,getDownloadURL,deleteObject}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyAGZBJFVi_o1HeGDmjcSsmCcWxWOkuLc_4",authDomain:"nailexpress-10f2f.firebaseapp.com",projectId:"nailexpress-10f2f",storageBucket:"nailexpress-10f2f.appspot.com",messagingSenderId:"1015991996673",appId:"1:1015991996673:web:b6e8888abae83906d34b00"},app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app),storage=getStorage(app),purchaseForm=document.getElementById("landing-gift-card-form");let allTasks=[],backupSettings={frequency:"weekly",lastBackup:null};const loadingScreen=document.getElementById("loading-screen"),landingPageContent=document.getElementById("landing-page-content"),appContent=document.getElementById("app-content"),clientDashboardContent=document.getElementById("client-dashboard-content"),policyModal=document.getElementById("policy-modal"),addAppointmentModal=document.getElementById("add-appointment-modal"),promotionsContainerLanding=document.getElementById("promotions-container-landing"),serviceModal=document.getElementById("service-modal"),modalTitle=document.getElementById("modal-title"),modalContent=document.getElementById("modal-content");let salonRevenueChart,myEarningsChart,staffEarningsChart,profitChart,clientSpendingChart,clientServicesChart,mainAppInitialized=!1,landingPageInitialized=!1,clientDashboardInitialized=!1,anonymousUserId=null,bookingSettings={minBookingHours:2,defaultDuration:40,bufferTime:0},loginSecuritySettings={maxAttempts:5,lockoutMinutes:15},salonHours={},notifications=[],currentUserRole=null,currentUserName=null,currentUserId=null,initialAppointmentsLoaded=!1,initialInventoryLoaded=!1,allFinishedClients=[],allAppointments=[],allClients=[],allActiveClients=[],servicesData={},allServicesList=[],allColorBrands=[],allMembershipTiers=[],allPromotions=[],allNailIdeas=[],techniciansAndStaff=[],technicians=[],currentGalleryData=[],currentRotation=0,royaltySettings={visitsNeeded:10,rewardDescription:"One Free Classic Manicure"},allRoyaltyCards=[],globalListenersAttached=!1,holidaySettings={dates:[],message:"The salon is closed on the selected date."},holidayCalYear=(new Date).getFullYear(),holidayCalMonth=(new Date).getMonth(),currentLightboxImageIndex=0,currentLightboxIdea=null,allShopProducts=[],shoppingCart=loadCartFromLocalStorage(),globalTaxRate=0,globalShippingFee=0,allWaitlistEntries=[],currentProductModalImageIndex=0;const nailIdeaLightbox=document.getElementById("nail-idea-lightbox"),lightboxCloseBtn=document.getElementById("lightbox-close-btn"),lightboxPrevBtn=document.getElementById("lightbox-prev-btn"),lightboxNextBtn=document.getElementById("lightbox-next-btn"),lightboxImage=document.getElementById("lightbox-image"),lightboxTitle=document.getElementById("lightbox-title"),lightboxShape=document.getElementById("lightbox-shape"),lightboxColor=document.getElementById("lightbox-color"),lightboxCategories=document.getElementById("lightbox-categories"),lightboxDescription=document.getElementById("lightbox-description");let currentLightboxIndex=0,allFeaturedReviews=[],pendingWaitlistData=null,globalOnlineGcStartNumber=1e3,globalLastUsedOnlineGcNumber=0,membershipRewardSettings={threshold:500,type:"fixed",value:25},allClientMemberships=[],allStaffEarnings=[],currentMatrixViewType="earning";const MONTH_NAMES=["January","February","March","April","May","June","July","August","September","October","November","December"],giftCardBackgrounds={General:["https://img.freepik.com/premium-photo/women-s-legs-with-bright-pedicure-pink-background-chamomile-flower-decoration-spa-pedicure-skincare-concept_256259-166.jpg","https://png.pngtree.com/thumb_back/fh260/background/20250205/pngtree-soft-pastel-floral-design-light-blue-background-image_16896113.jpg","https://files.123freevectors.com/wp-content/original/119522-abstract-pastel-pink-background-image.jpg"],Holidays:["https://media.istockphoto.com/id/1281966270/vector/christmas-background-with-snowflakes.jpg?s=612x612&w=0&k=20&c=3t2mJbipFc4aln2M8qDbd3kJvUwtjl1md1F3Rj0xVI4=","https://media.istockphoto.com/id/1180986336/vector/red-bokeh-snowflakes-background.jpg?s=612x612&w=0&k=20&c=NR_Hf8C2owuvtCxtjk789Ckynqdm6l2oDWLHwI7uqlE=","https://png.pngtree.com/background/20210710/original/pngtree-red-christmas-snow-winter-cartoon-show-board-background-picture-image_979028.jpg"],Valentines:["https://slidescorner.com/wp-content/uploads/2023/02/01-Cute-Pink-Hearts-Valentines-Day-Background-Aesthetic-FREE-by-SlidesCorner.com_.jpg","https://images.rawpixel.com/image_800/cHJpdmF0ZS9sci9pbWFnZXMvd2Vic2l0ZS8yMDIzLTExL2xhdXJhc3RlZmFubzI2Nl9waW5rX3ZhbGVudGluZXNfZGF5X2JhY2tncm91bmRfd2l0aF9oZWFydHNfYm9rZV9kZTAzMWNjMy05MmJmLTQ2NzAtYjliZC0wN2Y2ZDkzYTM1ZDBfMS5qcGc.jpg","https://cms-artifacts.artlist.io/content/motion_array/1390934/Valentines_Day_Romantic_Background_high_resolution_preview_1390934.jpg?Expires=2037527646045&Key-Pair-Id=K2ZDLYDZI2R1DF&Signature=fCbOC95RTvVc0Ld-pyxhFN5gzuS-VqGG1UYsxvu48kx8A6rdAPf~gjuv0sVBrV~0p0~2u99BYafKT5oRUsRbluBt9c8eH4k~YXVcT2KdNrQUjVD-wKS2qTcgdp8aVDYCCILMkFT4hrWRWzKlsjjgoBe7mAIaHV3cc2iqMErb-qGWlk8jX0J8vLfCvXH~daNNPMqO7tssbeYiHVrD7y89fbJ0YRVfR6wwb1AoBLseF8-7IsAZe8Hh2bn-kUEp8KocRZ4X7DBTFD~9Ho-E0HeRym4oZ37u3BdLAqY-y0a1HdIf3dOXXkF6X~UQpMlPtxTvWj4857QSez20b1mhnBhpsQ__"],Birthday:["https://marketplace.canva.com/EAGhbM7XcuY/1/0/1600w/canva-white-and-blue-birthday-background-card-yqLk4e5MQjY.jpg","https://images.rawpixel.com/image_800/czNmcy1wcml2YXRlL3Jhd3BpeGVsX2ltYWdlcy93ZWJzaXRlX2NvbnRlbnQvbHIvam9iNTE2LW51bm9vbi0xMC5qcGc.jpg","https://www.creativefabrica.com/wp-content/uploads/2021/08/30/Happy-birthday-background-design-Graphics-16518598-1-1-580x430.jpg"]},renderEarningsMatrix=e=>{const t=document.getElementById("staff-earning-matrix-table");if(!t)return;const n=t.querySelector("thead"),a=t.querySelector("tbody"),o=document.getElementById("matrix-month-filter").value,i=(new Date).getFullYear();let s='<tr><th class="p-2 border border-pink-700 bg-pink-700 sticky left-0 z-10 w-24">Month</th>';for(let e=1;e<=31;e++)s+=`<th class="p-1 border border-pink-500 w-8">${e}</th>`;s+='<th class="p-2 border border-pink-700 bg-pink-800 font-bold">Total</th></tr>',n.innerHTML=s;let d={};for(let e=0;e<12;e++)d[e]=new Array(32).fill(0);e.forEach((e=>{const t=parseFloat(e.earning)||0,n=parseFloat(e.tip)||0,a=e.date instanceof Date?e.date:e.date.toDate(),o=(new Date).getFullYear();if(a.getFullYear()!==o)return;const i=a.getMonth(),s=a.getDate();1===s&&0===i&&console.log(`[DEBUG] Processing record: Date ${a.toLocaleDateString()}, Earning ${t}, Tip ${n}`);const r="earning"===currentMatrixViewType?t:n;d[i][s]+=r})),a.innerHTML="";for(let e=0;e<12;e++){if("all"!==o&&parseInt(o)!==e)continue;let t='<tr class="hover:bg-gray-50 transition-colors">';t+=`<td class="p-2 font-bold text-gray-700 bg-gray-100 border border-gray-300 sticky left-0 text-left z-10">${MONTH_NAMES[e]}</td>`;let n=0;for(let a=1;a<=31;a++){const o=d[e][a];n+=o;let s="border border-gray-200 p-1",r="";a>new Date(i,e+1,0).getDate()?s+=" bg-gray-200":o>0?(s+="earning"===currentMatrixViewType?" text-pink-600 font-bold bg-pink-50":" text-green-600 font-bold bg-green-50",r=o.toFixed(0)):(r="-",s+=" text-gray-300"),t+=`<td class="${s}">${r}</td>`}t+=`<td class="p-2 border border-gray-300 font-bold bg-gray-100 text-gray-800">$${n.toFixed(2)}</td>`,t+="</tr>",a.insertAdjacentHTML("beforeend",t)}};function applyStaffEarningFilters(e,t,n){let a=e;const o=getLocalDateString();if(t)return a.filter((e=>e.date===t));const i=new Date,s=i.getMonth(),d=i.getFullYear();switch(n){case"0":a=a.filter((e=>e.date===o));break;case"1":const e=new Date(i);e.setDate(i.getDate()-6);const t=getLocalDateString(e);a=a.filter((e=>e.date>=t&&e.date<=o));break;case"2":const r=new Date(i);r.setDate(i.getDate()-29);const l=getLocalDateString(r);a=a.filter((e=>e.date>=l&&e.date<=o));break;case"3":a=a.filter((e=>{const t=e.date.split("-");if(t.length<3)return!1;const n=parseInt(t[1]),a=parseInt(t[0]);return n-1===s&&a===d}));break;default:const c=parseInt(n);!isNaN(c)&&c>=0&&c<=11&&(a=a.filter((e=>{const t=e.date.split("-");if(t.length<3)return!1;const n=parseInt(t[1]),a=parseInt(t[0]);return n-1===c&&a===d})))}return a}function renderStaffReport(e,t){const n=document.getElementById("staff-earnings-report-container");if(!n)return;if(0===t.length)return void(n.innerHTML=`<p class="text-center text-gray-500 py-4 border rounded-lg bg-white">No earnings recorded for Staff ID: ${e} on the selected date/filter.</p>`);const a=t.reduce(((e,t)=>e+(t.total||0)),0),o=.4*a;n.innerHTML=`\n        <div class="space-y-4">\n            <h3 class="text-2xl font-extrabold text-pink-600 mb-4">Staff Earnings Report</h3>\n            <p class="text-sm text-gray-600 font-medium">Staff ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded-md text-pink-800">${e}</span></p>\n            \n            <div class="grid grid-cols-2 gap-4">\n                \x3c!-- Total Earnings Card --\x3e\n                <div class="p-5 bg-white rounded-xl shadow-lg border border-pink-100 transition duration-300 hover:shadow-xl">\n                    <p class="text-sm text-gray-500 font-medium">Total Earnings (Gross)</p>\n                    <p class="text-3xl font-bold text-green-600 mt-1">$${a.toFixed(2)}</p>\n                </div>\n                \x3c!-- Commission Card --\x3e\n                <div class="p-5 bg-white rounded-xl shadow-lg border border-pink-100 transition duration-300 hover:shadow-xl">\n                    <p class="text-sm text-gray-500 font-medium">Estimated Commission (40%)</p>\n                    <p class="text-3xl font-bold text-blue-600 mt-1">$${o.toFixed(2)}</p>\n                </div>\n            </div>\n            \n            \x3c!-- Detailed list of transactions --\x3e\n            <div class="bg-white p-4 rounded-xl shadow-inner max-h-80 overflow-y-auto mt-4">\n                <h4 class="text-lg font-semibold mb-3 border-b pb-2 text-pink-700">Detailed Transactions (${t.length})</h4>\n                <div class="space-y-3">\n                    ${t.map((e=>`\n                        <div class="flex justify-between items-center text-sm border-b last:border-b-0 pb-2">\n                            <span class="text-gray-700 font-medium">${e.date||"N/A"}</span>\n                            <span class="text-gray-500 text-xs">${e.clientName||"N/A"}</span>\n                            <span class="font-bold text-right text-green-600">$${(e.total||0).toFixed(2)}</span>\n                        </div>\n                    `)).join("")}\n                </div>\n            </div>\n        </div>\n    `}function fetchStaffEarnings(e,t){const n=`artifacts/${appId}/public/data/salon_earnings`,a=collection(db,n);let o=query(a,where("staffId","==",e));return t&&(o=query(o,where("date","==",t))),console.log("[STAFF REPORT DEBUG] Querying for Staff ID:",e),console.log("[STAFF REPORT DEBUG] Querying Collection Path:",n),onSnapshot(o,(t=>{const a=[];t.forEach((e=>{a.push({id:e.id,...e.data()})})),console.log("[STAFF REPORT DEBUG] Fetched",a.length,"earnings documents."),0===a.length&&(console.log(" [STAFF REPORT DEBUG] Zero documents found. Check the following in your database:"),console.log(" 1. Collection:",n),console.log(" 2. Field Name: 'staffId' (Must match this exactly, case-sensitive)"),console.log(" 3. Field Value: Must match the Staff ID shown above.")),allSalonEarnings=a,renderStaffReport(e,a)}),(e=>{console.error("Error fetching staff earnings:",e)}))}function setupStaffDetailsPage(e){const t=getLocalDateString(),n=document.getElementById("staff-details-date-filter");if(!n)return void console.error("Staff details date filter input not found.");n.value=t;let a=fetchStaffEarnings(e,n.value);n.addEventListener("change",(()=>{const t=n.value;a&&a(),a=fetchStaffEarnings(e,t)}))}function setupStaffEarningsListener(e,t=1){if(!e)return void console.error("Staff ID not available for earnings report setup.");if(0===techniciansAndStaff.length)return void(t<5?(console.log(`[DEBUG RETRY] Staff list not yet loaded. Retrying in 500ms (Attempt ${t}/5).`),setTimeout((()=>setupStaffEarningsListener(e,t+1)),500)):console.error("Staff list failed to load after 5 attempts. Cannot set up earnings report."));console.log(`[DEBUG STAFF LIST] Array Size: ${techniciansAndStaff.length}`),techniciansAndStaff.length>0&&console.log("[DEBUG STAFF LIST] First item structure (to check for UID field name):",techniciansAndStaff[0]);const n=techniciansAndStaff.find((t=>t.id===e||t.uid===e||t.staffId===e));if(!n)return void console.error("Could not find staff member details for ID:",e,"in the techniciansAndStaff list.");console.log(`[DEBUG FOUND] Found staff member: ${n.name}`);n.name.toLowerCase();const a="earnings",o=collection(db,a),i="staffName",s=query(o,where(i,"==",n.name));console.warn(`[DEBUG QUERY - FOCUSED] Querying CORRECTED collection '${a}' where field '${i}' equals '${n.name}'.`);const d=document.getElementById("staff-report-loading");d&&d.classList.remove("hidden"),onSnapshot(s,(e=>{console.log(`[DEBUG STEP 1] Documents received from Firestore: ${e.docs.length}`),e.docs.length>0?console.log("[DEBUG RAW DATA] First Document Fields:",e.docs[0].data()):console.error("Query still fetching 0 records. Check: 1) Collection name is correct ('earnings') 2) Document field is 'staffName' and value is 'TJ' 3) Missing Index."),allStaffEarnings=e.docs.map((e=>{const t=e.data(),n=parseFloat(t.earning)||0,a=parseFloat(t.tip)||0;return{id:e.id,...t,date:t.finishTimestamp&&t.finishTimestamp.toDate?t.finishTimestamp.toDate():t.appointmentTimestamp&&t.appointmentTimestamp.toDate?t.appointmentTimestamp.toDate():t.date&&t.date.toDate?t.date.toDate():new Date,earning:n,tip:a}})),allStaffEarnings.length>0?renderEarningsMatrix(allStaffEarnings):document.getElementById("staff-earning-matrix-table").querySelector("tbody").innerHTML='<tr><td colspan="33" class="p-4 text-center text-gray-500">No earnings data found for this year.</td></tr>',d&&d.classList.add("hidden")}),(e=>{console.error("Error fetching staff earnings:",e),d&&d.classList.add("hidden")}))}function setupStaffReportFilters(){const e=document.getElementById("staff-earning-date-filter"),t=document.getElementById("staff-earning-range-filter"),n=getLocalDateString();e&&(currentStaffEarningDateFilter||currentStaffEarningRangeFilter||(e.value=n,currentStaffEarningDateFilter=n),e.addEventListener("change",(e=>{currentStaffEarningDateFilter=e.target.value,t&&(t.value=""),currentStaffEarningRangeFilter="";const n=allStaffEarnings.filter((e=>e.totalEarning>0)),a=applyStaffEarningFilters(n,currentStaffEarningDateFilter,currentStaffEarningRangeFilter);renderStaffEarningsReport(a)}))),t&&t.addEventListener("change",(t=>{currentStaffEarningRangeFilter=t.target.value,e&&(e.value=""),currentStaffEarningDateFilter="";const n=allStaffEarnings.filter((e=>e.totalEarning>0)),a=applyStaffEarningFilters(n,currentStaffEarningDateFilter,currentStaffEarningRangeFilter);renderStaffEarningsReport(a)}))}const initializeChart=(e,t,n,a,o)=>(e?(e.data=a,e.options=o,e.update()):e=new Chart(t,{type:n,data:a,options:o}),e),colorPalette=[{card:"bg-pink-100",text:"text-pink-800",bg:"rgba(255, 99, 132, 0.5)",border:"rgba(255, 99, 132, 1)"},{card:"bg-blue-100",text:"text-blue-800",bg:"rgba(54, 162, 235, 0.5)",border:"rgba(54, 162, 235, 1)"},{card:"bg-green-100",text:"text-green-800",bg:"rgba(75, 192, 192, 0.5)",border:"rgba(75, 192, 192, 1)"},{card:"bg-yellow-100",text:"text-yellow-800",bg:"rgba(255, 206, 86, 0.5)",border:"rgba(255, 206, 86, 1)"},{card:"bg-purple-100",text:"text-purple-800",bg:"rgba(153, 102, 255, 0.5)",border:"rgba(153, 102, 255, 1)"},{card:"bg-teal-100",text:"text-teal-800",bg:"rgba(32, 201, 151, 0.5)",border:"rgba(32, 201, 151, 1)"},{card:"bg-indigo-100",text:"text-indigo-800",bg:"rgba(79, 70, 229, 0.5)",border:"rgba(79, 70, 229, 1)"},{card:"bg-orange-100",text:"text-orange-800",bg:"rgba(255, 159, 64, 0.5)",border:"rgba(255, 159, 64, 1)"}],addNotification=(e,t)=>{const n=document.getElementById("notification-container");if(!n)return void console.error(`Notification container (#notification-container) not found. Message: ${t}`);const a={success:{bg:"bg-green-100",text:"text-green-800",icon:"fa-check-circle"},error:{bg:"bg-red-100",text:"text-red-800",icon:"fa-times-circle"},reminder:{bg:"bg-blue-100",text:"text-blue-800",icon:"fa-bell"}},o=a[e]||a.reminder,i=document.createElement("div");i.className=`p-4 mb-3 rounded-lg shadow-md ${o.bg} ${o.text} flex items-center justify-between transition-all duration-500 ease-in-out transform opacity-0 translate-y-4`,i.innerHTML=`\n        <div class="flex items-center">\n            <i class="fas ${o.icon} mr-3"></i>\n            <span>${t}</span>\n        </div>\n        <button class="ml-4 opacity-75 hover:opacity-100 close-btn">\n            <i class="fas fa-times"></i>\n        </button>\n    `,i.querySelector(".close-btn").addEventListener("click",(()=>{i.classList.remove("opacity-100","translate-y-0"),i.classList.add("opacity-0","translate-y-4"),setTimeout((()=>i.remove()),500)})),n.prepend(i),setTimeout((()=>{i.classList.remove("opacity-0","translate-y-4"),i.classList.add("opacity-100","translate-y-0")}),10),setTimeout((()=>{i.querySelector(".close-btn").click()}),5e3)},renderStars=e=>{let t="";const n=Math.max(0,Math.min(5,parseInt(e)||0));for(let e=1;e<=5;e++)t+=e<=n?'<i class="fas fa-star text-yellow-400"></i>':'<i class="fas fa-star text-gray-300"></i>';return`<div class="text-xl mb-4">${t}</div>`};function initializeGlobalListeners(){globalListenersAttached||(onSnapshot(query(collection(db,"memberships"),orderBy("price")),(e=>{allMembershipTiers=e.docs.map((e=>({id:e.id,...e.data()}))),"block"===landingPageContent.style.display&&renderMembershipTiers(allMembershipTiers,"landing-memberships-container",!1)})),globalListenersAttached=!0)}onAuthStateChanged(auth,(async e=>{try{if(e){initializeGlobalListeners(),currentUserId=e.uid;const t=await getDoc(doc(db,"settings","salonHours"));if(t.exists()&&(salonHours=t.data()),e.isAnonymous)loadingScreen.style.display="none",appContent.style.display="none",clientDashboardContent.style.display="none",landingPageContent.style.display="block",landingPageInitialized||(initLandingPage(),landingPageInitialized=!0);else{const t=doc(db,"users",e.uid),n=await getDoc(t);if(n.exists()){const t=n.data();currentUserRole=t.role,currentUserName=t.name;const a={...t,id:e.uid};loadingScreen.style.display="none",landingPageContent.style.display="none",clientDashboardContent.style.display="none",appContent.style.display="block",mainAppInitialized||(initMainApp(currentUserRole,currentUserName),mainAppInitialized=!0);const o=a?.role||"staff",i=document.getElementById("admin-earning-report-section"),s=document.getElementById("admin-earning-report-section-sub"),d=document.getElementById("staff-earning-report-section");document.getElementById("reports-content");"admin"===o?(i&&i.classList.remove("hidden"),s&&s.classList.remove("hidden"),d&&d.classList.add("hidden")):(i&&i.classList.add("hidden"),s&&s.classList.add("hidden"),d&&d.classList.remove("hidden"),"function"==typeof setupStaffReportFilters&&setupStaffReportFilters(),"function"==typeof setupStaffEarningsListener&&setupStaffEarningsListener(e.uid),console.log("%c[EXECUTION CONFIRM] Staff Report initialization started.","color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 5px; border-radius: 4px;"),setupStaffReportFilters(),setupStaffEarningsListener(e.uid))}else{const t=doc(db,"clients",e.uid),n=await getDoc(t);if(n.exists())loadingScreen.style.display="none",landingPageContent.style.display="none",appContent.style.display="none",clientDashboardContent.style.display="block",initClientDashboard(e.uid,n.data());else{const n=sessionStorage.getItem("pendingGiftCardPurchase"),a=sessionStorage.getItem("pendingMembershipPurchase"),o=sessionStorage.getItem("pendingRoyaltyCard"),i=sessionStorage.getItem("signupDetails");let s={role:"client",createdAt:serverTimestamp()},d=null,r=!1;if(n)d=JSON.parse(n),s.name=d.buyerName,s.email=d.buyerEmail,s.phone=d.buyerPhone;else if(a){d=JSON.parse(i),s.name=d.name,s.email=d.email,s.phone=d.phone;const e=allMembershipTiers.find((e=>e.id===a));s.membership={tierId:a,tierName:e?.name||"Unknown Tier",startDate:serverTimestamp(),status:"Pending"}}else o?(d=JSON.parse(o),s.name=d.name,s.email=d.email,s.phone=d.phone,s.royaltyCard={visits:0,lastVisit:null}):i&&(d=JSON.parse(i),s.name=d.name,s.email=d.email,s.phone=d.phone);if(!d)return console.error("New user detected, but no client document exists and no pending action found in sessionStorage. Cannot determine role."),addNotification("error","Account created, but initial setup failed. Please contact support."),await signOut(auth),loadingScreen.style.display="none",landingPageContent.style.display="block",appContent.style.display="none",void(clientDashboardContent.style.display="none");if(await setDoc(t,s),n){if(d.generatedCodes&&d.generatedCodes.length===d.quantity){const t=writeBatch(db),n=new Date;n.setMonth(n.getMonth()+6);const a={name:d.buyerName,email:d.buyerEmail,phone:d.buyerPhone};d.generatedCodes.forEach((o=>{const i={amount:d.amount,balance:d.amount,history:[],recipientName:d.recipientName,senderName:d.senderName,backgroundUrl:d.backgroundUrl,code:o,status:"Pending",type:"E-Gift",createdBy:e.uid,buyerInfo:a,createdAt:serverTimestamp(),expiresAt:Timestamp.fromDate(n)},s=doc(collection(db,"gift_cards"));t.set(s,i)}));const o=doc(db,"settings","ecommerce");t.set(o,{lastUsedOnlineGcNumber:d.finalLastNumber},{merge:!0}),await t.commit(),await sendGiftCardConfirmationEmail(d),addNotification("success","Account created & gift card request sent!")}else console.error("Gift card code generation failed during signup."),addNotification("error","Account created, but failed to process gift card request.");sessionStorage.removeItem("pendingGiftCardPurchase"),r=!0}else a?(await sendMembershipConfirmationEmail({...d,tierName:s.membership.tierName}),addNotification("success","Welcome! Account created & membership request sent."),sessionStorage.removeItem("pendingMembershipPurchase"),r=!0):o?(addNotification("success","Welcome! Your Royalty Card account is active."),sessionStorage.removeItem("pendingRoyaltyCard"),r=!0):i&&(addNotification("success",`Welcome, ${d.name}! Your account is ready.`),r=!0);sessionStorage.removeItem("signupDetails"),loadingScreen.style.display="none",landingPageContent.style.display="none",appContent.style.display="none",clientDashboardContent.style.display="block",initClientDashboard(e.uid,s)}}}}else signInAnonymously(auth).catch((e=>{console.error("Initial anonymous sign-in failed:",e),loadingScreen.innerHTML='<div class="text-center"><h2 class="text-3xl font-bold text-red-700">Initialization Error</h2><p>Could not start the application anonymously. Please check your connection or browser settings.</p></div>'}))}catch(e){console.error("Authentication State Error:",e),loadingScreen.innerHTML=`<div class="text-center"><h2 class="text-3xl font-bold text-red-700">Authentication Error</h2><p>An error occurred during authentication. Please refresh the page.</p><p class="text-xs text-gray-400 mt-4">Error: ${e.message}</p></div>`,appContent.style.display="none",clientDashboardContent.style.display="none",landingPageContent.style.display="none"}})),onSnapshot(doc(db,"settings","ecommerce"),(e=>{const t=window.renderCart||null;if(e.exists()){const n=e.data();globalTaxRate=n.taxRate||0,globalShippingFee=n.shippingFee||0,globalOnlineGcStartNumber=n.onlineGcStartNumber||1e3,globalLastUsedOnlineGcNumber=n.lastUsedOnlineGcNumber||0;const a=document.getElementById("online-gc-start-number"),o=document.getElementById("last-used-online-gc-display");a&&(a.value=globalOnlineGcStartNumber),o&&(o.textContent=globalLastUsedOnlineGcNumber>0?globalLastUsedOnlineGcNumber:"Not set");const i=document.getElementById("admin-tax-rate"),s=document.getElementById("admin-shipping-fee");i&&s&&(i.value=(100*n.taxRate).toFixed(2),s.value=n.shippingFee.toFixed(2)),"function"==typeof t&&t()}else setDoc(doc(db,"settings","ecommerce"),{taxRate:0,shippingFee:0,onlineGcStartNumber:1e3,lastUsedOnlineGcNumber:0},{merge:!0})}));const renderPromotionsLanding=e=>{promotionsContainerLanding.innerHTML="";const t=new Date,n=e.filter((e=>{const n=e.startDate.toDate(),a=e.endDate.toDate();return t>=n&&t<=a}));0!==n.length?n.forEach((e=>{const t=document.createElement("div");t.className="bg-white p-6 rounded-lg shadow-md text-center",t.innerHTML=`<h3 class="text-xl font-bold text-pink-700 mb-2">${e.title}</h3><p class="text-gray-600">${e.description}</p>`,promotionsContainerLanding.appendChild(t)})):promotionsContainerLanding.innerHTML='<p class="text-gray-600 col-span-full text-center">No active promotions right now. Check back soon!</p>'},renderNailIdeasGallery=e=>{const t=document.getElementById("nails-idea-container-landing"),n=document.getElementById("nails-idea-gallery");currentGalleryData=e;const a=(t,n)=>{if(!t)return;if(t.innerHTML="",0===e.length)return void(t.innerHTML='<p class="text-gray-500 col-span-full text-center">No nail ideas found. Check back later!</p>');(n?e.slice(0,8):e).forEach(((e,a)=>{const o=document.createElement("div");o.className="break-inside-avoid mb-4 relative gallery-item group",o.innerHTML=`\n                   <img class="w-full rounded-lg shadow-md cursor-pointer" src="${e.imageURLs&&e.imageURLs[0]||e.imageURL}" alt="${e.name}" data-index="${a}">\n                <div class="absolute top-2 right-2 bg-black/40 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">\n                   <button data-id="${e.id}" class="share-nail-idea-btn text-white text-lg"><i class="fas fa-share-alt"></i></button>\n                </div>\n                ${n?"":`<div class="p-2"><h5 class="font-bold text-sm">${e.name}</h5><p class="text-xs text-gray-600">${e.categories.join(", ")}</p></div>`}`,t.appendChild(o)}))};a(t,!0),a(n,!1)},lightboxImagePrevBtn=document.getElementById("lightbox-image-prev-btn"),lightboxImageNextBtn=document.getElementById("lightbox-image-next-btn"),lightboxImageCounter=document.getElementById("lightbox-image-counter"),displayLightboxImage=()=>{if(!currentLightboxIdea||!currentLightboxIdea.imageURLs||0===currentLightboxIdea.imageURLs.length)return;const e=currentLightboxIdea.imageURLs;lightboxImage.src=e[currentLightboxImageIndex];const t=e.length>1;lightboxImageCounter.classList.toggle("hidden",!t),lightboxImagePrevBtn.classList.toggle("hidden",!t||0===currentLightboxImageIndex),lightboxImageNextBtn.classList.toggle("hidden",!t||currentLightboxImageIndex===e.length-1),t&&(lightboxImageCounter.textContent=`${currentLightboxImageIndex+1} / ${e.length}`)},openLightbox=e=>{e<0||e>=currentGalleryData.length||(currentLightboxIndex=e,currentLightboxIdea=currentGalleryData[e],currentLightboxImageIndex=0,lightboxTitle.textContent=currentLightboxIdea.name,lightboxShape.textContent=currentLightboxIdea.shape||"N/A",lightboxColor.textContent=currentLightboxIdea.color||"N/A",lightboxDescription.textContent=currentLightboxIdea.description||"",lightboxCategories.innerHTML=(currentLightboxIdea.categories||[]).map((e=>`<span class="bg-pink-100 text-pink-700 text-xs font-semibold px-2 py-1 rounded-full">${e}</span>`)).join(""),currentRotation=0,lightboxImage.style.transform="rotate(0deg)",displayLightboxImage(),lightboxPrevBtn.classList.toggle("hidden",0===e),lightboxNextBtn.classList.toggle("hidden",e===currentGalleryData.length-1),nailIdeaLightbox.classList.remove("hidden"),nailIdeaLightbox.classList.add("flex"))},toggleFullScreen=()=>{const e=document.getElementById("nail-idea-lightbox"),t=document.getElementById("lightbox-fullscreen-btn").querySelector("i");document.fullscreenElement?(document.exitFullscreen(),t.classList.replace("fa-compress","fa-expand")):(e.requestFullscreen().catch((e=>{alert(`Error attempting to enable full-screen mode: ${e.message} (${e.name})`)})),t.classList.replace("fa-expand","fa-compress"))},rotateImage=()=>{currentRotation+=90,currentRotation>=360&&(currentRotation=0),document.getElementById("lightbox-image").style.transform=`rotate(${currentRotation}deg)`},closeLightbox=()=>{nailIdeaLightbox.classList.add("hidden"),nailIdeaLightbox.classList.remove("flex"),currentLightboxIdea=null},showNextIdea=()=>openLightbox(currentLightboxIndex+1),showPrevIdea=()=>openLightbox(currentLightboxIndex-1),showNextImage=()=>{currentLightboxIdea&&currentLightboxImageIndex<currentLightboxIdea.imageURLs.length-1&&(currentLightboxImageIndex++,displayLightboxImage())},showPrevImage=()=>{currentLightboxIdea&&currentLightboxImageIndex>0&&(currentLightboxImageIndex--,displayLightboxImage())},galleryClickHandler=e=>{const t=e.target.closest(".share-nail-idea-btn");if(t){const e=t.dataset.id,n=allNailIdeas.find((t=>t.id===e));return void(n&&openShareModal(n))}const n=e.target.closest("img");if(n&&n.dataset.index){const e=parseInt(n.dataset.index,10);isNaN(e)||openLightbox(e)}};document.getElementById("nails-idea-gallery").addEventListener("click",galleryClickHandler),document.getElementById("nails-idea-landing").addEventListener("click",galleryClickHandler),lightboxCloseBtn.addEventListener("click",closeLightbox),lightboxNextBtn.addEventListener("click",showNextIdea),lightboxPrevBtn.addEventListener("click",showPrevIdea),lightboxImageNextBtn.addEventListener("click",showNextImage),lightboxImagePrevBtn.addEventListener("click",showPrevImage),document.getElementById("lightbox-fullscreen-btn").addEventListener("click",toggleFullScreen),document.getElementById("lightbox-rotate-btn").addEventListener("click",rotateImage),document.addEventListener("keydown",(e=>{nailIdeaLightbox.classList.contains("hidden")||("ArrowRight"===e.key&&showNextIdea(),"ArrowLeft"===e.key&&showPrevIdea(),"Escape"===e.key&&closeLightbox())})),nailIdeaLightbox.addEventListener("click",(e=>{e.target===nailIdeaLightbox&&closeLightbox()}));const openShareModal=e=>{const t="http://www.nailsxpressky.com",n=`Check out this amazing nail design from Nails Express: ${e.name}!`,a=e.imageURLs&&e.imageURLs[0]||e.imageURL;document.getElementById("share-facebook").href=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(t)}`,document.getElementById("share-pinterest").href=`http://pinterest.com/pin/create/button/?url=${encodeURIComponent(t)}&media=${encodeURIComponent(a)}&description=${encodeURIComponent(n)}`,document.getElementById("share-twitter").href=`https://twitter.com/intent/tweet?text=${encodeURIComponent(n)}&url=${encodeURIComponent(t)}`,document.getElementById("share-copy-link").onclick=()=>{navigator.clipboard.writeText(t).then((()=>alert("Link copied to clipboard!")))},shareModal.classList.remove("hidden"),shareModal.classList.add("flex")},closeShareModal=()=>{shareModal.classList.add("hidden"),shareModal.classList.remove("flex")};document.getElementById("share-close-btn").addEventListener("click",closeShareModal),document.querySelector(".share-modal-overlay").addEventListener("click",closeShareModal);const updateLandingGiftCardPreview=()=>{if(!document.getElementById("landing-gift-card-form"))return;const e=document.getElementById("gc-show-to").checked,t=document.getElementById("gc-show-from").checked;document.getElementById("gc-to-wrapper").style.display=e?"":"none",document.getElementById("gc-from-wrapper").style.display=t?"":"none",document.getElementById("landing-gc-preview-to").parentElement.style.display=e?"":"none",document.getElementById("landing-gc-preview-from").parentElement.style.display=t?"":"none",document.getElementById("landing-gc-preview-to").textContent=document.getElementById("gc-to").value||"Recipient",document.getElementById("landing-gc-preview-from").textContent=document.getElementById("gc-from").value||"Sender";const n=parseFloat(document.getElementById("gc-amount").value)||0,a=parseInt(document.getElementById("gc-quantity").value,10)||1;document.getElementById("landing-gc-preview-amount").textContent=`$${n.toFixed(2)}`,document.getElementById("landing-gc-total-amount").textContent=`$${(n*a).toFixed(2)}`;const o=new Date;o.setMonth(o.getMonth()+6);const i=o.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"});document.getElementById("landing-gc-preview-expiry").textContent=`Expires: ${i}`},initializeLandingGiftCardDesigner=()=>{const e=document.getElementById("landing-gift-card-form"),t=document.getElementById("landing-gc-preview-card");if(!e||!t)return;e.reset(),document.getElementById("gc-quantity").value=1;const n=document.getElementById("landing-gc-background-tabs"),a=document.getElementById("landing-gc-background-options");n.innerHTML=Object.keys(giftCardBackgrounds).map((e=>`<button type="button" data-category="${e}" class="px-3 py-1 text-sm font-medium rounded-t-lg">${e}</button>`)).join("");const o=n.querySelector("button");o&&(o.classList.add("bg-gray-200","border-gray-300","border-b-0"),a.innerHTML=giftCardBackgrounds[o.dataset.category].map((e=>`<button type="button" data-bg="${e}" class="w-full h-16 bg-cover bg-center rounded-md border-2 border-transparent hover:border-pink-400" style="background-image: url('${e}')"></button>`)).join(""),t.style.backgroundImage=`url('${giftCardBackgrounds[o.dataset.category][0]}')`),updateLandingGiftCardPreview()},getLocalDateString=(e=new Date)=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;function saveCartToLocalStorage(){localStorage.setItem("nails_express_shopping_cart",JSON.stringify(shoppingCart))}function loadCartFromLocalStorage(){const e=localStorage.getItem("nails_express_shopping_cart");return e?JSON.parse(e):[]}const openCardForPrint=e=>{const t=e.expiresAt?`Expires: ${e.expiresAt.toDate().toLocaleDateString()}`:"",n=`\n        <html><head><title>Gift Card ${e.code}</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&family=Parisienne&display=swap" rel="stylesheet">\n        <style>\n            body{font-family:'Poppins',sans-serif;display:flex;align-items:center;justify-content:center;margin:0;padding:20px;background-color:#f0f0f0;}\n            .font-parisienne{font-family:'Parisienne',cursive;}\n            .card-container{display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;}\n            .card{width:400px;height:228px;text-shadow:1px 1px 3px rgba(0,0,0,0.6);box-shadow: 0 4px 8px rgba(0,0,0,0.2);-webkit-print-color-adjust: exact !important; color-adjust: exact !important;}\n            @media print { body { padding: 0; } .card-container { gap: 0; } }\n        </style></head><body>\n        <div class="card-container">\n            \x3c!-- Front of Card --\x3e\n            <div class="card rounded-lg p-4 flex flex-col justify-between bg-cover bg-center text-white" style="background-image: url('${e.backgroundUrl}');">\n                <div class="flex justify-between items-start"><img src="https://placehold.co/100x100/d63384/FFFFFF?text=NE" class="w-12 h-12 rounded-full border-2 border-white" /><div class="text-right"><p class="font-parisienne text-3xl">Gift Card</p><p class="text-xs font-semibold tracking-wider">Nails Express</p></div></div>\n                <div class="text-center"><p class="text-5xl font-bold">$${e.balance.toFixed(2)}</p></div>\n                <div class="text-xs"><div class="flex justify-between font-semibold"><span style="display:${e.recipientName?"inline":"none"}">FOR: <span class="font-normal">${e.recipientName}</span></span><span style="display:${e.senderName?"inline":"none"}">FROM: <span class="font-normal">${e.senderName}</span></span></div><p class="mt-2 text-center font-mono tracking-widest text-sm">${e.code}</p><p class="mt-1 text-center text-[10px] opacity-80" style="display:${t?"block":"none"}">${t}</p></div>\n            </div>\n            \x3c!-- Back of Card --\x3e\n            <div class="card rounded-lg p-4 flex flex-col justify-between bg-white text-gray-800" style="text-shadow: none;">\n                <div class="w-full h-10 bg-black mt-2"></div>\n                <p class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n                    This card is redeemable for services at Nails Express. Treat this card like cash; it is not replaceable if lost or stolen. This card is non-refundable and cannot be exchanged for cash.\n                </p>\n                <div class="text-center text-xs pb-2">\n                    <p class="font-bold">Nails Express</p>\n                    <p>1560 Hustonville Rd #345, Danville, KY 40422</p>\n                    <p>(859) 236-2873</p>\n                </div>\n            </div>\n        </div>\n        </body></html>\n    `,a=window.open("","_blank");a.document.write(n),a.document.close(),a.focus()},openMembershipCardForPrint=(e,t)=>{let n=(new Date).toLocaleDateString();e.membership.startDate&&"function"==typeof e.membership.startDate.toDate&&(n=e.membership.startDate.toDate().toLocaleDateString());const a=e.id?e.id.split("").map((e=>e.charCodeAt(0))).join("").substring(0,6):"N/A";let o="from-gray-700 via-gray-900 to-black";t.name.toLowerCase().includes("silver")&&(o="from-gray-400 via-gray-500 to-gray-600"),t.name.toLowerCase().includes("gold")&&(o="from-yellow-400 via-yellow-500 to-yellow-600"),t.name.toLowerCase().includes("platinum")&&(o="from-indigo-500 via-purple-600 to-pink-600");const i=`\n        <html><head><title>Membership Card - ${e.name}</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&family=Parisienne&display=swap" rel="stylesheet">\n        <style>\n            body{font-family:'Poppins',sans-serif;display:flex;align-items:center;justify-content:center;margin:0;padding:20px;background-color:#f0f0f0;}\n            .font-parisienne{font-family:'Parisienne',cursive;}\n            .card-container{display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;}\n            .card{width:400px;height:228px;text-shadow:1px 1px 3px rgba(0,0,0,0.6);box-shadow: 0 4px 8px rgba(0,0,0,0.2);-webkit-print-color-adjust: exact !important; color-adjust: exact !important;}\n            @media print { body { padding: 0; } .card-container { gap: 0; } }\n        </style></head><body>\n        <div class="card-container">\n            <div class="card rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br ${o} text-white">\n                <div class="flex justify-between items-start">\n                    <div class="font-bold text-lg"><p>${t.name}</p><p class="text-xs font-normal opacity-80">MEMBERSHIP</p></div>\n                    <p class="font-parisienne text-3xl">Nails Express</p>\n                </div>\n                <div class="flex justify-between items-end">\n                    <div class="text-left"><p class="text-xs opacity-80">MEMBER</p><p class="text-2xl font-semibold tracking-wider">${e.name}</p></div>\n                    <div class="text-right text-xs opacity-80">\n                        <p>Member Since: ${n}</p>\n                        <p>Member ID: ${a}</p>\n                    </div>\n                </div>\n            </div>\n            <div class="card rounded-lg p-4 flex flex-col justify-between bg-white text-gray-800" style="text-shadow: none;">\n                <div class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n                    <p>\n                        Welcome, VIP! This card must be presented to receive benefits. Membership is non-transferable.\n                    </p>\n                    <p class="font-bold mt-2">\n                        Clients must pay with cash only to earn credit towards their cash reward.\n                    </p>\n                </div>\n                \n                <div class="px-4 pb-2 text-center">\n                    <p class="font-parisienne text-2xl text-gray-700">${e.name}</p>\n                    <div class="w-full border-t border-dashed border-gray-400 pt-1 mt-1"></div>\n                    <p class="text-xs text-gray-500">Member Signature</p>\n                </div>\n\n                <div class="text-center text-xs pb-2">\n                    <p class="font-bold">Nails Express</p>\n                    <p>1560 Hustonville Rd #345, Danville, KY 40422</p>\n                </div>\n            </div>\n        </div>\n        </body></html>\n    `,s=window.open("","_blank");s.document.write(i),s.document.close(),s.focus()},isTechnicianAvailable=async(e,t,n)=>{try{const{getFunctions:a,httpsCallable:o}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js"),i=o(a(app),"checkAvailability");return(await i({technicianName:e,proposedStartTime:t.toISOString(),newServiceDuration:n})).data}catch(e){return console.error("Error calling checkAvailability function:",e),{available:!1,message:"Could not verify schedule. Please try again."}}};async function sendBookingNotificationEmail(e){try{const t=query(collection(db,"users"),where("role","==","admin")),n=(await getDocs(t)).docs.map((e=>e.data().email)).filter(Boolean);let a=null;if(e.technician&&"Any Technician"!==e.technician){const t=query(collection(db,"users"),where("name","==",e.technician)),n=await getDocs(t);if(!n.empty){const e=n.docs[0].data();e.email&&(a=e.email)}}const o=[...new Set([...n,a].filter(Boolean))];if(0===o.length)return void console.log("No recipients found for booking notification email.");const i=e.appointmentTimestamp.toDate().toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short"}),s=`New Booking: ${e.name} @ ${i}`,d=Array.isArray(e.services)?e.services.join(", "):e.services,r=`<div style="font-family: Arial, sans-serif; color: #333;"><h2 style="color: #d63384;">New Appointment Booked</h2><p>A new appointment has been scheduled for <strong>${e.name}</strong>.</p><table style="width: 100%; border-collapse: collapse; margin-top: 15px;"><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px; width: 120px;"><strong>Client:</strong></td><td style="padding: 8px;">${e.name}</td></tr><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Phone:</strong></td><td style="padding: 8px;">${e.phone||"N/A"}</td></tr><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Time:</strong></td><td style="padding: 8px;">${i}</td></tr><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Technician:</strong></td><td style="padding: 8px;">${e.technician}</td></tr><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Services:</strong></td><td style="padding: 8px;">${d}</td></tr><tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Notes:</strong></td><td style="padding: 8px;">${e.notes||"None"}</td></tr></table></div>`,l=o.map((e=>addDoc(collection(db,"mail"),{to:e,message:{subject:s,html:r}})));await Promise.all(l),console.log("Booking notification emails queued for:",o.join(", "))}catch(e){console.error("Error queuing booking notification email:",e)}}async function sendGiftCardConfirmationEmail(e){if(e.buyerEmail)try{const t=await getDoc(doc(db,"settings","emailTemplates"));if(!t.exists())return;const n=t.data();let a=n.giftCardSubject||"Your Gift Card Request from Nails Express",o=n.giftCardBody||"Thank you, {clientName}, for your gift card purchase of {amount}.";o=o.replace(/{clientName}/g,e.buyerName).replace(/{amount}/g,`$${(e.amount*e.quantity).toFixed(2)}`).replace(/{recipientName}/g,e.recipientName).replace(/{senderName}/g,e.senderName).replace(/\n/g,"<br>"),await addDoc(collection(db,"mail"),{to:e.buyerEmail,message:{subject:a,html:o}})}catch(e){console.error("Error sending gift card confirmation email:",e)}}async function sendMembershipConfirmationEmail(e){if(e.email)try{const t=await getDoc(doc(db,"settings","emailTemplates"));if(!t.exists())return;const n=t.data();let a=n.membershipSubject||"Welcome to the Nails Express VIP Membership!",o=n.membershipBody||"Hi {clientName}, thank you for joining our {tierName} membership. Your request is pending payment confirmation.";o=o.replace(/{clientName}/g,e.name).replace(/{tierName}/g,e.tierName).replace(/\n/g,"<br>"),await addDoc(collection(db,"mail"),{to:e.email,message:{subject:a,html:o}})}catch(e){console.error("Error sending membership confirmation email:",e)}}async function sendAppointmentReminderEmail(e,t){if(t)try{const n=await getDoc(doc(db,"settings","emailTemplates"));if(!n.exists())return;const a=n.data();let o=a.reminderSubject||"Your Upcoming Appointment at Nails Express",i=a.reminderBody||"Hi {clientName}, this is a reminder for your appointment on {appointmentDate} at {appointmentTime}. We look forward to seeing you!";const s=e.appointmentTimestamp.toDate(),d=new Date(s.getTime()-864e5);if(d<new Date)return void console.log("Skipping reminder for appointment in less than 24 hours.");i=i.replace(/{clientName}/g,e.name).replace(/{appointmentDate}/g,s.toLocaleDateString()).replace(/{appointmentTime}/g,s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})).replace(/{technician}/g,e.technician).replace(/{services}/g,Array.isArray(e.services)?e.services.join(", "):e.services).replace(/\n/g,"<br>"),await addDoc(collection(db,"mail"),{to:t,message:{subject:o,html:i},delivery:{startTime:Timestamp.fromDate(d)}}),console.log(`Reminder email scheduled for ${e.name}`)}catch(e){console.error("Error scheduling appointment reminder email:",e)}else console.log("No client email found for reminder for:",e.name)}function isBookingTimeValid(e){const t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;if(holidaySettings.dates.includes(t))return{valid:!1,message:holidaySettings.message||"The salon is closed on the selected date."};const n=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][e.getDay()],a=salonHours[n];if(!a||!a.isOpen)return{valid:!1,message:`Sorry, the salon is closed on ${n.charAt(0).toUpperCase()+n.slice(1)}s.`};const o=60*e.getHours()+e.getMinutes(),[i,s]=a.open.split(":").map(Number),d=60*i+s,[r,l]=a.close.split(":").map(Number);if(o<d||o>60*r+l){const e=e=>new Date(`1970-01-01T${e}`).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return{valid:!1,message:`Sorry, our hours on ${n.charAt(0).toUpperCase()+n.slice(1)}s are from ${e(a.open)} to ${e(a.close)}.`}}return{valid:!0}}const closePurchaseModal=()=>{const e=document.getElementById("gift-card-purchase-modal"),t=document.getElementById("gc-user-info-section");e.classList.add("hidden"),document.getElementById("gc-buyer-name").disabled=!1,document.getElementById("gc-buyer-phone").disabled=!1,document.getElementById("gc-buyer-email").disabled=!1,t&&t.classList.remove("hidden")},openPolicyModal=()=>{policyModal.classList.add("flex"),policyModal.classList.remove("hidden")},closePolicyModal=()=>{policyModal.classList.add("hidden"),policyModal.classList.remove("flex")};document.addEventListener("click",(e=>{e.target.closest(".view-policy-btn")&&(policyModal.classList.add("flex"),policyModal.classList.remove("hidden"))})),document.getElementById("policy-close-btn").addEventListener("click",closePolicyModal),document.querySelector("#policy-modal .policy-modal-overlay").addEventListener("click",closePolicyModal);const openAddAppointmentModal=(e,t=null,n=null)=>{addAppointmentForm.reset();const a=document.getElementById("add-appointment-modal-title"),o=document.getElementById("add-appointment-submit-btn"),i=document.getElementById("edit-appointment-id"),s=document.getElementById("appointment-client-name"),d=document.getElementById("appointment-phone"),r=document.getElementById("appointment-email"),l=document.getElementById("appointment-people"),c=document.getElementById("appointment-technician-select");l.innerHTML="";for(let e=1;e<=20;e++)l.appendChild(new Option(e,e));getDoc(doc(db,"public_data","technicians")).then((e=>{if(e.exists()){const t=e.data().names||[];c.innerHTML="<option>Any Technician</option>",t.forEach((e=>{c.appendChild(new Option(e,e))}))}}));if(document.getElementById("main-services-list").innerHTML=Object.keys(servicesData).flatMap((e=>servicesData[e].map((e=>`<option value="${e.p||""}${e.name}${e.price?" "+e.price:""}"></option>`)))).join(""),s.disabled=!1,d.disabled=!1,r.disabled=!1,n){a.textContent="Edit Appointment",o.textContent="Update Appointment",i.value=n.id;const e=n.appointmentTimestamp.toDate(),t=e.getFullYear(),m=String(e.getMonth()+1).padStart(2,"0"),u=String(e.getDate()).padStart(2,"0"),p=String(e.getHours()).padStart(2,"0"),g=String(e.getMinutes()).padStart(2,"0");document.getElementById("appointment-datetime").value=`${t}-${m}-${u}T${p}:${g}`,s.value=n.name||"",d.value=n.phone||"",r.value=n.email||"",l.value=n.people||1,document.getElementById("appointment-booking-type").value=n.bookingType||"Booked - Calendar",c.value=n.technician||"Any Technician",document.getElementById("appointment-notes").value=n.notes||"",document.getElementById("appointment-services").value=Array.isArray(n.services)?n.services.join(", "):n.services||""}else{a.textContent="Add New Appointment",o.textContent="Save Appointment",i.value="";const n=new Date,l=`${e}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;document.getElementById("appointment-datetime").value=l,t&&(s.value=t.name||"",d.value=t.phone||"",r.value=t.email||"",s.disabled=!0,d.disabled=!0,r.disabled=!0)}addAppointmentModal.classList.remove("hidden"),addAppointmentModal.classList.add("flex")},closeAddAppointmentModal=()=>{addAppointmentModal.classList.add("hidden"),addAppointmentModal.classList.remove("flex")};document.getElementById("add-appointment-cancel-btn").addEventListener("click",closeAddAppointmentModal),document.querySelector(".add-appointment-modal-overlay").addEventListener("click",closeAddAppointmentModal),document.getElementById("appointment-client-name").addEventListener("input",(e=>{const t=allFinishedClients.find((t=>t.name===e.target.value));t&&(document.getElementById("appointment-phone").value=t.phone,document.getElementById("appointment-email").value=t.email||"")})),document.getElementById("appointment-phone").addEventListener("input",(e=>{const t=allFinishedClients.find((t=>t.phone===e.target.value));t&&(document.getElementById("appointment-client-name").value=t.name,document.getElementById("appointment-email").value=t.email||"")}));const addAppointmentForm=document.getElementById("add-appointment-form");addAppointmentForm&&addAppointmentForm.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("add-appointment-submit-btn"),n=document.getElementById("waitlist-cta"),a=document.getElementById("waitlist-message");n&&n.classList.add("hidden"),t&&t.classList.remove("hidden"),pendingWaitlistData=null;const o=document.getElementById("appointment-datetime");if(!o||!o.value)return void addNotification("error","Please select a date and time.");const i=o.value;if(!i)return void addNotification("error","Invalid date/time selected.");const s=new Date(i),d=isBookingTimeValid(s);if(!d.valid)return void addNotification("error",d.message);const r=document.getElementById("appointment-technician-select"),l=document.getElementById("appointment-services");if(!r||!l)return void addNotification("error","Form elements missing. Cannot proceed.");const c=r.value;let m=0;const u=l.value.split(",").map((e=>e.split(" $")[0].trim())).filter((e=>e));if(0===u.length)m=bookingSettings.defaultDuration;else for(const e of u){const t=allServicesList.find((t=>t.name===e));m+=t?t.duration:bookingSettings.defaultDuration}t&&(t.disabled=!0,t.textContent="Checking..."),addNotification("info","Checking technician availability...");try{const e=await isTechnicianAvailable(c,s,m);if(!e.available){pendingWaitlistData={clientName:document.getElementById("appointment-client-name").value,clientPhone:document.getElementById("appointment-phone").value,services:u,technician:c,date:i.split("T")[0]};const o=e.message||"This slot is busy. A conflict was detected.";return a&&(a.textContent=o),n&&n.classList.remove("hidden"),t&&t.classList.add("hidden"),void addNotification("warning",o)}{const e={name:document.getElementById("appointment-client-name").value,phone:document.getElementById("appointment-phone").value,email:document.getElementById("appointment-email").value,people:document.getElementById("appointment-people").value,bookingType:document.getElementById("appointment-booking-type").value,services:u,technician:c,notes:document.getElementById("appointment-notes").value,appointmentTimestamp:Timestamp.fromDate(s)},t=document.getElementById("edit-appointment-id").value;if(t)await updateDoc(doc(db,"appointments",t),e),addNotification("success","Appointment updated successfully!");else{await addDoc(collection(db,"appointments"),e);await sendBookingNotificationEmail(e),e.email&&await sendAppointmentReminderEmail(e,e.email),addNotification("success","Appointment saved successfully!")}closeAddAppointmentModal()}}catch(e){console.error("Error during admin booking submission:",e),addNotification("error","Could not verify schedule due to a system error. Please try again."),n&&n.classList.add("hidden"),t&&t.classList.remove("hidden")}finally{t&&(t.disabled=!1,t.textContent=document.getElementById("edit-appointment-id").value?"Update Appointment":"Save Appointment")}})),purchaseForm.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("gc-amount"),n=document.getElementById("gc-quantity"),a=parseFloat(t.value),o=parseInt(n.value,10);if(isNaN(a)||a<=0||isNaN(o)||o<=0)return void addNotification("error","Please enter a valid amount and quantity (at least 1).");const i=document.getElementById("landing-gc-submit-btn");i.disabled=!0,i.textContent="Processing...";let s=globalLastUsedOnlineGcNumber;try{if(currentUserId&&auth.currentUser&&!auth.currentUser.isAnonymous){const e=writeBatch(db),t=new Date;t.setMonth(t.getMonth()+6);const n={name:document.getElementById("gc-buyer-name").value||auth.currentUser.displayName||"Unknown Buyer",email:document.getElementById("gc-buyer-email").value||auth.currentUser.email,phone:document.getElementById("gc-buyer-phone").value||"N/A"};for(let i=0;i<o;i++){s=Math.max(s+1,globalOnlineGcStartNumber);const o=String(s).padStart(4,"0"),i={amount:a,balance:a,history:[],recipientName:document.getElementById("gc-show-to").checked?document.getElementById("gc-to").value:n.name,senderName:document.getElementById("gc-show-from").checked?document.getElementById("gc-from").value:n.name,backgroundUrl:document.getElementById("landing-gc-preview-card").style.backgroundImage.slice(5,-2).replace(/"/g,""),code:o,status:"Pending",type:"E-Gift",createdBy:currentUserId,buyerInfo:n,createdAt:serverTimestamp(),expiresAt:Timestamp.fromDate(t)},d=doc(collection(db,"gift_cards"));e.set(d,i)}const i=doc(db,"settings","ecommerce");e.set(i,{lastUsedOnlineGcNumber:s},{merge:!0}),await e.commit(),addNotification("success","Success! Your gift card request sent. Activation pending payment confirmation."),closePurchaseModal()}else{const e=document.getElementById("gc-buyer-name").value,t=document.getElementById("gc-buyer-phone").value,n=document.getElementById("gc-buyer-email").value;if(!e||!t||!n)throw addNotification("error","Please fill out Name, Phone, and Email to create an account."),new Error("Missing buyer information for account creation.");const i=[];let s=globalLastUsedOnlineGcNumber;for(let e=0;e<o;e++)s=Math.max(s+1,globalOnlineGcStartNumber),i.push(String(s).padStart(4,"0"));const d=s,r={buyerName:e,buyerPhone:t,buyerEmail:n,amount:a,quantity:o,recipientName:document.getElementById("gc-show-to").checked?document.getElementById("gc-to").value:e,senderName:document.getElementById("gc-show-from").checked?document.getElementById("gc-from").value:e,backgroundUrl:document.getElementById("landing-gc-preview-card").style.backgroundImage.slice(5,-2).replace(/"/g,""),generatedCodes:i,finalLastNumber:d};sessionStorage.setItem("pendingGiftCardPurchase",JSON.stringify(r)),await createUserWithEmailAndPassword(auth,n,t),await sendGiftCardConfirmationEmail(r),closePurchaseModal()}}catch(e){console.error("Error during gift card purchase:",e),"auth/email-already-in-use"===e.code?addNotification("error","Account exists. Please log in to purchase."):addNotification("error",`Could not process request: ${e.message}`),auth.currentUser&&!auth.currentUser.isAnonymous||sessionStorage.removeItem("pendingGiftCardPurchase")}finally{i.disabled=!1,i.textContent="Submit Purchase Request";const e=document.getElementById("gc-buyer-name"),t=document.getElementById("gc-buyer-phone"),n=document.getElementById("gc-buyer-email");e&&(e.disabled=!1),t&&(t.disabled=!1),n&&(n.disabled=!1)}}));const renderMembershipTiers=(e,t,n)=>{const a=document.getElementById(t);a&&(a.innerHTML="",e.forEach((e=>{const t=e.benefits.split("\n").map((e=>`<li class="flex items-start"><span class="text-green-500 mr-2"></span><span>${e}</span></li>`)).join(""),o=n?"Select Plan":"Become a Member",i=document.createElement("div");i.className="border rounded-lg p-6 text-left flex flex-col hover:shadow-lg transition-shadow",i.innerHTML=`\n            <h3 class="text-2xl font-bold text-pink-700">${e.name}</h3>\n            <p class="text-4xl font-bold my-4">$${e.price}<span class="text-lg font-normal text-gray-500">/month</span></p>\n            <p class="text-sm text-gray-600 mb-4">${e.discount}% off all additional services.</p>\n            <ul class="space-y-2 text-gray-700 flex-grow">${t}</ul>\n            <button data-tier-id="${e.id}" class="purchase-membership-btn mt-6 w-full bg-pink-600 text-white font-bold py-3 rounded-lg hover:bg-pink-700">${o}</button>\n        `,a.appendChild(i)})))},initializeMembershipPurchaseForm=(e,t=null)=>{const n=document.getElementById("landing-membership-form"),a=document.getElementById("ms-tier-select"),o=document.getElementById("ms-amount"),i=document.getElementById("ms-preview-card");if(n.reset(),t)document.getElementById("ms-buyer-name").value=t.name,document.getElementById("ms-buyer-phone").value=t.phone||"",document.getElementById("ms-buyer-email").value=t.email,document.getElementById("membership-user-info-section").classList.add("hidden");else{const e=document.getElementById("membership-user-info-section");e&&e.classList.remove("hidden")}a.innerHTML="",allMembershipTiers.forEach((t=>{const n=t.id===e?"selected":"";a.innerHTML+=`<option value="${t.id}" ${n}>${t.name}</option>`}));const s=()=>{const e=a.value,t=allMembershipTiers.find((t=>t.id===e)),n=document.getElementById("ms-buyer-name").value||"";if(t){o.value=t.price.toFixed(2);let e="from-gray-700 via-gray-900 to-black";t.name.toLowerCase().includes("silver")&&(e="from-gray-400 via-gray-500 to-gray-600"),t.name.toLowerCase().includes("gold")&&(e="from-yellow-400 via-yellow-500 to-yellow-600"),t.name.toLowerCase().includes("platinum")&&(e="from-indigo-500 via-purple-600 to-pink-600"),i.className=`w-[350px] h-[200px] shadow-lg rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br ${e} text-white transition-all duration-300`,i.innerHTML=`\n                 <div class="flex justify-between items-start">\n        <div class="font-bold text-lg"><p>${t.name}</p><p class="text-xs font-normal opacity-80">MEMBERSHIP</p></div>\n        <p class="font-parisienne text-3xl">Nails Express</p>\n    </div>\n    <div class="flex justify-between items-end">\n        <div class="text-left"><p class="text-xs opacity-80">MEMBER</p><p class="text-2xl font-semibold tracking-wider">${n}</p></div>\n        <div class="text-right text-xs opacity-80">\n            <p>Member Since: ${(new Date).toLocaleDateString()}</p>\n            <p>Member ID: SAMPLE${Date.now().toString().slice(-4)}</p>\n        </div>\n    </div>\n            `}};a.addEventListener("change",s),document.getElementById("ms-buyer-name").addEventListener("input",s),s()},openMembershipPurchaseModal=(e,t=null)=>{initializeMembershipPurchaseForm(e,t),getDoc(doc(db,"settings","paymentGuide")).then((e=>{const t=document.getElementById("membership-payment-guide");e.exists()&&e.data().text?t.innerHTML=`<p class="font-semibold mb-2">How to Pay:</p><p>${e.data().text.replace(/\n/g,"<br>")}</p>`:t.textContent="Please contact the salon to complete your payment."})),document.getElementById("membership-purchase-modal").classList.remove("hidden")},closeMembershipPurchaseModal=()=>{document.getElementById("membership-purchase-modal").classList.add("hidden")},renderClientMembershipsTable=e=>{const t=document.querySelector("#client-memberships-table tbody");t&&(t.innerHTML="",e.forEach((e=>{const n=e.membership?.rewardHistory||[],a=n.filter((e=>"reward"===e.type)).reduce(((e,t)=>e+(t.rewardAmount||0)),0),o=n.filter((e=>"spending"===e.type)).reduce(((e,t)=>e+(t.amount||0)),0),i=t.insertRow(),s=e.membership.status||"Active",d="Active"===s?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800";let r=`\n            <button data-id="${e.id}" class="reward-tracking-btn text-green-500 hover:text-green-700" title="Manage Cash Reward">\n                <i class="fas fa-dollar-sign text-lg"></i>\n            </button>\n            <button data-id="${e.id}" class="print-membership-card-btn text-gray-500 hover:text-gray-700" title="View/Print Card">\n                <i class="fas fa-id-card text-lg"></i>\n            </button>\n            <button data-id="${e.id}" class="delete-membership-record-btn text-red-500">\n                <i class="fas fa-trash"></i>\n            </button>\n        `;"Pending"===s&&(r=`<button data-id="${e.id}" class="activate-membership-btn text-green-500 mr-2"><i class="fas fa-check-circle"></i></button>`+r);let l="Invalid Date";e.membership.startDate&&"function"==typeof e.membership.startDate.toDate&&(l=e.membership.startDate.toDate().toLocaleDateString());const c=e.id?e.id.split("").map((e=>e.charCodeAt(0))).join("").substring(0,6):"N/A";i.innerHTML=`\n            <td class="px-6 py-4">${e.name}</td>\n            <td class="px-6 py-4">${c}</td>\n            <td class="px-6 py-4">${e.membership.tierName}</td>\n            <td class="px-6 py-4 font-medium text-pink-600">$${o.toFixed(2)}</td>\n            <td class="px-6 py-4 font-medium text-green-600">$${a.toFixed(2)}</td>\n            <td class="px-6 py-4">${l}</td>\n            <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${d}">${s}</span></td>\n            <td class="px-6 py-4 text-center space-x-2">${r}</td>\n        `})))},renderClientMembership=(e,t)=>{const n=document.getElementById("client-membership-display");if(n)if(e.membership&&allMembershipTiers.length>0){const a=allMembershipTiers.find((t=>t.id===e.membership.tierId));if(a){let o=(new Date).toLocaleDateString();e.membership.startDate&&"function"==typeof e.membership.startDate.toDate&&(o=e.membership.startDate.toDate().toLocaleDateString());const i=t?t.split("").map((e=>e.charCodeAt(0))).join("").substring(0,6):"N/A",s=a.benefits.split("\n").map((e=>`<li class="flex items-start"><span class="text-green-500 mr-2"></span><span>${e}</span></li>`)).join(""),d=e.membership.status||"Active",r="Active"===d?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800";let l="from-gray-700 via-gray-900 to-black";a.name.toLowerCase().includes("silver")&&(l="from-gray-400 via-gray-500 to-gray-600"),a.name.toLowerCase().includes("gold")&&(l="from-yellow-400 via-yellow-500 to-yellow-600"),a.name.toLowerCase().includes("platinum")&&(l="from-indigo-500 via-purple-600 to-pink-600"),n.innerHTML=`\n                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">\n                    <div class="bg-white p-6 rounded-lg shadow-lg">\n                        <div class="flex justify-between items-start mb-4">\n                            <div>\n                                <h3 class="text-2xl font-bold text-pink-700 flex items-end gap-3">\n                                    <span>${a.name} Tier</span>\n                                    <span class="text-xl font-bold text-gray-600">$${a.price}/month</span>\n                                </h3>\n                                <p class="text-sm text-gray-500">Member since ${o}</p>\n                            </div>\n                            <span class="px-3 py-1 text-sm font-semibold rounded-full ${r}">${d}</span>\n                        </div>\n                        <div>\n                            <h4 class="font-semibold text-gray-800 mb-2">Your Benefits:</h4>\n                            <ul class="space-y-2 text-gray-700">${s}</ul>\n                        </div>\n                        ${"Pending"===d?'<p class="mt-4 text-center text-sm bg-yellow-100 text-yellow-800 p-3 rounded-lg">Your membership is pending approval. Please contact the salon to complete payment and activate your benefits.</p>':""}\n                    </div>\n                    <div class="space-y-3">\n                        <div class="w-full h-[228px] shadow-lg rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br ${l} text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.4);">\n                            <div class="flex justify-between items-start">\n                                <div class="font-bold text-lg"><p>${a.name}</p><p class="text-xs font-normal opacity-80">MEMBERSHIP</p></div>\n                                <p class="font-parisienne text-3xl">Nails Express</p>\n                            </div>\n                            <div class="text-center">\n                                <p class="font-bold text-lg">${a.discount}% off all additional services.</p>\n                            </div>\n                            <div class="flex justify-between items-end">\n                                <div class="text-left"><p class="text-xs opacity-80">MEMBER</p><p class="text-xl font-semibold tracking-wider">${e.name}</p></div>\n                                <div class="text-right text-xs opacity-80">\n                                    <p>Since: ${o}</p>\n                                    <p>ID: ${i}</p>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="flex justify-between items-center pt-2 px-2">\n                            <span class="text-sm text-gray-500">Your digital card</span>\n                            <div class="flex gap-4">\n                                <button data-client-id="${t}" class="download-membership-btn text-gray-500 hover:text-blue-600 text-xl" title="Download/Print"><i class="fas fa-download"></i></button>\n                                <button data-client-id="${t}" class="share-membership-btn text-gray-500 hover:text-pink-600 text-xl" title="Share"><i class="fas fa-share-alt"></i></button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `}else n.innerHTML='<p class="text-gray-500 text-center col-span-full">Your membership tier could not be found. Please contact the salon.</p>'}else n.innerHTML='\n            <div class="text-center p-8 bg-gray-50 rounded-lg">\n                <h3 class="text-xl font-semibold text-gray-700">You are not a member yet.</h3>\n                <p class="text-gray-500 mt-2 mb-4">Join our VIP program to enjoy exclusive discounts and benefits!</p>\n                <button class="join-membership-btn bg-pink-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-pink-700">Join Our Membership</button>\n            </div>\n        '};async function initClientDashboard(e,t){await getDocs(collection(db,"services")).then((e=>{servicesData={},e.forEach((e=>{servicesData[e.id]=e.data().items}))}));const n=await getDoc(doc(db,"settings","features")),a=n.exists()?n.data():{showGiftCards:!0,showMemberships:!0,showRoyaltyCard:!0};document.getElementById("client-welcome-name").textContent=`Welcome back, ${t.name}!`,document.getElementById("client-sign-out-btn").addEventListener("click",(()=>signOut(auth)));const o=document.getElementById("client-settings-name");o&&(o.value=t.name||"");renderClientMembership(t,e);const i=(e,t)=>{document.getElementById("client-total-visits").textContent=e.length,document.getElementById("client-last-visit").textContent=e.length>0?e[0].checkOutTimestamp.toDate().toLocaleDateString():"N/A";const n=t.filter((e=>e.appointmentTimestamp.toDate()>new Date)).sort(((e,t)=>e.appointmentTimestamp.seconds-t.appointmentTimestamp.seconds));document.getElementById("client-next-appt").textContent=n.length>0?n[0].appointmentTimestamp.toDate().toLocaleDateString():"None";const a={};let o=0;const i={};e.forEach((e=>{const t=e.checkOutTimestamp.toDate(),n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;let s=0;e.services.split(", ").map((e=>e.replace(/\s*\$\d+/,"").trim())).forEach((e=>{i[e]=(i[e]||0)+1;const t=allServicesList.find((t=>t.name===e))?.price||0;s+=t})),a[n]=(a[n]||0)+s,o+=s})),document.getElementById("client-total-spent").textContent=`$${o.toFixed(2)}`;const s=Object.keys(a).sort(),d=s.map((e=>new Date(e+"-02").toLocaleString("default",{month:"short",year:"2-digit"}))),r=s.map((e=>a[e])),l=document.getElementById("client-spending-chart")?.getContext("2d");if(l){clientSpendingChart=initializeChart(clientSpendingChart,l,"line",{labels:d,datasets:[{label:"Total Spent",data:r,backgroundColor:"rgba(219, 39, 119, 0.1)",borderColor:"rgba(219, 39, 119, 1)",borderWidth:2,tension:.2,fill:!0}]},{responsive:!0,maintainAspectRatio:!1})}const c=Object.entries(i).sort(((e,t)=>t[1]-e[1])).slice(0,5),m=c.map((e=>e[0])),u=c.map((e=>e[1])),p=document.getElementById("client-services-chart")?.getContext("2d");if(p){const e={labels:m,datasets:[{label:"Service Count",data:u,backgroundColor:colorPalette.map((e=>e.bg)),borderColor:colorPalette.map((e=>e.border)),borderWidth:1}]};clientServicesChart=initializeChart(clientServicesChart,p,"doughnut",e,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}}})}},s=document.getElementById("review-modal"),d=document.getElementById("review-form"),r=document.getElementById("star-rating-container");document.getElementById("client-appointment-history").addEventListener("click",(e=>{const t=e.target.closest(".leave-review-btn");t&&(d.reset(),r.querySelectorAll("i").forEach((e=>e.classList.remove("text-yellow-400"))),document.getElementById("review-finished-id").value=t.dataset.id,s.classList.remove("hidden"))})),document.getElementById("close-review-modal-btn").addEventListener("click",(()=>s.classList.add("hidden"))),r.addEventListener("click",(e=>{const t=e.target.closest(".fa-star");if(!t)return;const n=parseInt(t.dataset.value,10);document.getElementById("rating-value").value=n,r.querySelectorAll("i").forEach(((e,t)=>{e.classList.toggle("text-yellow-400",t<n)}))})),d.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("review-finished-id").value,n=parseInt(document.getElementById("rating-value").value,10),a=document.getElementById("review-text").value;if(t&&n)try{await updateDoc(doc(db,"finished_clients",t),{rating:n,review:a,isFeatured:!1}),s.classList.add("hidden"),alert("Thank you for your review!")}catch(e){console.error("Error submitting review:",e),alert("Could not submit your review.")}else alert("Please provide a star rating.")}));onSnapshot(query(collection(db,"appointments"),where("name","==",t.name)),(e=>{const t=e.docs.map((e=>({...e.data(),id:e.id})));(e=>{const t=document.getElementById("client-upcoming-appointments");t.innerHTML="";const n=e.filter((e=>e.appointmentTimestamp.toDate()>new Date));0!==n.length?n.forEach((e=>{const n=document.createElement("div");n.className="bg-white p-4 rounded-lg shadow",n.innerHTML=`<p class="font-bold">${new Date(1e3*e.appointmentTimestamp.seconds).toLocaleString()}</p><p>${e.services.join(", ")}</p><p class="text-sm text-gray-600">With: ${e.technician}</p>`,t.appendChild(n)})):t.innerHTML='<p class="text-gray-500">You have no upcoming appointments.</p>'})(t),allFinishedClients.length>0&&i(allFinishedClients,t)})),onSnapshot(query(collection(db,"finished_clients"),where("name","==",t.name)),(e=>{const n=e.docs.map((e=>{const t=e.data(),n=t.services,a=Array.isArray(n)?n.join(", "):n||"";return{id:e.id,...t,services:a}})).sort(((e,t)=>t.checkOutTimestamp.seconds-e.checkOutTimestamp.seconds));allFinishedClients=n,(e=>{const t=document.getElementById("client-appointment-history");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="bg-white p-4 rounded-lg shadow",n.innerHTML=`\n                <div class="flex justify-between items-start">\n                    <div>\n                        <p class="font-bold">${new Date(1e3*e.checkOutTimestamp.seconds).toLocaleDateString()}</p>\n                        <p>${e.services}</p>\n                        <p class="text-sm text-gray-600">With: ${e.technician}</p>\n                        ${e.colorCode?`<p class="text-sm text-gray-600">Color: ${e.colorCode}</p>`:""}\n                    </div>\n                    <div>\n                        ${e.rating?`<div class="text-yellow-400">${"".repeat(e.rating)}${"".repeat(5-e.rating)}</div>`:`<button data-id="${e.id}" class="leave-review-btn text-sm bg-pink-100 text-pink-700 font-semibold py-1 px-3 rounded-full hover:bg-pink-200">Leave Review</button>`}\n                    </div>\n                </div>\n            `,t.appendChild(n)})):t.innerHTML='<p class="text-gray-500">You have no past appointments.</p>')})(n),(e=>{if(0===e.length)return;const t=e.reduce(((e,t)=>(t.technician&&(e[t.technician]=(e[t.technician]||0)+1),e)),{}),n=e.reduce(((e,t)=>(t.colorCode&&(e[t.colorCode]=(e[t.colorCode]||0)+1),e)),{}),a=Object.keys(t).length>0?Object.keys(t).reduce(((e,n)=>t[e]>t[n]?e:n)):"N/A",o=Object.keys(n).length>0?Object.keys(n).reduce(((e,t)=>n[e]>n[t]?e:t)):"N/A";document.getElementById("favorite-technician").textContent=a,document.getElementById("favorite-color").textContent=o})(n);const a=allAppointments.filter((e=>e.name===t.name));i(n,a)}),(e=>{console.error("Error fetching client history:",e);const t=document.getElementById("client-appointment-history");t&&(t.innerHTML='<p class="text-red-500">Could not load appointment history due to a permission issue.</p>')}));let l=[];onSnapshot(query(collection(db,"gift_cards"),where("createdBy","==",e),orderBy("createdAt","desc")),(e=>{l=e.docs.map((e=>({...e.data(),id:e.id}))),(e=>{const t=document.getElementById("client-gift-cards-container");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="bg-white p-3 rounded-lg shadow-md space-y-3";const a=e.expiresAt?`Expires: ${e.expiresAt.toDate().toLocaleDateString()}`:"";n.innerHTML=`\n                <div class="w-full h-[200px] shadow-lg rounded-lg p-4 flex flex-col justify-between bg-cover bg-center text-white" style="background-image: url('${e.backgroundUrl}'); text-shadow: 1px 1px 3px rgba(0,0,0,0.6);"><div class="flex justify-between items-start"><img src="https://placehold.co/100x100/d63384/FFFFFF?text=NE" class="w-12 h-12 rounded-full border-2 border-white" /><div class="text-right"><p class="font-parisienne text-3xl">Gift Card</p><p class="text-xs font-semibold tracking-wider">Nails Express</p></div></div><div class="text-center"><p class="text-5xl font-bold">$${e.balance.toFixed(2)}</p></div><div class="text-xs"><div class="flex justify-between font-semibold"><span>FOR: <span class="font-normal">${e.recipientName}</span></span><span>FROM: <span class="font-normal">${e.senderName}</span></span></div><p class="mt-2 text-center font-mono tracking-widest text-sm">${e.code}</p><p class="mt-1 text-center text-[10px] opacity-80" style="display:${a?"block":"none"}">${a}</p></div></div><div class="flex justify-between items-center pt-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${"Active"===e.status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}">${e.status}</span><div class="flex gap-2"><button data-card-id="${e.id}" class="download-card-btn text-gray-500 hover:text-blue-600" title="Download/Print"><i class="fas fa-download"></i></button><button data-card-id="${e.id}" class="share-card-btn text-gray-500 hover:text-pink-600" title="Share"><i class="fas fa-share-alt"></i></button></div></div>\n            `,t.appendChild(n)})):t.innerHTML='<p class="text-gray-500 text-center col-span-full">You do not have any gift cards.</p>')})(l)})),document.getElementById("client-gift-cards-container").addEventListener("click",(e=>{const t=e.target.closest(".download-card-btn"),n=e.target.closest(".share-card-btn");if(t){const e=t.dataset.cardId,n=l.find((t=>t.id===e));n&&openCardForPrint(n)}if(n){const e=n.dataset.cardId,t=l.find((t=>t.id===e));t&&(navigator.share?navigator.share({title:"Nails Express Gift Card",text:`Check out this gift card for Nails Express! Code: ${t.code}`,url:window.location.href}).catch(console.error):alert("Sharing is not supported on this browser. Try the download button!"))}})),clientDashboardContent.addEventListener("click",(e=>{e.target.closest(".join-membership-btn")&&openMembershipPurchaseModal(null,t)})),document.getElementById("client-membership-display").addEventListener("click",(n=>{const a=n.target.closest(".download-membership-btn"),o=n.target.closest(".share-membership-btn");if(a){const n=allMembershipTiers.find((e=>e.id===t.membership.tierId));t&&n&&openMembershipCardForPrint({...t,id:e},n)}if(o){const e=allMembershipTiers.find((e=>e.id===t.membership.tierId));navigator.share&&t&&e?navigator.share({title:"Nails Express VIP Membership",text:`Check out my ${e.name} VIP Membership at Nails Express!`,url:window.location.href}).catch(console.error):alert("Sharing is not supported on this browser. Try the download button!")}})),document.getElementById("client-book-new-btn").addEventListener("click",(()=>{openAddAppointmentModal(getLocalDateString(),t)})),document.getElementById("client-buy-gift-card-btn").addEventListener("click",(()=>{(e=>{const n=document.getElementById("gift-card-purchase-modal"),a=document.getElementById("gc-user-info-section");initializeLandingGiftCardDesigner(),a&&a.classList.add("hidden"),document.getElementById("gc-buyer-name").value=e.name,document.getElementById("gc-buyer-name").readOnly=!0,document.getElementById("gc-buyer-phone").value=e.phone||"",document.getElementById("gc-buyer-phone").readOnly=!0,document.getElementById("gc-buyer-email").value=t.email,document.getElementById("gc-buyer-email").readOnly=!0,n.classList.remove("hidden")})(t)})),getDoc(doc(db,"settings","royaltyProgram")).then((e=>{e.exists()&&e.data().visitsNeeded&&(royaltySettings=e.data()),(e=>{const t=document.getElementById("royalty-card-content");if(!t)return;if(!e.royaltyCard)return void(t.innerHTML='\n                <div class="text-center p-8 bg-gray-50 rounded-lg">\n                    <h3 class="text-xl font-semibold text-gray-700">You haven\'t joined the Royalty Program yet.</h3>\n                    <p class="text-gray-500 mt-2 mb-4">Join for free to earn rewards with every visit!</p>\n                </div>');const n=e.royaltyCard.visits||0,a=royaltySettings.visitsNeeded,o=royaltySettings.rewardDescription;let i="";for(let e=1;e<=a;e++){const t=e<=n;i+=`<div class="stamp ${t?"stamped":""}">${t?'<i class="fas fa-star"></i>':e}</div>`}const s=n>=a?`Congrats! Your reward is ready: ${o}!`:a-n+" more visits until your reward!";t.innerHTML=`\n            <div class="royalty-card-container">\n                <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Your Royalty Card</h3>\n                <div class="royalty-card">\n                    <div class="royalty-card-header">\n                        <p class="font-parisienne text-3xl">Nails Express</p>\n                        <p class="text-xs font-semibold tracking-wider">ROYALTY PROGRAM</p>\n                    </div>\n                    <div class="stamp-grid">\n                        ${i}\n                    </div>\n                    <div class="royalty-card-footer">\n                        <p>${s}</p>\n                    </div>\n                </div>\n            </div>\n        `})(t)})),document.getElementById("client-settings-save-btn").addEventListener("click",(async()=>{const e=document.getElementById("client-settings-name").value.trim();if(!e)return void addNotification("error","Name cannot be empty.");const t=auth.currentUser;if(!t)return void addNotification("error","Authentication failed. Please log in again.");const n=t.uid;if(n)try{const t=doc(db,"clients",n);await updateDoc(t,{name:e,lastUpdated:serverTimestamp()}),document.getElementById("client-settings-name").value=e,addNotification("success","Name updated successfully!")}catch(e){console.error("Error updating client name:",e),addNotification("error","Failed to update name. Please check Firestore rules and try again.")}else addNotification("error","Client ID not found. Please log in again.")}));const c=document.getElementById("client-change-email-form");c&&c.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("client-new-email").value,n=auth.currentUser;if(!n)return;const a=prompt("For your security, please enter your current password to change your email.");if(a)try{const e=EmailAuthProvider.credential(n.email,a);await reauthenticateWithCredential(n,e),await updateEmail(n,t),await updateDoc(doc(db,"clients",n.uid),{email:t}),alert("Your email has been updated successfully!"),c.reset()}catch(e){console.error("Error updating email:",e),alert(`Could not update email. Error: ${e.message}`)}}));const m=document.getElementById("client-change-password-form");m&&m.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("client-current-password").value,n=document.getElementById("client-new-password").value,a=auth.currentUser;if(a)try{const e=EmailAuthProvider.credential(a.email,t);await reauthenticateWithCredential(a,e),await updatePassword(a,n),alert("Your password has been updated successfully!"),m.reset()}catch(e){console.error("Error updating password:",e),alert(`Could not update password. Error: ${e.message}`)}})),(e=>{const t=document.getElementById("client-top-nav"),n=document.querySelectorAll(".client-tab-content");let a=[{id:"client-overview",text:"Dashboard"},{id:"appointments",text:"Appointments"},{id:"favorites",text:"My Favorites"}];e.showGiftCards&&a.push({id:"gift-cards",text:"My Gift Cards"}),e.showMemberships&&a.push({id:"membership",text:"My Membership"}),e.showRoyaltyCard&&a.push({id:"royalty-card",text:"Royalty Card"}),a.push({id:"account-settings",text:"Account Settings"}),n.forEach((e=>e.classList.add("hidden"))),t.innerHTML=a.map((e=>`<button class="top-nav-btn" data-target="${e.id}-content">${e.text}</button>`)).join("");const o=t.querySelectorAll(".top-nav-btn");t.addEventListener("click",(e=>{const t=e.target.closest(".top-nav-btn");if(!t)return;o.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),n.forEach((e=>e.classList.add("hidden")));const a=t.dataset.target,i=document.getElementById(a);i&&i.classList.remove("hidden")})),o.length>0&&o[0].click()})(a)}async function initLandingPage(){const e=document.getElementById("shop-products-container"),t=document.getElementById("cart-button"),n=document.getElementById("cart-modal"),a=document.getElementById("close-cart-modal-btn"),o=document.getElementById("cart-items-container"),i=document.getElementById("cart-badge"),s=document.getElementById("cart-subtotal"),d=document.getElementById("cart-shipping-fee"),r=document.getElementById("cart-tax-rate"),l=document.getElementById("cart-tax"),c=document.getElementById("cart-grand-total"),m=document.getElementById("checkout-btn"),u=document.getElementById("order-confirmation-modal"),p=document.getElementById("close-confirmation-modal-btn"),g=()=>{const e=shoppingCart.reduce(((e,t)=>e+t.quantity),0);e>0?(i.textContent=e,i.classList.remove("hidden")):i.classList.add("hidden")},y=()=>{let e="",t=0,n=shoppingCart.reduce(((e,t)=>e+t.price*t.quantity),0);0===shoppingCart.length?(e='<p class="text-center text-gray-500 py-8">Your cart is empty.</p>',m.disabled=!0,m.classList.add("opacity-50","cursor-not-allowed")):(shoppingCart.forEach((n=>{e+=`\n                <div class="flex justify-between items-center py-3 border-b border-gray-100">\n                    <div class="flex items-center space-x-4 flex-grow">\n                        <span class="text-gray-800 font-medium">${n.name}</span>\n                    </div>\n                    \n                    <div class="flex items-center space-x-3 min-w-[150px]">\n                        \n                        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">\n                            <button onclick="updateCartQuantity('${n.id}', ${n.quantity-1})" \n                                class="p-2 text-pink-600 hover:bg-gray-100 disabled:opacity-50"\n                                ${n.quantity<=1?"disabled":""}>\n                                <i class="fas fa-minus text-xs"></i>\n                            </button>\n                            \n                            <input type="number" \n                                value="${n.quantity}" \n                                min="1" \n                                onchange="updateCartQuantity('${n.id}', parseInt(this.value))" \n                                class="w-10 text-center border-none focus:ring-0 p-0 text-sm"/>\n                            \n                            <button onclick="updateCartQuantity('${n.id}', ${n.quantity+1})" \n                                class="p-2 text-pink-600 hover:bg-gray-100">\n                                <i class="fas fa-plus text-xs"></i>\n                            </button>\n                        </div>\n                        <span class="text-gray-800 font-semibold w-[60px] text-right">$${(n.price*n.quantity).toFixed(2)}</span>\n                        \n                        <button onclick="removeFromCart('${n.id}')" \n                                class="text-red-500 hover:text-red-700 transition duration-150 p-1">\n                            <i class="fas fa-trash-alt text-sm"></i>\n                        </button>\n                    </div>\n                </div>\n            `,t+=n.quantity})),m.disabled=!1,m.classList.remove("opacity-50","cursor-not-allowed")),o.innerHTML=e,g();const a=shoppingCart.length>0?globalShippingFee:0,i=n*globalTaxRate,u=n+a+i;s.textContent=`$${n.toFixed(2)}`,d.textContent=`$${a.toFixed(2)}`,r.textContent=`${(100*globalTaxRate).toFixed(2)}%`,l.textContent=`$${i.toFixed(2)}`,c.textContent=`$${u.toFixed(2)}`},h=e=>{const t=allShopProducts.find((t=>t.id===e));if(!t)return;const n=shoppingCart.find((t=>t.id===e));n?n.quantity<t.stock?n.quantity++:alert("No more stock available for this item."):t.stock>0?shoppingCart.push({...t,quantity:1}):alert("This item is out of stock."),g(),y(),saveCartToLocalStorage()};window.updateCartQuantity=(e,t)=>{t=Math.max(1,parseInt(t));const n=shoppingCart.findIndex((t=>t.id===e));n>-1&&(shoppingCart[n].quantity=t,y(),saveCartToLocalStorage())},window.removeFromCart=e=>{const t=shoppingCart.findIndex((t=>t.id===e));t>-1&&(shoppingCart.splice(t,1),y(),saveCartToLocalStorage())},onSnapshot(collection(db,"products"),(t=>{allShopProducts=t.docs.map((e=>({id:e.id,...e.data()}))),e&&(e.innerHTML="",allShopProducts.forEach((t=>{const n=t.stock<=0,a=document.createElement("div");a.className="product-card bg-white rounded-lg shadow-md overflow-hidden relative "+(n?"out-of-stock":"");const o=t.imageURLs&&t.imageURLs[0]?t.imageURLs[0]:"https://placehold.co/300x300/f8bbd0/ffffff?text=Nail+Product";a.innerHTML=`\n    <img src="${o}" alt="${t.name}" class="w-full h-48 object-cover">\n    <div class="p-4">\n        <h3 class="font-bold text-lg truncate">${t.name}</h3>\n        <p class="text-sm text-gray-500 h-10 overflow-hidden">${t.description}</p>\n        <div class="flex justify-between items-center mt-4">\n            <span class="text-xl font-bold text-pink-600">$${t.price.toFixed(2)}</span>\n            <button data-id="${t.id}" class="add-to-cart-btn bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-pink-700 disabled:bg-gray-400" ${n?"disabled":""}>\n                <i class="fas fa-cart-plus mr-2"></i>Add\n            </button>\n        </div>\n    </div>\n    <div class="out-of-stock-overlay absolute inset-0 bg-white/70 flex items-center justify-center">\n        <span class="font-bold text-gray-500 bg-gray-200 px-4 py-2 rounded-full">Out of Stock</span>\n    </div>\n`,e.appendChild(a)})))})),t?.addEventListener("click",(()=>{getDoc(doc(db,"settings","paymentGuide")).then((e=>{const t=document.getElementById("cart-payment-guide");e.exists()&&e.data().text?(t.innerHTML=`<p class="font-semibold mb-1">How to Pay:</p><p>${e.data().text.replace(/\n/g,"<br>")}</p>`,t.classList.remove("hidden")):t.classList.add("hidden")})),n.classList.remove("hidden")})),a?.addEventListener("click",(()=>n.classList.add("hidden"))),n?.querySelector(".modal-overlay").addEventListener("click",(()=>n.classList.add("hidden"))),e?.addEventListener("click",(e=>{const t=e.target.closest(".add-to-cart-btn");t&&h(t.dataset.id)})),o?.addEventListener("click",(e=>{const t=e.target.closest("button");if(!t)return;const n=t.dataset.id,a=shoppingCart.findIndex((e=>e.id===n)),o=allShopProducts.find((e=>e.id===n));t.classList.contains("increase-qty")?shoppingCart[a].quantity<o.stock?shoppingCart[a].quantity++:alert("No more stock available for this item."):t.classList.contains("decrease-qty")?shoppingCart[a].quantity>1?shoppingCart[a].quantity--:shoppingCart.splice(a,1):t.classList.contains("remove-from-cart-btn")&&shoppingCart.splice(a,1),y(),g()})),document.getElementById("checkout-btn")?.addEventListener("click",(async()=>{let e=shoppingCart.reduce(((e,t)=>e+t.price*t.quantity),0);const t=shoppingCart.length>0?globalShippingFee:0,a=e*globalTaxRate,o=e+t+a,i={name:prompt("Please enter your full name:"),phone:prompt("Please enter your phone number:")};if(!i.name||!i.phone)return void alert("Name and phone number are required to place an order.");const s={customer:i,items:shoppingCart,total:o,subtotal:e,taxRate:globalTaxRate,taxAmount:a,shippingFee:t,status:"Pending",createdAt:serverTimestamp()};try{await addDoc(collection(db,"orders"),s),shoppingCart=[],y(),g(),n.classList.add("hidden"),u.classList.remove("hidden")}catch(e){console.error("Error placing order:",e),alert("Could not place your order. Please try again.")}})),p?.addEventListener("click",(()=>u.classList.add("hidden")));const f=document.getElementById("product-detail-modal"),b=document.getElementById("close-product-detail-modal-btn"),v=e=>{const t=allShopProducts.find((t=>t.id===e));if(!t)return;document.getElementById("product-modal-name").textContent=t.name,document.getElementById("product-modal-price").textContent=`$${t.price.toFixed(2)}`,document.getElementById("product-modal-description").textContent=t.description;const n=document.getElementById("product-modal-stock-status"),a=document.getElementById("product-modal-add-to-cart-btn");a.dataset.id=e,t.stock>0?(n.innerHTML=`<span class="text-green-600 font-semibold">In Stock (${t.stock} available)</span>`,a.disabled=!1):(n.innerHTML='<span class="text-red-600 font-semibold">Out of Stock</span>',a.disabled=!0),currentProductModalImageIndex=0;(()=>{const e=t.imageURLs||[],n=document.getElementById("product-modal-image"),a=document.getElementById("product-modal-prev-btn"),o=document.getElementById("product-modal-next-btn"),i=document.getElementById("product-modal-counter");if(e.length>0){n.src=e[currentProductModalImageIndex];const t=e.length>1;a.classList.toggle("hidden",!t||0===currentProductModalImageIndex),o.classList.toggle("hidden",!t||currentProductModalImageIndex===e.length-1),i.classList.toggle("hidden",!t),t&&(i.textContent=`${currentProductModalImageIndex+1} / ${e.length}`)}else n.src="https://placehold.co/400x400/f8bbd0/ffffff?text=No+Image",[a,o,i].forEach((e=>e.classList.add("hidden")))})(),f.classList.remove("hidden")};e?.addEventListener("click",(e=>{const t=e.target.closest(".product-card"),n=e.target.closest(".add-to-cart-btn");if(t&&!n){const e=t.querySelector(".add-to-cart-btn");e?.dataset.id&&v(e.dataset.id)}}));const x=()=>f.classList.add("hidden");b.addEventListener("click",x),f.addEventListener("click",(e=>{"product-detail-modal"===e.target.id&&x()})),document.getElementById("product-modal-add-to-cart-btn").addEventListener("click",(e=>{h(e.target.dataset.id),e.target.textContent="Added!",setTimeout((()=>{e.target.textContent="Add to Cart"}),1500)})),document.getElementById("product-modal-next-btn").addEventListener("click",(()=>{const e=document.getElementById("product-modal-add-to-cart-btn").dataset.id,t=allShopProducts.find((t=>t.id===e));t&&currentProductModalImageIndex<t.imageURLs.length-1&&(currentProductModalImageIndex++,v(e))})),document.getElementById("product-modal-prev-btn").addEventListener("click",(()=>{if(currentProductModalImageIndex>0){currentProductModalImageIndex--;const e=document.getElementById("product-modal-add-to-cart-btn").dataset.id;v(e)}})),onSnapshot(query(collection(db,"finished_clients"),where("isFeatured","==",!0)),(e=>{allFeaturedReviews=e.docs.map((e=>e.data()));const t=document.getElementById("testimonials-container");if(!t)return;t.innerHTML="";const n=allFeaturedReviews.filter((e=>e.rating&&e.review));0!==n.length?n.forEach((e=>{const n=document.createElement("div");n.className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500",n.innerHTML=`\n            <i class="fas fa-quote-left text-pink-300 text-2xl mb-3"></i>\n            ${renderStars(e.rating)}\n            <p class="text-gray-700 italic mb-4">"${e.review}"</p>\n            <div class="text-sm font-semibold text-gray-800">\n                ${e.name||"Anonymous Client"}\n            </div>\n            <p class="text-xs text-gray-500">${new Date(1e3*e.checkOutTimestamp.seconds).toLocaleDateString()}</p>\n        `,t.appendChild(n)})):t.innerHTML='<p class="text-gray-600 col-span-full text-center">No featured reviews yet. Check back soon!</p>'}));const E=document.getElementById("announcement-modal"),I=()=>E.classList.add("hidden");document.getElementById("close-announcement-modal-btn").addEventListener("click",I),document.getElementById("announcement-modal-overlay").addEventListener("click",I),(async()=>{if(!sessionStorage.getItem("announcementShown"))try{const e=await getDoc(doc(db,"settings","announcement"));if(e.exists()){const t=e.data();if(t.isEnabled){document.getElementById("announcement-title").textContent=t.title||"",document.getElementById("announcement-text").textContent=t.text||"";const e=document.getElementById("announcement-image");t.imageURL?(e.src=t.imageURL,e.classList.remove("hidden")):e.classList.add("hidden"),E.classList.remove("hidden"),sessionStorage.setItem("announcementShown","true")}}}catch(e){console.error("Error fetching announcement:",e)}})();const w=document.getElementById("royalty-card-modal"),B=document.getElementById("join-royalty-btn"),L=document.getElementById("close-royalty-card-modal-btn"),k=document.getElementById("royalty-card-form"),C=()=>w.classList.add("hidden");B.addEventListener("click",(()=>w.classList.remove("hidden"))),L.addEventListener("click",C),w.querySelector(".modal-overlay").addEventListener("click",C),k.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("rc-buyer-name").value,n=document.getElementById("rc-buyer-phone").value,a=document.getElementById("rc-buyer-email").value;if(t&&n&&a){sessionStorage.setItem("pendingRoyaltyCard",JSON.stringify({name:t,phone:n,email:a}));try{await createUserWithEmailAndPassword(auth,a,n),C()}catch(e){"auth/email-already-in-use"===e.code?alert("An account with this email already exists. Please log in to your dashboard to manage your royalty card."):alert(`Could not create account. Error: ${e.message}`),sessionStorage.removeItem("pendingRoyaltyCard")}}else alert("Please fill out all fields.")})),document.getElementById("nails-idea-landing").addEventListener("click",galleryClickHandler),onSnapshot(query(collection(db,"promotions"),orderBy("startDate","desc")),(e=>{allPromotions=e.docs.map((e=>({id:e.id,...e.data()}))),renderPromotionsLanding(allPromotions)})),onSnapshot(query(collection(db,"nail_ideas"),orderBy("createdAt","desc")),(e=>{allNailIdeas=e.docs.map((e=>({id:e.id,...e.data()}))),renderNailIdeasGallery(allNailIdeas)}));const $=document.getElementById("signup-login-modal"),D=document.getElementById("user-icon"),S=document.getElementById("close-signup-login-modal-btn"),T=document.getElementById("landing-login-form"),M=document.getElementById("landing-signup-form"),A=document.getElementById("add-appointment-form-landing"),N=document.getElementById("login-lockout-message");renderMembershipTiers(allMembershipTiers,"landing-memberships-container",!1);const F=document.getElementById("gift-card-purchase-modal"),R=document.getElementById("buy-gift-card-btn"),q=document.getElementById("close-gift-card-purchase-modal-btn"),P=document.getElementById("landing-gc-preview-card");document.getElementById("landing-memberships-container").addEventListener("click",(e=>{const t=e.target.closest(".purchase-membership-btn");t&&openMembershipPurchaseModal(t.dataset.tierId)})),y(),document.getElementById("close-membership-purchase-modal-btn").addEventListener("click",closeMembershipPurchaseModal),document.getElementById("membership-purchase-modal").querySelector(".modal-overlay").addEventListener("click",closeMembershipPurchaseModal);const H=()=>{const e=document.getElementById("gc-show-to").checked,t=document.getElementById("gc-show-from").checked;document.getElementById("gc-to-wrapper").style.display=e?"":"none",document.getElementById("gc-from-wrapper").style.display=t?"":"none",document.getElementById("landing-gc-preview-to").parentElement.style.display=e?"":"none",document.getElementById("landing-gc-preview-from").parentElement.style.display=t?"":"none",document.getElementById("landing-gc-preview-to").textContent=document.getElementById("gc-to").value||"Recipient",document.getElementById("landing-gc-preview-from").textContent=document.getElementById("gc-from").value||"Sender";const n=parseFloat(document.getElementById("gc-amount").value)||0,a=parseInt(document.getElementById("gc-quantity").value,10)||0;document.getElementById("landing-gc-preview-amount").textContent=`$${n.toFixed(2)}`,document.getElementById("landing-gc-total-amount").textContent=`$${(n*a).toFixed(2)}`;const o=new Date;o.setMonth(o.getMonth()+6);const i=o.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"});document.getElementById("landing-gc-preview-expiry").textContent=`Expires: ${i}`};R.addEventListener("click",(()=>{const e=document.getElementById("gc-user-info-section");e&&e.classList.remove("hidden"),getDoc(doc(db,"settings","paymentGuide")).then((e=>{e.exists()&&e.data().text?Y.innerHTML=`<p class="font-semibold mb-2">How to Pay:</p><p>${e.data().text.replace(/\n/g,"<br>")}</p>`:Y.textContent="Please contact the salon to complete your payment."})),(()=>{purchaseForm.reset(),document.getElementById("gc-quantity").value=1;const e=document.getElementById("landing-gc-background-tabs"),t=document.getElementById("landing-gc-background-options");e.innerHTML=Object.keys(giftCardBackgrounds).map((e=>`<button type="button" data-category="${e}" class="px-3 py-1 text-sm font-medium rounded-t-lg">${e}</button>`)).join("");const n=e.querySelector("button");n&&(n.classList.add("bg-gray-200","border-gray-300","border-b-0"),t.innerHTML=giftCardBackgrounds[n.dataset.category].map((e=>`<button type="button" data-bg="${e}" class="w-full h-16 bg-cover bg-center rounded-md border-2 border-transparent hover:border-pink-400" style="background-image: url('${e}')"></button>`)).join(""),P.style.backgroundImage=`url('${giftCardBackgrounds[n.dataset.category][0]}')`),H()})(),F.classList.remove("hidden")})),q.addEventListener("click",(()=>F.classList.add("hidden"))),F.querySelector(".modal-overlay").addEventListener("click",(()=>F.classList.add("hidden"))),purchaseForm.addEventListener("input",H),document.getElementById("landing-gc-background-tabs").addEventListener("click",(e=>{const t=e.target.closest("button");if(t){document.getElementById("landing-gc-background-tabs").querySelectorAll("button").forEach((e=>e.classList.remove("bg-gray-200","border-gray-300","border-b-0"))),t.classList.add("bg-gray-200","border-gray-300","border-b-0");document.getElementById("landing-gc-background-options").innerHTML=giftCardBackgrounds[t.dataset.category].map((e=>`<button type="button" data-bg="${e}" class="w-full h-16 bg-cover bg-center rounded-md border-2 border-transparent hover:border-pink-400" style="background-image: url('${e}')"></button>`)).join(""),P.style.backgroundImage=`url('${giftCardBackgrounds[t.dataset.category][0]}')`}})),document.getElementById("landing-gc-background-options").addEventListener("click",(e=>{const t=e.target.closest("button");t&&t.dataset.bg&&(document.getElementById("landing-gc-background-options").querySelectorAll("button").forEach((e=>e.classList.remove("ring-2","ring-pink-500"))),t.classList.add("ring-2","ring-pink-500"),P.style.backgroundImage=`url('${t.dataset.bg}')`)})),q.addEventListener("click",closePurchaseModal),F.querySelector(".modal-overlay").addEventListener("click",closePurchaseModal),getDoc(doc(db,"settings","security")).then((e=>{e.exists()&&(loginSecuritySettings=e.data())}));const j=()=>{$.classList.add("hidden"),$.classList.remove("flex")};D.addEventListener("click",(()=>{$.classList.remove("hidden"),$.classList.add("flex")})),S.addEventListener("click",j),$.querySelector(".modal-overlay").addEventListener("click",j);const U=document.getElementById("login-tab-btn"),O=document.getElementById("signup-tab-btn"),_=document.getElementById("login-form-container"),G=document.getElementById("signup-form-container");U.addEventListener("click",(()=>{U.classList.add("active"),O.classList.remove("active"),_.classList.remove("hidden"),G.classList.add("hidden")})),O.addEventListener("click",(()=>{O.classList.add("active"),U.classList.remove("active"),G.classList.remove("hidden"),_.classList.add("hidden")}));const Y=document.getElementById("landing-gc-payment-guide");getDoc(doc(db,"settings","paymentGuide")).then((e=>{e.exists()&&e.data().text?Y.innerHTML=`<p class="font-semibold mb-2">How to Pay:</p><p>${e.data().text.replace(/\n/g,"<br>")}</p>`:Y.textContent="Please contact the salon to complete your payment."})),T.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("landing-email").value,n=document.getElementById("landing-password").value,a=document.getElementById("landing-login-btn"),o=a.querySelector(".btn-text"),i=a.querySelector("i"),s="loginAttempts_"+t.toLowerCase(),d="lockoutUntil_"+t.toLowerCase(),r=localStorage.getItem(d);if(r&&Date.now()<parseInt(r)){const e=Math.ceil((parseInt(r)-Date.now())/6e4);return N.textContent=`Too many failed attempts. Please try again in ${e} minutes.`,void N.classList.remove("hidden")}r&&localStorage.removeItem(d),N.classList.add("hidden"),o.textContent="Logging In...",i.classList.remove("hidden"),a.disabled=!0;try{await signInWithEmailAndPassword(auth,t,n),localStorage.removeItem(s),localStorage.removeItem(d),j()}catch(e){let t=(parseInt(localStorage.getItem(s))||0)+1;if(t>=loginSecuritySettings.maxAttempts){const e=Date.now()+60*loginSecuritySettings.lockoutMinutes*1e3;localStorage.setItem(d,e),localStorage.removeItem(s),N.textContent=`Login disabled for ${loginSecuritySettings.lockoutMinutes} minutes due to too many failed attempts.`,N.classList.remove("hidden")}else localStorage.setItem(s,t),alert(`Login Failed: ${e.message}. You have ${loginSecuritySettings.maxAttempts-t} attempts remaining.`)}finally{o.textContent="Log In",i.classList.add("hidden"),a.disabled=!1}})),M.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("signup-name").value,n=document.getElementById("signup-email").value,a=document.getElementById("signup-password").value,o=document.getElementById("landing-signup-btn"),i=o.querySelector(".btn-text"),s=o.querySelector("i");i.textContent="Signing Up...",s.classList.remove("hidden"),o.disabled=!0;try{const e={name:t,email:n,phone:a};sessionStorage.setItem("signupDetails",JSON.stringify(e)),await createUserWithEmailAndPassword(auth,n,a),j()}catch(e){alert(`Sign Up Failed: ${e.message}`),sessionStorage.removeItem("signupDetails")}finally{i.textContent="Sign Up",s.classList.add("hidden"),o.disabled=!1}}));const W=document.getElementById("appointment-people-landing");for(let e=1;e<=20;e++)W.appendChild(new Option(e,e));const V=document.getElementById("appointment-technician-select-landing");getDoc(doc(db,"public_data","technicians")).then((e=>{if(e.exists()){const t=e.data().names||[];V.innerHTML="<option>Any Technician</option>",t.forEach((e=>{V.appendChild(new Option(e,e))}))}}));const X=document.getElementById("booking-step-1"),z=document.getElementById("booking-step-2");document.getElementById("booking-next-btn").addEventListener("click",(()=>{X.classList.add("hidden"),z.classList.remove("hidden"),document.getElementById("waitlist-cta-landing").classList.add("hidden");const e=document.querySelector('#add-appointment-form-landing button[type="submit"]'),t=document.getElementById("booking-prev-btn");e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden")})),document.getElementById("booking-prev-btn").addEventListener("click",(()=>{z.classList.add("hidden"),X.classList.remove("hidden"),document.getElementById("waitlist-cta-landing").classList.add("hidden");const e=document.querySelector('#add-appointment-form-landing button[type="submit"]'),t=document.getElementById("booking-prev-btn");e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden")}));const J=document.getElementById("services-container-landing"),Z=document.getElementById("hidden-checkbox-container-landing");let K={};getDocs(collection(db,"services")).then((e=>{servicesData={},K={},e.forEach((e=>{servicesData[e.id]=e.data().items,K[e.id]=e.data().items})),J.innerHTML="",Z.innerHTML="",Object.keys(K).forEach((e=>{const t=document.createElement("button");t.type="button",t.className="category-button p-4 border border-gray-200 rounded-lg text-left bg-white hover:border-pink-300 hover:bg-pink-50 transition-all duration-200 shadow-sm",t.dataset.category=e,t.innerHTML=`<h3 class="text-lg font-bold text-pink-700">${e}</h3><span class="text-sm text-gray-500 mt-1 block">Click to select</span><span class="selection-count hidden mt-2 bg-pink-600 text-white text-xs font-bold px-2 py-1 rounded-full"></span>`,J.appendChild(t),K[e].forEach((t=>{const n=`${t.p||""}${t.name}${t.price?" "+t.price:""}`,a=document.createElement("input");a.type="checkbox",a.name="service-landing",a.value=n,a.dataset.category=e,Z.appendChild(a)}))}))}));const Q=document.getElementById("landing-booking-service-modal"),ee=document.getElementById("landing-booking-service-modal-content");J.addEventListener("click",(e=>{const t=e.target.closest(".category-button");if(t){const e=t.dataset.category;document.getElementById("landing-booking-modal-title").textContent=e,ee.innerHTML="",K[e].forEach((e=>{const t=`${e.p||""}${e.name}${e.price?" "+e.price:""}`,n=Z.querySelector(`input[value="${t}"]`),a=document.createElement("label");a.className="flex items-center p-3 hover:bg-pink-50 cursor-pointer rounded-lg",a.innerHTML=`<input type="checkbox" class="form-checkbox modal-checkbox-landing" value="${t}" ${n&&n.checked?"checked":""}><span class="ml-3 text-gray-700 flex-grow">${e.name}</span>${e.price?`<span class="font-semibold">${e.price}</span>`:""}`,ee.appendChild(a)})),Q.classList.remove("hidden"),Q.classList.add("flex")}})),document.getElementById("landing-booking-service-modal-done-btn").addEventListener("click",(()=>{ee.querySelectorAll(".modal-checkbox-landing").forEach((e=>{const t=Z.querySelector(`input[value="${e.value}"]`);t&&(t.checked=e.checked)})),Q.classList.add("hidden"),Q.classList.remove("flex"),document.querySelectorAll("#services-container-landing .category-button").forEach((e=>{const t=e.dataset.category,n=Z.querySelectorAll(`input[data-category="${t}"]:checked`).length,a=e.querySelector(".selection-count");n>0?(a.textContent=`${n} selected`,a.classList.remove("hidden")):a.classList.add("hidden")}))}));const te=document.getElementById("join-waitlist-btn-landing");te&&te.addEventListener("click",(async()=>{const e=document.getElementById("appointment-client-name-landing").value,t=document.getElementById("appointment-phone-landing").value,n=Array.from(document.querySelectorAll('#hidden-checkbox-container-landing input[name="service-landing"]:checked')).map((e=>e.value)),a=document.getElementById("appointment-technician-select-landing").value,o=document.getElementById("appointment-datetime-landing").value;if(!e||!t||0===n.length||!o)return void addNotification("error","Please ensure Name, Phone, Date/Time, and Services are filled to join the waitlist.");const i={clientName:e,clientPhone:t,services:n,technician:a,date:o.split("T")[0],createdAt:serverTimestamp(),status:"active"},s=te;s.disabled=!0,s.textContent="Adding...";try{await addDoc(collection(db,"waitlist"),i),addNotification("success","Success! You've been added to the waitlist. We will contact you if a spot opens up."),A.reset(),document.getElementById("waitlist-cta-landing").classList.add("hidden");const e=document.querySelector('#add-appointment-form-landing button[type="submit"]'),t=document.getElementById("booking-prev-btn");e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden"),document.querySelectorAll("#services-container-landing .selection-count").forEach((e=>e.classList.add("hidden"))),document.querySelectorAll("#hidden-checkbox-container-landing input").forEach((e=>e.checked=!1)),document.getElementById("booking-step-2").classList.add("hidden"),document.getElementById("booking-step-1").classList.remove("hidden")}catch(e){console.error("Error adding to waitlist from landing page:",e),addNotification("error","Could not add to waitlist. Please try again.")}finally{s.disabled=!1,s.textContent="Join Waitlist"}})),A.addEventListener("submit",(async e=>{e.preventDefault();const t=Array.from(document.querySelectorAll('#hidden-checkbox-container-landing input[name="service-landing"]:checked')).map((e=>e.value)),n=document.getElementById("appointment-datetime-landing").value,a=document.getElementById("appointment-technician-select-landing").value,o=document.querySelector('#add-appointment-form-landing button[type="submit"]'),i=document.getElementById("booking-prev-btn"),s=document.getElementById("waitlist-cta-landing"),d=document.getElementById("waitlist-message-landing");if(!n)return void addNotification("error","Please select a date and time.");if(0===t.length)return addNotification("error","Please select at least one service."),s.classList.add("hidden"),o&&o.classList.remove("hidden"),void(i&&i.classList.remove("hidden"));const r=new Date(n),l=isBookingTimeValid(r);if(!l.valid)return addNotification("error",l.message),s.classList.add("hidden"),o&&o.classList.remove("hidden"),void(i&&i.classList.remove("hidden"));let c=allServicesList,m=bookingSettings;if(!c||0===c.length){addNotification("info","Loading service data, please wait...");try{const[e,t]=await Promise.all([getDocs(collection(db,"services")),getDoc(doc(db,"settings","booking"))]);if(m=t.exists()?t.data():{defaultDuration:40},bookingSettings=m,c=[],e.forEach((e=>{(e.data().items||[]).forEach((e=>{if(e.name&&e.price){const t=parseFloat(String(e.price).replace(/[^0-9.]/g,""));isNaN(t)||c.push({name:e.name,duration:e.duration||m.defaultDuration,price:t})}}))})),allServicesList=c,0===c.length)return void addNotification("error","No services configured. Cannot proceed with booking.")}catch(e){return console.error("Failed to fetch services on submit:",e),void addNotification("error","Failed to load service data. Please refresh and try again.")}}let u=0;for(const e of t){const t=e.split(" $")[0].trim(),n=c.find((e=>e.name===t));u+=n?n.duration:m.defaultDuration}o&&(o.disabled=!0),i&&(i.disabled=!0),addNotification("info","Checking technician availability...");try{console.log("Checking availability for:",{technician:a,bookingDate:r,totalDuration:u});const e=await isTechnicianAvailable(a,r,u);if(console.log("Availability check result:",e),!e.available)return d.textContent=e.message||"This time slot is unavailable.",s.classList.remove("hidden"),o&&o.classList.add("hidden"),i&&i.classList.add("hidden"),void addNotification("error","That time slot is unavailable. Join the waitlist?");{s.classList.add("hidden"),o&&o.classList.remove("hidden"),i&&i.classList.remove("hidden");const e={name:document.getElementById("appointment-client-name-landing").value,phone:document.getElementById("appointment-phone-landing").value,email:document.getElementById("appointment-email-landing").value,people:document.getElementById("appointment-people-landing").value,technician:a,appointmentTimestamp:Timestamp.fromDate(r),notes:document.getElementById("appointment-notes-landing").value,services:t,bookingType:"Online"};await addDoc(collection(db,"appointments"),e),await sendBookingNotificationEmail(e),e.email&&await sendAppointmentReminderEmail(e,e.email),addNotification("success","Appointment booked successfully!"),A.reset(),document.querySelectorAll("#services-container-landing .selection-count").forEach((e=>e.classList.add("hidden"))),document.querySelectorAll("#hidden-checkbox-container-landing input").forEach((e=>e.checked=!1)),document.getElementById("booking-step-2").classList.add("hidden"),document.getElementById("booking-step-1").classList.remove("hidden")}}catch(e){console.error("Error booking appointment or checking availability:",e),addNotification("error","Could not complete booking. Please try again."),s.classList.add("hidden"),o&&o.classList.remove("hidden"),i&&i.classList.remove("hidden")}finally{o&&(o.disabled=!1),i&&(i.disabled=!1)}}));const ne=e=>{const t=!1!==e.showShop,n=!1!==e.showClientLogin,a=!1!==e.showPromotions,o=!1!==e.showGiftCards,i=!1!==e.showNailArt,s=!1!==e.showMemberships,d=!1!==e.showRoyaltyCard,r=document.getElementById("signup-tab-btn").parentElement;r&&(r.style.display=n?"block":"none");const l=document.getElementById("shop-landing"),c=document.getElementById("cart-button"),m=document.querySelector('a[href="#shop-landing"]');l&&(l.style.display=t?"":"none"),c&&(c.style.display=t?"":"none"),m&&(m.style.display=t?"":"none"),document.getElementById("promotions-landing").style.display=a?"":"none",document.querySelector(".nav-item-promotions").style.display=a?"":"none",document.getElementById("gift-card-landing").style.display=o?"":"none",document.querySelector(".nav-item-gift-card").style.display=o?"":"none",document.getElementById("nails-idea-landing").style.display=i?"":"none",document.querySelector(".nav-item-nails-idea").style.display=i?"":"none";const u=document.getElementById("memberships-landing"),p=document.querySelector('a[href="#memberships-landing"]');u&&(u.style.display=s?"":"none"),p&&(p.style.display=s?"":"none");const g=document.getElementById("royalty-card-landing"),y=document.querySelector('a[href="#royalty-card-landing"]');g&&(g.style.display=d?"":"none"),y&&(y.style.display=d?"":"none")};onSnapshot(doc(db,"settings","features"),(e=>{e.exists()?ne(e.data()):ne({showClientLogin:!0,showPromotions:!0,showGiftCards:!0,showNailArt:!0,showMemberships:!0,showRoyaltyCard:!0})}))}async function initMainApp(e,t){const n=()=>{const e=document.getElementById("ecomm-add-product-form"),t=document.querySelector("#products-admin-table tbody"),n=document.querySelector("#orders-admin-table tbody");onSnapshot(query(collection(db,"products"),orderBy("name")),(e=>{at=e.docs.map((e=>({id:e.id,...e.data()}))),t&&(t.innerHTML="",at.forEach((e=>{t.insertRow().innerHTML=`\n                    <td class="px-4 py-2"><img src="${e.imageURLs&&e.imageURLs[0]||"https://placehold.co/64x64/f8bbd0/ffffff?text=Nail+Product"}" class="w-12 h-12 object-cover rounded"></td>\n                    <td class="px-4 py-2 font-medium">${e.name}</td>\n                    <td class="px-4 py-2">$${e.price.toFixed(2)}</td>\n                    <td class="px-4 py-2">${e.stock}</td>\n                    <td class="px-4 py-2 text-center">\n                        <button data-id="${e.id}" class="ecomm-edit-product-btn text-blue-500 mr-2"><i class="fas fa-edit"></i></button>\n                        <button data-id="${e.id}" class="ecomm-delete-product-btn text-red-500"><i class="fas fa-trash"></i></button>\n                    </td>\n                `})))})),onSnapshot(query(collection(db,"orders"),orderBy("createdAt","desc")),(e=>{ot=e.docs.map((e=>({id:e.id,...e.data()}))),n&&(n.innerHTML="",ot.forEach((e=>{const t=n.insertRow(),a=e.items.map((e=>`${e.quantity}x ${e.name}`)).join("<br>");t.innerHTML=`\n                    <td class="px-4 py-2">${e.createdAt.toDate().toLocaleDateString()}</td>\n                    <td class="px-4 py-2">${e.customer.name}<br><span class="text-xs text-gray-500">${e.customer.phone}</span></td>\n                    <td class="px-4 py-2 text-xs">${a}</td>\n                    <td class="px-4 py-2 font-bold">$${e.total.toFixed(2)}</td>\n                    <td class="px-4 py-2">${e.status}</td>\n                    <td class="px-4 py-2 text-center">\n                        <select data-id="${e.id}" class="order-status-select form-select text-sm p-1">\n                            <option value="Pending" ${"Pending"===e.status?"selected":""}>Pending</option>\n                            <option value="Shipped" ${"Shipped"===e.status?"selected":""}>Shipped</option>\n                            <option value="Completed" ${"Completed"===e.status?"selected":""}>Completed</option>\n                            <option value="Cancelled" ${"Cancelled"===e.status?"selected":""}>Cancelled</option>\n                        </select>\n                    </td>\n                `})))})),e?.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("ecomm-edit-product-id").value,n=document.getElementById("ecomm-product-image-urls").value.split("\n").map((e=>e.trim())).filter(Boolean),o={name:document.getElementById("ecomm-product-name").value,description:document.getElementById("ecomm-product-desc").value,price:parseFloat(document.getElementById("ecomm-product-price").value),stock:parseInt(document.getElementById("ecomm-product-stock").value,10),imageURLs:n};try{t?await updateDoc(doc(db,"products",t),o):await addDoc(collection(db,"products"),o),a()}catch(e){console.error("Error saving product",e)}}));const a=()=>{e.reset(),document.getElementById("ecomm-edit-product-id").value="",document.getElementById("ecomm-current-image-info").textContent="",document.getElementById("ecomm-current-image-info").dataset.url="",document.getElementById("ecomm-add-product-btn").textContent="Add Product",document.getElementById("ecomm-cancel-edit-btn").classList.add("hidden")};document.getElementById("ecomm-cancel-edit-btn")?.addEventListener("click",a),t?.addEventListener("click",(e=>{const t=e.target.closest(".ecomm-edit-product-btn"),n=e.target.closest(".ecomm-delete-product-btn");if(t){const e=at.find((e=>e.id===t.dataset.id));document.getElementById("ecomm-edit-product-id").value=e.id,document.getElementById("ecomm-product-name").value=e.name,document.getElementById("ecomm-product-desc").value=e.description,document.getElementById("ecomm-product-price").value=e.price,document.getElementById("ecomm-product-stock").value=e.stock;const n=document.getElementById("ecomm-product-image-urls");e.imageURLs&&Array.isArray(e.imageURLs)?n.value=e.imageURLs.join("\n"):n.value="",document.getElementById("ecomm-add-product-btn").textContent="Update Product",document.getElementById("ecomm-cancel-edit-btn").classList.remove("hidden")}else n&&mt("Delete this product?",(async()=>{await deleteDoc(doc(db,"products",n.dataset.id))}))})),n?.addEventListener("change",(async e=>{if(e.target.classList.contains("order-status-select")){const t=e.target.dataset.id,n=e.target.value;await updateDoc(doc(db,"orders",t),{status:n})}}))},a=document.getElementById("birthday-rewards-form");a&&a.addEventListener("submit",(async e=>{e.preventDefault();const t={enabled:document.getElementById("toggle-birthday-rewards").checked,subject:document.getElementById("birthday-email-subject").value,body:document.getElementById("birthday-email-body").value};try{await setDoc(doc(db,"settings","birthday_rewards"),t),alert("Birthday reward settings saved successfully!")}catch(e){console.error("Error saving birthday settings:",e),alert("Could not save birthday settings.")}}));const o=(e,t,n)=>{const a=document.getElementById(e),o=document.getElementById(t);a.innerHTML='<option value="daily">Daily</option>',["January","February","March","April","May","June","July","August","September","October","November","December"].forEach(((e,t)=>{a.innerHTML+=`<option value="${t}">${e}</option>`})),a.innerHTML+='<option value="this-year">This Year</option><option value="last-year">Last Year</option>',a.addEventListener("change",(e=>{const t=e.target.value;o.style.display="daily"===t?"block":"none",n(o.value,t)})),o.addEventListener("input",(e=>{n(e.target.value,a.value)}))},i=document.getElementById("mobile-menu-btn"),s=document.getElementById("mobile-sidebar"),d=document.getElementById("mobile-sidebar-close-btn"),r=document.getElementById("mobile-sidebar-overlay"),l=document.getElementById("mobile-nav-links"),c=document.getElementById("top-nav"),m=()=>{s.classList.remove("translate-x-full"),r.classList.remove("hidden")},u=()=>{s.classList.add("translate-x-full"),r.classList.add("hidden")};let p='\n        <button class="top-nav-btn relative" data-target="check-in">\n            Check-in\n            <span id="check-in-nav-count" class="absolute -top-1 -right-1 bg-pink-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>\n        </button>\n        <button class="top-nav-btn relative" data-target="booking">\n            Booking\n            <span id="booking-nav-count" class="absolute -top-1 -right-1 bg-blue-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>\n        </button>\n        \n            <button class="top-nav-btn" data-target="report">Report</button>\n    ';"admin"===e&&(p+='\n\n            <button class="top-nav-btn" data-target="nails-idea">Nails Inspo</button>\n            <button class="top-nav-btn" data-target="color-chart">Color Chart</button>\n            <button class="top-nav-btn" data-target="setting">Setting</button>\n        '),c.innerHTML=p,l.innerHTML=p;l.insertAdjacentHTML("beforeend",'\n        <button id="mobile-logout-btn" class="top-nav-btn mt-4 w-full text-left bg-pink-100 text-pink-700">\n            <i class="fas fa-sign-out-alt mr-2"></i>Logout\n        </button>\n    '),i&&i.addEventListener("click",m),d&&d.addEventListener("click",u),r&&r.addEventListener("click",u),l&&l.addEventListener("click",(e=>{if(e.target.closest(".top-nav-btn")){const t=e.target.closest(".top-nav-btn").dataset.target,n=c.querySelector(`[data-target="${t}"]`);n&&n.click(),u()}}));const g=document.getElementById("mobile-logout-btn");g&&g.addEventListener("click",(()=>{signOut(auth),u()}));const y=document.getElementById("app-subtitle");y&&(y.textContent=`Welcome, ${t}!`);const h=document.getElementById("dashboard-content"),f=document.getElementById("main-app-container"),b=document.getElementById("logo-link"),v=document.getElementById("top-nav"),x=document.querySelectorAll(".main-section"),E=document.getElementById("notification-bell"),I=document.getElementById("notification-count"),w=document.getElementById("notification-dropdown"),B=document.getElementById("check-in-nav-count"),L=document.getElementById("booking-nav-count"),k=document.getElementById("waitlist-count"),C=Timestamp.now(),$=document.getElementById("admin-dashboard-view"),D=document.getElementById("staff-dashboard-view");if("admin"===e)$.classList.remove("hidden"),D.classList.add("hidden"),(()=>{const e=document.getElementById("announcement-form");let t={};onSnapshot(doc(db,"settings","announcement"),(e=>{if(e.exists()){t=e.data(),document.getElementById("toggle-announcement").checked=t.isEnabled||!1,document.getElementById("announcement-form-title").value=t.title||"",document.getElementById("announcement-form-text").value=t.text||"";const n=document.getElementById("current-announcement-image-wrapper"),a=document.getElementById("current-announcement-image");t.imageURL?(a.src=t.imageURL,n.classList.remove("hidden")):n.classList.add("hidden")}})),e.addEventListener("submit",(async n=>{n.preventDefault();const a=document.getElementById("announcement-form-image").files[0];let o=t.imageURL||null;const i=e.querySelector('button[type="submit"]');i.disabled=!0,i.textContent="Saving...";try{if(a){if(t.imageURL)try{const e=ref(storage,t.imageURL);await deleteObject(e)}catch(e){console.warn("Could not delete old image, it may already be gone:",e)}const e=ref(storage,`announcements/${Date.now()}_${a.name}`);await uploadBytes(e,a),o=await getDownloadURL(e)}const e={isEnabled:document.getElementById("toggle-announcement").checked,title:document.getElementById("announcement-form-title").value,text:document.getElementById("announcement-form-text").value,imageURL:o};await setDoc(doc(db,"settings","announcement"),e),alert("Announcement saved successfully!")}catch(e){console.error("Error saving announcement:",e),alert("Could not save the announcement.")}finally{i.disabled=!1,i.textContent="Save Announcement",document.getElementById("announcement-form-image").value=""}})),document.getElementById("remove-announcement-image-btn").addEventListener("click",(async()=>{if(t.imageURL&&confirm("Are you sure you want to remove the current image?"))try{const e=ref(storage,t.imageURL);await deleteObject(e),await updateDoc(doc(db,"settings","announcement"),{imageURL:null}),alert("Image removed.")}catch(e){console.error("Error removing image:",e),alert("Could not remove the image.")}}))})();else{$.classList.add("hidden"),D.classList.remove("hidden");const e=document.getElementById("staff-welcome-heading");e&&(e.textContent="My Earning Details")}onSnapshot(query(collection(db,"waitlist"),orderBy("createdAt","desc")),(e=>{allWaitlistEntries=e.docs.map((e=>({id:e.id,...e.data()})));const t=allWaitlistEntries.filter((e=>"contacted"!==e.status));k&&(t.length>0?(k.textContent=t.length,k.classList.remove("hidden")):k.classList.add("hidden")),S()}));const S=()=>{const e=document.querySelector("#waitlist-table tbody");if(!e)return;const t=document.getElementById("waitlist-date-filter").value;let n=allWaitlistEntries;t&&(n=allWaitlistEntries.filter((e=>e.date===t))),e.innerHTML="",0!==n.length?n.forEach((t=>{const n=e.insertRow();n.className="bg-white border-b",n.innerHTML=`\n        <td class="px-6 py-4">${new Date(t.date+"T00:00:00").toLocaleDateString()}</td>\n        <td class="px-6 py-4 font-medium">${t.clientName}</td>\n        <td class="px-6 py-4">${t.clientPhone}</td>\n        <td class="px-6 py-4 text-xs">${Array.isArray(t.services)?t.services.join(", "):t.services}</td>\n        <td class="px-6 py-4">${t.technician}</td>\n        <td class="px-6 py-4 text-center space-x-4">\n            <button data-id="${t.id}" class="check-in-waitlist-btn text-green-500 hover:text-green-700" title="Check In Client"><i class="fas fa-sign-in-alt text-lg"></i></button>\n            <button data-id="${t.id}" class="check-out-waitlist-btn text-blue-500 hover:text-blue-700" title="Check Out Client"><i class="fas fa-check-circle text-lg"></i></button>\n            <button data-id="${t.id}" class="remove-waitlist-btn text-red-500 hover:text-red-700" title="Remove from Waitlist"><i class="fas fa-trash text-lg"></i></button>\n        </td>\n    `})):e.innerHTML='<tr><td colspan="6" class="py-6 text-center text-gray-400">No clients on the waitlist for the selected date.</td></tr>'};document.getElementById("waitlist-date-filter").addEventListener("input",S),document.querySelector("#waitlist-table tbody")?.addEventListener("click",(async e=>{const t=e.target.closest(".remove-waitlist-btn"),n=e.target.closest(".check-in-waitlist-btn"),a=e.target.closest(".check-out-waitlist-btn");if(t&&mt("Remove this client from the waitlist?",(async()=>{await deleteDoc(doc(db,"waitlist",t.dataset.id))})),n){const e=n.dataset.id,t=allWaitlistEntries.find((t=>t.id===e));if(!t)return;try{await addDoc(collection(db,"active_queue"),{name:t.clientName,phone:t.clientPhone,people:t.people||1,bookingType:"Waitlist",services:t.services,technician:t.technician,notes:t.notes||"",checkInTimestamp:serverTimestamp(),status:"waiting"}),await deleteDoc(doc(db,"waitlist",e)),A("success",`${t.clientName} has been checked in from the waitlist.`)}catch(e){console.error("Error checking in from waitlist:",e),A("error","Could not check in the client.")}}if(a){const e=a.dataset.id,t=allWaitlistEntries.find((t=>t.id===e));if(!t)return;document.getElementById("technician-name-select").value=t.technician,document.getElementById("checkout-client-id").value=e,document.getElementById("checkout-source-collection").value="waitlist",Y.classList.remove("hidden"),Y.classList.add("flex")}}));document.getElementById("join-waitlist-btn").addEventListener("click",(async()=>{if(!pendingWaitlistData)return void alert("Error: Waitlist data not found. Please try again.");const e={...pendingWaitlistData,createdAt:serverTimestamp(),status:"active"};if(e.clientName&&e.clientPhone)try{await addDoc(collection(db,"waitlist"),e),alert("Success! You have been added to the waitlist. We will contact you if a spot opens up."),addAppointmentModal.classList.add("hidden"),addAppointmentModal.classList.remove("flex"),document.getElementById("waitlist-cta").classList.add("hidden"),document.getElementById("add-appointment-submit-btn").classList.remove("hidden"),pendingWaitlistData=null}catch(e){console.error("Error adding to waitlist:",e),alert("Could not add to waitlist. Please try again.")}finally{pendingWaitlistData=null}else alert("Please enter a name and phone number to join the waitlist.")}));const T=()=>{const e=allActiveClients.length;B&&(e>0?(B.textContent=e,B.classList.remove("hidden")):B.classList.add("hidden"));const t=allAppointments.filter((e=>e.appointmentTimestamp.toDate()>new Date)).length;L&&(t>0?(L.textContent=t,L.classList.remove("hidden")):L.classList.add("hidden"))},M=()=>{const e=notifications.filter((e=>!e.read)).length;I.textContent=e,I.style.display=e>0?"block":"none",w.innerHTML=0===notifications.length?'<div class="p-4 text-center text-sm text-gray-500">No new notifications</div>':"",notifications.forEach((e=>{const t=document.createElement("div");t.className="notification-item "+(e.read?"":"font-bold bg-pink-50"),t.innerHTML=`<p class="text-gray-800">${e.message}</p><p class="text-xs text-gray-400 mt-1">${e.timestamp.toLocaleString()}</p>`,w.appendChild(t)}))},A=(e,t,n=null)=>{const a={id:Date.now()+Math.random(),type:e,message:t,timestamp:new Date,read:!1,itemId:n};notifications.unshift(a),M();const o=E.querySelector("i");o.classList.remove("ring-animation"),o.offsetWidth,o.classList.add("ring-animation")};h.classList.remove("hidden"),f.classList.add("hidden"),b.addEventListener("click",(()=>{h.classList.remove("hidden"),f.classList.add("hidden"),v.querySelectorAll(".top-nav-btn").forEach((e=>e.classList.remove("active")))}));const N=()=>{const e=document.getElementById("holiday-calendar-grid"),t=document.getElementById("holiday-month-year");if(!e||!t)return;t.textContent=new Date(holidayCalYear,holidayCalMonth).toLocaleString("default",{month:"long",year:"numeric"}),e.innerHTML="<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>";const n=new Date(holidayCalYear,holidayCalMonth,1).getDay(),a=new Date(holidayCalYear,holidayCalMonth+1,0).getDate();for(let t=0;t<n;t++)e.insertAdjacentHTML("beforeend","<div></div>");for(let t=1;t<=a;t++){const n=`${holidayCalYear}-${String(holidayCalMonth+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`,a=holidaySettings.dates.includes(n),o=(new Date).toDateString()===new Date(holidayCalYear,holidayCalMonth,t).toDateString(),i=document.createElement("div");i.textContent=t,i.dataset.date=n,i.className=`day-cell ${a?"is-holiday":""} ${o?"is-today":""}`,e.appendChild(i)}},F=()=>{const e=document.getElementById("holiday-list-admin");if(!e)return;const t=holidaySettings.dates.filter((e=>new Date(e)>=(new Date).setHours(0,0,0,0))).sort();t.length>0?e.innerHTML=t.map((e=>`<div>${new Date(e+"T00:00:00").toLocaleDateString([],{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>`)).join(""):e.innerHTML='<p class="text-gray-500">No upcoming closures scheduled.</p>'};v.addEventListener("click",(e=>{const t=e.target.closest(".top-nav-btn");t&&(e=>{document.querySelectorAll("#top-nav .top-nav-btn, #mobile-nav-links .top-nav-btn").forEach((e=>{e.classList.remove("active")}));const t=c.querySelector(`[data-target="${e}"]`);t&&t.classList.add("active");const a=l.querySelector(`[data-target="${e}"]`);switch(a&&a.classList.add("active"),h.classList.add("hidden"),f.classList.remove("hidden"),x.forEach((e=>e.classList.add("hidden"))),e){case"check-in":document.getElementById("check-in-section").classList.remove("hidden"),document.getElementById("check-in-tab").click();break;case"booking":document.getElementById("calendar-content").classList.remove("hidden");break;case"nails-idea":document.getElementById("nails-idea-content").classList.remove("hidden");break;case"color-chart":document.getElementById("color-chart-content").classList.remove("hidden"),va();break;case"report":document.getElementById("reports-content").classList.remove("hidden"),document.getElementById("salon-earning-report-tab").click();break;case"setting":document.getElementById("admin-content").classList.remove("hidden"),document.getElementById("user-management-tab").click(),"admin"===currentUserRole&&(Za(),n())}})(t.dataset.target)})),E.addEventListener("click",(()=>{w.classList.toggle("hidden"),w.classList.contains("hidden")||(notifications.forEach((e=>e.read=!0)),setTimeout(M,300))}));const R=document.getElementById("check-in-form"),q=document.getElementById("people-count"),P=document.getElementById("services-container"),H=document.getElementById("hidden-checkbox-container"),j=document.getElementById("service-modal"),U=(document.getElementById("share-modal"),document.getElementById("modal-title")),O=document.getElementById("modal-content"),_=document.getElementById("modal-done-btn"),G=document.querySelector("#service-modal .modal-overlay"),Y=document.getElementById("checkout-modal"),W=document.getElementById("checkout-form"),V=document.getElementById("view-detail-modal"),X=document.getElementById("edit-earning-modal"),z=document.getElementById("edit-earning-form"),J=document.getElementById("edit-salon-earning-modal"),Z=document.getElementById("edit-salon-earning-form"),K=document.getElementById("client-form-modal"),Q=document.getElementById("client-form"),ee=document.getElementById("gemini-sms-modal"),te=document.getElementById("confirm-modal"),ne=document.getElementById("confirm-modal-message"),ae=document.getElementById("confirm-confirm-btn"),oe=document.getElementById("confirm-cancel-btn"),ie=document.getElementById("log-usage-modal"),se=document.getElementById("log-usage-form"),de=document.getElementById("email-templates-form");de&&(getDoc(doc(db,"settings","emailTemplates")).then((e=>{if(e.exists()){const t=e.data();document.getElementById("gift-card-subject").value=t.giftCardSubject||"",document.getElementById("gift-card-body").value=t.giftCardBody||"",document.getElementById("membership-subject").value=t.membershipSubject||"",document.getElementById("membership-body").value=t.membershipBody||"",document.getElementById("reminder-subject").value=t.reminderSubject||"",document.getElementById("reminder-body").value=t.reminderBody||""}})),de.addEventListener("submit",(async e=>{e.preventDefault();const t={giftCardSubject:document.getElementById("gift-card-subject").value,giftCardBody:document.getElementById("gift-card-body").value,membershipSubject:document.getElementById("membership-subject").value,membershipBody:document.getElementById("membership-body").value,reminderSubject:document.getElementById("reminder-subject").value,reminderBody:document.getElementById("reminder-body").value};try{await setDoc(doc(db,"settings","emailTemplates"),t),alert("Email templates saved successfully!")}catch(e){console.error("Error saving email templates:",e),alert("Could not save email templates.")}})));const re=document.getElementById("membership-reward-settings-form");if(re){const e=document.getElementById("membership-reward-threshold"),t=document.getElementById("membership-reward-type"),n=document.getElementById("membership-reward-value");onSnapshot(doc(db,"settings","membershipReward"),(a=>{if(a.exists()){const o=a.data();membershipRewardSettings=o,e.value=o.threshold||"",t.value=o.type||"fixed",n.value=o.value||""}})),re.addEventListener("submit",(async a=>{a.preventDefault();const o=parseFloat(e.value),i=t.value,s=parseFloat(n.value);if(isNaN(o)||isNaN(s))A("error","Please enter valid numbers for threshold and reward.");else try{const e={threshold:o,type:i,value:s};await setDoc(doc(db,"settings","membershipReward"),e),membershipRewardSettings=e,A("success","Membership reward settings saved!")}catch(e){console.error("Error saving reward settings:",e),A("error","Could not save settings.")}}))}document.addEventListener("click",(e=>{const t=e.target.closest(".view-profile-btn");if(t){const e=t.getAttribute("data-client-name");if(!e||"null"===e)return;const n=We.find((t=>t.name===e));if(n)Ot(n);else{const n={id:null,name:e,phone:t.getAttribute("data-client-phone")||"",email:t.getAttribute("data-client-email")||"",membership:null,notes:[]};Ot(n)}}}));const le=document.getElementById("close-client-profile-modal-btn");le&&le.addEventListener("click",(()=>{ye.classList.add("hidden")}));const ce=document.getElementById("save-new-client-note-btn");ce&&ce.addEventListener("click",(async()=>{const e=document.getElementById("note-client-id").value,t=document.getElementById("new-client-note-text").value,n=document.getElementById("profile-client-name").textContent;if(t)try{let a;if(e&&"null"!==e)a=doc(db,"clients",e),await updateDoc(a,{notes:arrayUnion({text:t,timestamp:Timestamp.now()})});else{const e={name:n,phone:document.getElementById("profile-client-phone").textContent,email:document.getElementById("profile-client-email").textContent,dob:"",createdAt:serverTimestamp(),notes:[{text:t,timestamp:Timestamp.now()}]},a=await addDoc(collection(db,"clients"),e);document.getElementById("note-client-id").value=a.id}A("success","Note saved successfully!"),document.getElementById("new-client-note-text").value="";const o=We.find((e=>e.name===n))||{id:e,name:n};Ot(o)}catch(e){console.error("Error saving note:",e),A("error","Failed to save note.")}else A("warning","Note text cannot be empty.")})),document.addEventListener("click",(async e=>{const t=e.target.closest(".delete-note-btn");if(t){const e=t.dataset.clientId,n=parseInt(t.dataset.noteTime);if(!e)return void A("error","Cannot delete note: Client ID is missing.");if(window.confirm("Are you sure you want to permanently delete this note?"))try{const t=doc(db,"clients",e),a=await getDoc(t);if(a.exists()){const e=(a.data().notes||[]).find((e=>e.timestamp&&e.timestamp.seconds===n));if(e){await updateDoc(t,{notes:arrayRemove(e)}),A("success","Note successfully deleted.");const n=document.getElementById("profile-client-name").textContent,a=We.find((e=>e.name===n));a?Ot(a):ye.classList.add("hidden")}else A("error","Error: Could not find matching note object in database.")}else A("error","Client document not found.")}catch(e){console.error("Error deleting note:",e),A("error","Failed to delete note due to a database error.")}}}));const me=document.getElementById("royalty-settings-form");if(me){getDoc(doc(db,"settings","royaltyProgram")).then((e=>{if(e.exists()&&e.data().visitsNeeded){const t=e.data();document.getElementById("royalty-visits-needed").value=t.visitsNeeded,document.getElementById("royalty-reward-description").value=t.rewardDescription,royaltySettings=t}})),me.addEventListener("submit",(async e=>{e.preventDefault();const t=parseInt(document.getElementById("royalty-visits-needed").value,10),n=document.getElementById("royalty-reward-description").value;if(isNaN(t)||t<1)return void alert("Please enter a valid number of visits.");const a={visitsNeeded:t,rewardDescription:n};try{await setDoc(doc(db,"settings","royaltyProgram"),a),royaltySettings=a,alert("Royalty program settings saved successfully!"),pe()}catch(e){console.error("Error saving royalty settings:",e),alert("Could not save settings.")}}));const t=document.querySelector("#royalty-cards-table tbody"),n=document.getElementById("search-royalty-cards"),a=document.getElementById("add-royalty-card-modal"),o=document.getElementById("add-royalty-card-btn"),i=document.getElementById("close-add-royalty-card-modal-btn"),s=document.getElementById("add-royalty-card-form"),d=document.getElementById("add-rc-client-list"),r=()=>{d.innerHTML="";allClients.filter((e=>!e.royaltyCard)).forEach((e=>{d.innerHTML+=`<option value="${e.name}"></option>`})),a.classList.remove("hidden")},l=()=>{s.reset(),a.classList.add("hidden")};o.addEventListener("click",r),i.addEventListener("click",l),a.querySelector(".modal-overlay").addEventListener("click",l),s.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("add-rc-client-name").value,n=allClients.find((e=>e.name===t));if(n)if(n.royaltyCard)alert(`${n.name} already has a royalty card.`);else try{const e=doc(db,"clients",n.id);await updateDoc(e,{royaltyCard:{visits:0,lastVisit:null}}),alert(`Royalty card created for ${n.name}!`),l()}catch(e){console.error("Error adding royalty card:",e),alert("Could not create royalty card for this client.")}else alert("Please select a valid client from the list.")}));const c=()=>{if(!t)return;const e=n.value.toLowerCase(),a=allRoyaltyCards.filter((t=>t.name.toLowerCase().includes(e)||t.phone&&t.phone.toLowerCase().includes(e)));t.innerHTML="",0!==a.length?a.forEach((e=>{const n=e.royaltyCard.visits||0,a=royaltySettings.visitsNeeded,o=n>=a,i=o?"Reward Ready":`${n} / ${a}`,s=o?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800";t.insertRow().innerHTML=`\n            <td class="px-6 py-4 font-medium"><span data-client-name="${e.name}" \n                          class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span></td>\n            <td class="px-6 py-4">${e.phone||"N/A"}</td>\n            <td class="px-6 py-4 text-center font-bold">${n}</td>\n            <td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${s}">${i}</span></td>\n            <td class="px-6 py-4 text-center space-x-2">\n                <button data-id="${e.id}" class="stamp-royalty-card-btn text-green-500 hover:text-green-700" title="Add Visit Stamp"><i class="fas fa-stamp"></i></button>\n                <button data-id="${e.id}" class="reset-royalty-card-btn text-yellow-500 hover:text-yellow-700" title="Reset Visits (After Reward)"><i class="fas fa-undo"></i></button>\n                <button data-id="${e.id}" class="delete-royalty-card-btn text-red-500 hover:text-red-700" title="Remove Royalty Card"><i class="fas fa-trash"></i></button>\n            </td>\n        `})):t.innerHTML='<tr><td colspan="5" class="py-6 text-center text-gray-400">No royalty card clients found.</td></tr>'};onSnapshot(query(collection(db,"clients"),where("royaltyCard","!=",null)),(e=>{allRoyaltyCards=e.docs.map((e=>({id:e.id,...e.data()}))),c()})),n.addEventListener("input",c),t.addEventListener("click",(async e=>{const t=e.target.closest(".stamp-royalty-card-btn"),n=e.target.closest(".reset-royalty-card-btn"),a=e.target.closest(".delete-royalty-card-btn"),o=(t||n||a)?.dataset.id;if(!o)return;const i=doc(db,"clients",o);if(t){const e=allRoyaltyCards.find((e=>e.id===o)).royaltyCard.visits||0;await updateDoc(i,{"royaltyCard.visits":e+1,"royaltyCard.lastVisit":serverTimestamp()})}else n?mt("Are you sure you want to reset this card's visits to 0? This is usually done after a client redeems their reward.",(async()=>{await updateDoc(i,{"royaltyCard.visits":0})}),"Reset Card"):a&&mt("Are you sure you want to remove the royalty card from this client? Their visit history will be lost.",(async()=>{await updateDoc(i,{royaltyCard:null})}),"Remove Card")}));const m=document.getElementById("backup-data-btn"),u=document.getElementById("restore-data-input"),p=document.getElementById("auto-backup-frequency"),g=document.getElementById("last-backup-status"),y=["users","clients","appointments","finished_clients","earnings","salon_earnings","expenses","inventory","promotions","services","nail_ideas","gift_cards","memberships","suppliers","color_brands","expense_categories","payment_accounts"],h=e=>{if(e instanceof Timestamp)return{__fsTimestamp:!0,value:e.toDate().toISOString()};if(Array.isArray(e))return e.map(h);if(null!==e&&"object"==typeof e){const t={};for(const n in e)t[n]=h(e[n]);return t}return e},f=e=>{if(e&&e.__fsTimestamp)return Timestamp.fromDate(new Date(e.value));if(Array.isArray(e))return e.map(f);if(null!==e&&"object"==typeof e){const t={};for(const n in e)t[n]=f(e[n]);return t}return e},b=async()=>{alert("Starting backup process. This may take a moment. Your download will begin automatically."),m.disabled=!0,m.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Backing up...';const e={};try{for(const t of y){const n=await getDocs(collection(db,t));e[t]=n.docs.map((e=>({id:e.id,...h(e.data())})))}const t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`nailexpress_backup_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a);const i=Timestamp.now();await setDoc(doc(db,"settings","backup"),{...backupSettings,lastBackup:i},{merge:!0})}catch(e){console.error("Backup failed:",e),alert("Backup failed. Please check the console for details.")}finally{m.disabled=!1,m.innerHTML='<i class="fas fa-download mr-2"></i> Backup All Data'}},v=e=>{const t=e.target.files[0];if(!t)return;if("RESTORE"!==prompt('This is a highly destructive action that will overwrite ALL existing data. To confirm, please type "RESTORE" in the box below.'))return alert("Restore cancelled."),void(u.value="");const n=new FileReader;n.onload=async e=>{try{const t=JSON.parse(e.target.result);alert("Restore process starting. The app will be unresponsive until it is complete. You will be alerted upon completion.");for(const e in t)if(t.hasOwnProperty(e)){const n=t[e],a=writeBatch(db);for(const t of n){const{id:n,...o}=t,i=f(o),s=doc(db,e,n);a.set(s,i)}await a.commit()}alert("Data restore completed successfully! The page will now reload."),window.location.reload()}catch(e){console.error("Restore failed:",e),alert("Restore failed. The backup file may be corrupt. Please check the console for details.")}finally{u.value=""}},n.readAsText(t)},x=()=>{if("off"===backupSettings.frequency||!backupSettings.lastBackup)return;const e=backupSettings.lastBackup.toDate();let t=(new Date-e)/864e5,n=!1;("daily"===backupSettings.frequency&&t>=1||"weekly"===backupSettings.frequency&&t>=7||"monthly"===backupSettings.frequency&&t>=30)&&(n=!0),n&&confirm("It's time for your scheduled backup. Do you want to download the backup file now?")&&b()};m.addEventListener("click",b),u.addEventListener("change",v),p.addEventListener("change",(async e=>{const t=e.target.value;try{await setDoc(doc(db,"settings","backup"),{frequency:t},{merge:!0}),backupSettings.frequency=t}catch(e){console.error("Failed to save backup frequency:",e)}})),onSnapshot(doc(db,"settings","backup"),(e=>{if(e.exists()){const t=e.data();backupSettings=t,p.value=t.frequency||"weekly",t.lastBackup?g.textContent=`Last backup: ${t.lastBackup.toDate().toLocaleString()}`:g.textContent="No backup recorded.","admin"===currentUserRole&&x()}}));const E=document.getElementById("add-task-form"),I=document.getElementById("task-list-container"),w=document.getElementById("edit-task-modal"),B=document.getElementById("edit-task-form"),L=document.getElementById("close-edit-task-modal-btn"),k=()=>{const e=document.getElementById("task-list-supply"),t=document.getElementById("task-list-maintenance"),n=document.getElementById("task-list-other");if(!e||!t||!n)return;e.innerHTML="",t.innerHTML="",n.innerHTML="";const a={"Nails Supply":allTasks.filter((e=>"Nails Supply"===e.category)).sort(((e,t)=>(e.createdAt?.seconds||0)-(t.createdAt?.seconds||0))),Maintenance:allTasks.filter((e=>"Maintenance"===e.category)).sort(((e,t)=>(e.createdAt?.seconds||0)-(t.createdAt?.seconds||0))),Other:allTasks.filter((e=>"Other"===e.category)).sort(((e,t)=>(e.createdAt?.seconds||0)-(t.createdAt?.seconds||0)))},o=e=>{const t={"Nails Supply":{border:"border-blue-500",bg:"bg-blue-50",icon:"fa-shopping-cart"},Maintenance:{border:"border-yellow-500",bg:"bg-yellow-50",icon:"fa-tools"},Other:{border:"border-gray-400",bg:"bg-gray-50",icon:"fa-clipboard-list"}},n=t[e.category]||t.Other,a=document.createElement("div");return a.className=`task-item flex items-center justify-between p-3 rounded-lg border-l-4 ${n.border} ${n.bg}`,a.innerHTML=`\n            <div class="flex items-center flex-grow min-w-0">\n                <i class="fas ${n.icon} mr-3 text-gray-500"></i>\n                <span class="task-description flex-grow ${e.completed?"completed":""} truncate">${e.description}</span>\n            </div>\n            <div class="task-actions flex items-center gap-3 ml-4 flex-shrink-0">\n                <button data-id="${e.id}" class="edit-task-btn text-blue-500 hover:text-blue-700" title="Edit Task"><i class="fas fa-edit"></i></button>\n                <button data-id="${e.id}" class="complete-task-btn text-green-500 hover:text-green-700" title="Complete Task"><i class="fas ${e.completed?"fa-check-square":"fa-square"}"></i></button>\n                <button data-id="${e.id}" class="delete-task-btn text-red-500 hover:text-red-700" title="Delete Task"><i class="fas fa-trash"></i></button>\n            </div>\n        `,a};a["Nails Supply"].length>0?a["Nails Supply"].forEach((t=>e.appendChild(o(t)))):e.innerHTML='<p class="text-xs text-center text-gray-400 py-2">No supply tasks.</p>',a.Maintenance.length>0?a.Maintenance.forEach((e=>t.appendChild(o(e)))):t.innerHTML='<p class="text-xs text-center text-gray-400 py-2">No maintenance tasks.</p>',a.Other.length>0?a.Other.forEach((e=>n.appendChild(o(e)))):n.innerHTML='<p class="text-xs text-center text-gray-400 py-2">No other tasks.</p>'};E&&E.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("task-description"),n=document.getElementById("task-category").value,a=t.value.trim();if(a)try{await addDoc(collection(db,"tasks"),{description:a,category:n,completed:!1,createdAt:serverTimestamp()}),t.value=""}catch(e){console.error("Error adding task:",e),alert("Could not add the task.")}})),I&&I.addEventListener("click",(async e=>{const t=e.target.closest(".complete-task-btn"),n=e.target.closest(".delete-task-btn"),a=e.target.closest(".edit-task-btn");if(a){const e=a.dataset.id,t=allTasks.find((t=>t.id===e));t&&C(t)}else if(t){const e=t.dataset.id,n=allTasks.find((t=>t.id===e));n&&await updateDoc(doc(db,"tasks",e),{completed:!n.completed})}else if(n){const e=n.dataset.id;mt("Are you sure you want to delete this task?",(async()=>{await deleteDoc(doc(db,"tasks",e))}))}}));const C=e=>{B.reset(),document.getElementById("edit-task-id").value=e.id,document.getElementById("edit-task-description").value=e.description,document.getElementById("edit-task-category").value=e.category,w.classList.remove("hidden")},$=()=>{w.classList.add("hidden")};L&&L.addEventListener("click",$),w&&w.querySelector(".modal-overlay").addEventListener("click",$),B&&B.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-task-id").value,n=document.getElementById("edit-task-description").value,a=document.getElementById("edit-task-category").value;if(t&&n)try{await updateDoc(doc(db,"tasks",t),{description:n,category:a}),$()}catch(e){console.error("Error updating task:",e),alert("Could not update task.")}})),onSnapshot(query(collection(db,"tasks"),orderBy("createdAt","desc")),(e=>{allTasks=e.docs.map((e=>({id:e.id,...e.data()}))),k()}));const D=async e=>{e.preventDefault();const t=document.getElementById("admin-tax-rate").value,n=document.getElementById("admin-shipping-fee").value,a=parseInt(document.getElementById("online-gc-start-number").value,10);if(isNaN(a)||a<1e3)return void alert("Online Gift Card Start Number must be a number and at least 1000.");const o=parseFloat(t)/100,i=parseFloat(n);if(isNaN(o)||isNaN(i))alert("Please enter valid numbers for Tax Rate and Shipping Fee.");else try{const e=doc(db,"settings","ecommerce");await setDoc(e,{taxRate:o,shippingFee:i,onlineGcStartNumber:a},{merge:!0}),alert("E-commerce fee settings saved successfully! Cart totals will now update.")}catch(e){console.error("Error saving E-commerce settings: ",e),alert("Failed to save settings. Check console for details.")}};if(document.getElementById("ecommerce-settings-form")?.addEventListener("submit",D),"admin"===e){let e=(new Date).getFullYear(),t=(new Date).getMonth();document.getElementById("prev-holiday-month-btn")?.addEventListener("click",(()=>{t--,t<0&&(t=11,e--),N()})),document.getElementById("next-holiday-month-btn")?.addEventListener("click",(()=>{t++,t>11&&(t=0,e++),N()})),document.getElementById("holiday-calendar-grid")?.addEventListener("click",(async e=>{const t=e.target.closest(".day-cell");if(t&&t.dataset.date){const e=t.dataset.date;let n=[...holidaySettings.dates];n.includes(e)?n=n.filter((t=>t!==e)):n.push(e);try{await setDoc(doc(db,"settings","holidays"),{...holidaySettings,dates:n})}catch(e){console.error("Error updating holidays:",e),alert("Could not update holiday dates.")}}})),document.getElementById("save-holiday-message-btn")?.addEventListener("click",(async()=>{const e=document.getElementById("holiday-message").value;try{await setDoc(doc(db,"settings","holidays"),{...holidaySettings,message:e}),alert("Closure message saved!")}catch(e){console.error("Error saving holiday message:",e),alert("Could not save message.")}}));const n=document.getElementById("holiday-message");n&&(n.value=holidaySettings.message),N(),F()}const S=e=>{const t=e.target,n=t.id.includes("landing")?"holiday-warning-landing":"holiday-warning-modal",a=document.getElementById(n);if(a)if(t.value){const e=isBookingTimeValid(new Date(t.value));!e.valid&&e.message.includes("closed")?(a.textContent=e.message,a.classList.remove("hidden")):a.classList.add("hidden")}else a.classList.add("hidden")};document.getElementById("appointment-datetime-landing")?.addEventListener("input",S),document.getElementById("appointment-datetime")?.addEventListener("input",S),onSnapshot(doc(db,"settings","holidays"),(e=>{e.exists()?holidaySettings=e.data():setDoc(doc(db,"settings","holidays"),holidaySettings),"admin"===currentUserRole&&(N(),F()),Xt(ke,Le,Ce)}))}document.getElementById("royalty-card-designer-form");const ue=document.getElementById("print-royalty-cards-btn"),pe=()=>{const e=royaltySettings.visitsNeeded||10,t=royaltySettings.rewardDescription||"Free Service";let n="";for(let t=1;t<=e;t++)n+=`<div class="stamp-outline">${t}</div>`;document.getElementById("royalty-card-preview-front").innerHTML=`\n        <div class="royalty-card-header">\n            <p class="font-parisienne text-3xl">Nails Express</p>\n            <p class="text-xs font-semibold tracking-wider">ROYALTY CARD</p>\n        </div>\n        <div class="stamp-grid-designer">\n            ${n}\n        </div>\n        <div class="royalty-card-footer text-center">\n            <p class="text-xs">Complete all visits to earn a ${t}!</p>\n        </div>\n    `;document.getElementById("royalty-card-preview-back").innerHTML='\n        <div class="text-center pt-4">\n             <p class="font-bold">Royalty Program Rules</p>\n        </div>\n        <p class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n            One stamp per visit. This card is non-transferable and has no cash value. Cannot be combined with other offers. Lost cards cannot be replaced.\n        </p>\n        <div class="text-center text-xs pb-2">\n            <p class="font-bold">Nails Express</p>\n            <p>1560 Hustonville Rd #345, Danville, KY 40422</p>\n        </div>\n    '};ue.addEventListener("click",(()=>{const e=parseInt(document.getElementById("designer-royalty-quantity").value,10);if(isNaN(e)||e<1)return void alert("Please enter a valid quantity.");const t=royaltySettings.visitsNeeded||10,n=royaltySettings.rewardDescription||"Free Service";let a="";for(let e=1;e<=t;e++)a+=`<div class="stamp-outline">${e}</div>`;let o='\n        <html><head><title>Print Royalty Cards</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&family=Parisienne&display=swap" rel="stylesheet">\n        <style>\n            body{font-family:\'Poppins\',sans-serif;margin:0;background-color:#f0f0f0;}\n            .font-parisienne{font-family:\'Parisienne\',cursive;}\n            .print-page { display: flex; flex-wrap: wrap; justify-content: start; align-content: start; gap: 10mm; padding: 10mm; page-break-after: always; }\n            .card-container{display:grid;grid-template-columns:repeat(2, 1fr);gap:0; width: fit-content;}\n            .card{width:400px;height:228px;box-shadow: 0 4px 8px rgba(0,0,0,0.2);-webkit-print-color-adjust: exact !important; color-adjust: exact !important;}\n            .royalty-card-header { text-align: center; padding-top: 8px; color: #831843;}\n            .stamp-grid-designer { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 0 16px;}\n            .stamp-outline { width: 40px; height: 40px; border: 2px dashed #fb7185; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #fb7185; margin: auto; }\n            @media print {\n                body { padding: 0; background-color: #fff; }\n                .card { box-shadow: none; border: 1px solid #eee; }\n            }\n        </style></head><body><div class="print-page">\n    ';for(let t=0;t<e;t++)o+=`\n            <div class="card-container">\n                \x3c!-- Front of Card --\x3e\n                <div class="card rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br from-pink-50 to-pink-200 text-pink-900">\n                    <div class="royalty-card-header">\n                        <p class="font-parisienne text-3xl">Nails Express</p>\n                        <p class="text-xs font-semibold tracking-wider">ROYALTY CARD</p>\n                    </div>\n                    <div class="stamp-grid-designer">${a}</div>\n                    <div class="royalty-card-footer text-center"><p class="text-xs">Complete all visits to earn a ${n}!</p></div>\n                </div>\n                \x3c!-- Back of Card --\x3e\n                <div class="card rounded-lg p-4 flex flex-col justify-between bg-white text-gray-800" style="text-shadow: none;">\n                    <div class="w-full h-10 bg-black mt-2"></div> \n                    <div class="text-center pt-2"><p class="font-bold">Royalty Program Rules</p></div>\n                    <p class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n                        One stamp per visit. This card is non-transferable and has no cash value. Cannot be combined with other offers. Lost cards cannot be replaced.\n                    </p>\n                    <div class="text-center text-xs pb-2"><p class="font-bold">Nails Express</p><p>1560 Hustonville Rd #345, Danville, KY 40422</p></div>\n                </div>\n            </div>\n        `;o+="</div></body></html>";const i=window.open("","_blank");i.document.write(o),i.document.close(),i.focus()})),pe();const ge=document.getElementById("edit-gift-card-modal"),ye=document.getElementById("client-profile-modal"),he=document.getElementById("rebook-other-input"),fe=document.getElementById("rebook-select"),be=document.getElementById("active-count"),ve=document.getElementById("finished-count"),xe=document.getElementById("today-count"),Ee=document.getElementById("calendar-count"),Ie=document.getElementById("processing-count"),we=document.getElementById("calendar"),Be=document.getElementById("month-year-display");let Le=(new Date).getMonth(),ke=(new Date).getFullYear(),Ce="All",$e="All",De="All",Se="All",Te="",Me="All",Ae="",Ne="daily",Fe="",Re=String((new Date).getMonth()),qe="",Pe=String((new Date).getMonth()),He="All",je="",Ue="daily",Oe="",_e=String((new Date).getMonth()),Ge="",Ye="All",We=[],Ve=[],Xe=[],ze=[],Je=[],Ze=[],Ke=[],Qe=[],et=[],tt={},nt=[],at=[],ot=[],it=[],st=[],dt=[],rt="all",lt="all",ct=null;const mt=(e,t,n="Delete")=>{ne.textContent=e,ct=t,ae.textContent=n,ae.classList.remove("bg-red-600","bg-green-600"),"activate"===n.toLowerCase()?ae.classList.add("bg-green-600"):ae.classList.add("bg-red-600"),te.classList.remove("hidden"),te.classList.add("flex")},ut=()=>{te.classList.add("hidden"),te.classList.remove("flex"),ct=null};ae.addEventListener("click",(()=>{ct&&ct(),ut()})),oe.addEventListener("click",ut),document.querySelector(".confirm-modal-overlay").addEventListener("click",ut);const pt=document.getElementById("view-review-modal"),gt=()=>{pt.classList.add("hidden")};document.getElementById("close-view-review-modal-btn").addEventListener("click",gt),pt.querySelector(".modal-overlay").addEventListener("click",gt);const yt=(e,t=null)=>{const n=new Date;let a,o=new Date(n);if("daily"===e||"today"===e){const e=t?new Date(t+"T00:00:00"):n;return a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999),{startDate:a,endDate:o}}switch(e){case"this_week":const t=n.getDate()-n.getDay();a=new Date(n.setDate(t)),a.setHours(0,0,0,0),o=new Date(a),o.setDate(a.getDate()+6),o.setHours(23,59,59,999);break;case"this_month":a=new Date(n.getFullYear(),n.getMonth(),1),o=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999);break;case"this_year":a=new Date(n.getFullYear(),0,1),o=new Date(n.getFullYear(),11,31,23,59,59,999);break;case"last-year":const i=n.getFullYear()-1;a=new Date(i,0,1),o=new Date(i,11,31,23,59,59,999);break;default:if(!isNaN(parseInt(e))){const t=parseInt(e,10);a=new Date(n.getFullYear(),t,1),o=new Date(n.getFullYear(),t+1,0,23,59,59,999)}}return{startDate:a,endDate:o}};let ht;o("profit-dashboard-range-filter","profit-dashboard-date-filter",(()=>{const e=document.getElementById("profit-dashboard-range-filter").value,t=document.getElementById("profit-dashboard-date-filter").value,{startDate:n,endDate:a}=yt(e,t);if(!n)return;const o=ze.filter((e=>{const t=e.date.toDate();return t>=n&&t<=a})),i=Xe.filter((e=>{const t=e.date.toDate();return t>=n&&t<=a})),s=o.reduce(((e,t)=>e+t.amount),0),d=i.reduce(((e,t)=>{let n=0;return techniciansAndStaff.forEach((e=>{n+=t[e.name.toLowerCase()]||0})),n+=t.sellGiftCard||0,e+n}),0),r=d-s,l=d>0?r/d*100:0;document.getElementById("profit-total-revenue").textContent=`$${d.toFixed(2)}`,document.getElementById("profit-total-expenses").textContent=`$${s.toFixed(2)}`,document.getElementById("profit-net-profit").textContent=`$${r.toFixed(2)}`,document.getElementById("profit-margin").textContent=`${l.toFixed(1)}%`;const c=new Map,m=(e,t=0,n=0)=>{const a=cn(e);c.has(a)||c.set(a,{revenue:0,expense:0});const o=c.get(a);o.revenue+=t,o.expense+=n};i.forEach((e=>{let t=0;techniciansAndStaff.forEach((n=>{t+=e[n.name.toLowerCase()]||0})),t+=e.sellGiftCard||0,m(e.date.toDate(),t,0)})),o.forEach((e=>{m(e.date.toDate(),0,e.amount)}));const u=Array.from(c.entries()).sort(((e,t)=>new Date(e[0])-new Date(t[0]))),p=u.map((e=>new Date(e[0]+"T00:00:00").toLocaleDateString())),g=u.map((e=>e[1].revenue)),y=u.map((e=>e[1].expense)),h=document.getElementById("profit-chart")?.getContext("2d");if(!h)return;ht=initializeChart(ht,h,"line",{labels:p,datasets:[{label:"Total Revenue",data:g,backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:2,tension:.1,fill:!0},{label:"Total Expenses",data:y,backgroundColor:"rgba(255, 99, 132, 0.5)",borderColor:"rgba(255, 99, 132, 1)",borderWidth:2,tension:.1,fill:!0}]},{responsive:!0,maintainAspectRatio:!1})})),document.getElementById("profit-dashboard-range-filter").value=String((new Date).getMonth());const ft=()=>{"admin"===currentUserRole?bt():vt()},bt=()=>{document.getElementById("dashboard-date-filter").value;const{startDate:e,endDate:t}=yt(Re,Fe);if(!e)return;const n=Xe.filter((n=>{const a=n.date.toDate();return a>=e&&a<=t})),a=allAppointments.filter((n=>{const a=n.appointmentTimestamp.toDate();return a>=e&&a<=t})),o=ze.filter((n=>{const a=n.date.toDate();return a>=e&&a<=t})),i=Qe.filter((n=>{const a=n.createdAt.toDate();return a>=e&&a<=t}));let s=0,d=0;const r={};n.forEach((e=>{let t=0;techniciansAndStaff.forEach((n=>{const a=n.name.toLowerCase(),o=e[a]||0;t+=o,r[n.name]=(r[n.name]||0)+o})),t+=e.sellGiftCard||0;const n=t-((e.totalCredit||0)+(e.check||0)+(e.returnGiftCard||0)+(e.venmo||0)+(e.square||0));s+=t,d+=n})),document.getElementById("total-salon-revenue-card").textContent=`$${s.toFixed(2)}`,document.getElementById("total-salon-cash-card").textContent=`$${d.toFixed(2)}`;const l=Object.keys(r).reduce(((e,t)=>r[e]>r[t]?e:t),"-");document.getElementById("top-earning-technician-card").textContent=l;const c=a.reduce(((e,t)=>(t.technician&&"Any Technician"!==t.technician&&(e[t.technician]=(e[t.technician]||0)+1),e)),{}),m=Object.keys(c).reduce(((e,t)=>c[e]>c[t]?e:t),"-");document.getElementById("top-booking-technician-card").textContent=m,document.getElementById("total-appointments-card").textContent=allAppointments.length,document.getElementById("total-clients-card").textContent=allClients.length;const u=i.reduce(((e,t)=>e+t.amount),0);document.getElementById("total-gift-card-card").textContent=`$${u.toFixed(2)}`;const p=o.reduce(((e,t)=>e+t.amount),0);document.getElementById("total-expense-card").textContent=`$${p.toFixed(2)}`,Et(n,Re),(e=>{const t=document.getElementById("staff-earning-cards-container"),n=document.getElementById("staff-earnings-chart")?.getContext("2d");if(!t||!n)return;const a={},o=techniciansAndStaff.filter((e=>"admin"!==e.role));o.forEach((e=>{a[e.name]=0})),e.forEach((e=>{o.forEach((t=>{e[t.name.toLowerCase()]&&(a[t.name]+=e[t.name.toLowerCase()])}))})),t.innerHTML="",o.forEach(((e,n)=>{const o=e.payoutType||"standard",i=a[e.name]||0;let s;const d=(e.commissionRate||70)/100;if("commission_plus_tips"===o){const{startDate:t,endDate:n}=yt(Re,Fe);s=i*d+Ve.filter((a=>{const o=a.date.toDate();return a.staffName===e.name&&o>=t&&o<=n})).reduce(((e,t)=>e+(t.tip||0)),0)}else s=i*d;const r=.7*s,l=s-r,c=colorPalette[n%colorPalette.length],m=`\n            <div class="dashboard-card ${c.card} p-4 flex flex-col">\n                <div><h4 class="font-bold ${c.text} truncate">${e.name}</h4><p class="text-2xl font-bold text-gray-700 mb-2">$${i.toFixed(2)}</p></div>\n                <div class="mt-auto space-y-1 text-xs text-gray-600 border-t border-gray-400/20 pt-2">\n                    <div class="flex justify-between"><span>Total Payout:</span><span class="font-semibold text-gray-800">$${s.toFixed(2)}</span></div>\n                    <div class="flex justify-between"><span>Check Payout:</span><span class="font-semibold text-gray-800">$${r.toFixed(2)}</span></div>\n                    <div class="flex justify-between"><span>Cash Payout:</span><span class="font-semibold text-gray-800">$${l.toFixed(2)}</span></div>\n                </div>\n            </div>`;t.innerHTML+=m}));const i=Object.keys(a),s=Object.values(a),d=i.map(((e,t)=>colorPalette[t%colorPalette.length].bg)),r=i.map(((e,t)=>colorPalette[t%colorPalette.length].border));staffEarningsChart=initializeChart(staffEarningsChart,n,"bar",{labels:i,datasets:[{label:"Total Earnings",data:s,backgroundColor:d,borderColor:r,borderWidth:1}]},{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}})})(n),xt("admin-upcoming-appointments-list",allAppointments,Ye)},vt=()=>{const{startDate:e,endDate:t}=yt(Pe,qe);if(!e)return;const n=Xe.filter((n=>n.date.toDate()>=e&&n.date.toDate()<=t)),a=Ve.filter((n=>n.staffName===currentUserName&&n.date.toDate()>=e&&n.date.toDate()<=t)),o=currentUserName.toLowerCase(),i=n.reduce(((e,t)=>e+(t[o]||0)),0),s=a.reduce(((e,t)=>e+(t.tip||0)),0),d=techniciansAndStaff.find((e=>e.name===currentUserName)),r=d?d.payoutType:"standard";let l;const c=(d&&d.commissionRate?d.commissionRate:70)/100;l="commission_plus_tips"===r?i*c+s:i*c;const m=.7*l,u=l-m;document.getElementById("my-earning-card").textContent=`$${i.toFixed(2)}`,document.getElementById("my-total-payout-card").textContent=`$${l.toFixed(2)}`,document.getElementById("my-cash-payout-card").textContent=`$${u.toFixed(2)}`,document.getElementById("my-check-payout-card").textContent=`$${m.toFixed(2)}`,document.getElementById("my-tips-card").textContent=`$${s.toFixed(2)}`;const p=allAppointments.filter((e=>e.technician===currentUserName&&e.appointmentTimestamp.toDate()>new Date)),g=new Set(allFinishedClients.filter((e=>e.technician===currentUserName)).map((e=>e.name)));document.getElementById("my-appointments-card").textContent=p.length,document.getElementById("my-clients-card").textContent=g.size,It(n,Pe,currentUserName);const y=document.getElementById("staff-details-date-filter").value;let h=Ve.filter((e=>e.staffName===currentUserName));if(y){const e=new Date(y+"T00:00:00");h=h.filter((t=>t.date.toDate()>=e&&t.date.toDate()<new Date(e.getTime()+864e5)))}document.getElementById("staff-details-title").textContent=`My Earning Details (${h.length} Client${1===h.length?"":"s"})`;const{totalEarning:f,totalTip:b}=Tt(h,"staff-dashboard-earning-table","staff-dashboard-total-earning","staff-dashboard-total-tip");document.getElementById("staff-dashboard-filtered-earning-total-main").textContent=`Total ($${f.toFixed(2)})`,document.getElementById("staff-dashboard-filtered-earning-total-tip").textContent=`Tip ($${b.toFixed(2)})`,xt("staff-upcoming-appointments-list",allAppointments,currentUserName)},xt=(e,t,n="All")=>{const a=document.getElementById(e);if(!a)return;let o=t.filter((e=>e.appointmentTimestamp.toDate()>new Date));if("All"!==n&&"Any Technician"!==n?o=o.filter((e=>e.technician===n)):"Any Technician"===n&&(o=o.filter((e=>"Any Technician"===e.technician))),0===o.length)return void(a.innerHTML='<p class="text-center text-gray-500 py-4">No upcoming appointments found.</p>');let i='\n        <table class="w-full text-sm text-left text-gray-600">\n            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">\n                <tr>\n                    <th scope="col" class="px-6 py-3">Name</th>\n                    <th scope="col" class="px-6 py-3">Services</th>\n                    <th scope="col" class="px-6 py-3">Technician</th>\n                    <th scope="col" class="px-6 py-3">Group</th>\n                    <th scope="col" class="px-6 py-3">Date & Time</th>\n                    <th scope="col" class="px-6 py-3 text-center">Action</th>\n                </tr>\n            </thead>\n            <tbody>';o.sort(((e,t)=>e.appointmentTimestamp.seconds-t.appointmentTimestamp.seconds)),o.forEach((e=>{i+=`\n<tr class="border-b">\n                <td class="px-6 py-3 font-medium">\n                    <span data-client-name="${e.name}" \n                          class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span>\n                </td>\n                <td class="px-6 py-3">${Array.isArray(e.services)?e.services.join(", "):e.services}</td>\n                <td class="px-6 py-3">${e.technician}</td>\n                <td class="px-6 py-3 text-center">${e.people||1}</td>\n                <td class="px-6 py-3">${new Date(1e3*e.appointmentTimestamp.seconds).toLocaleString([],{dateStyle:"short",timeStyle:"short"})}</td>\n                \n                \x3c!-- UPDATED ACTION CELL --\x3e\n                <td class="px-6 py-3 text-center space-x-4">\n                    \x3c!-- 1. NEW "VIEW PROFILE" BUTTON --\x3e\n                    <button data-client-name="${e.name}" \n                            class="view-profile-btn text-indigo-500 hover:text-indigo-700" \n                            title="View Client Profile">\n                        <i class="fas fa-user-circle text-lg"></i>\n                    </button>\n                    \n                    \x3c!-- 2. EXISTING "CHECK IN" BUTTON --\x3e\n                    <button data-id="${e.id}" class="checkin-today-btn text-blue-500 hover:underline">Check In</button>\n                </td>\n            </tr>\n        `})),i+="</tbody></table>",a.innerHTML=i},Et=(e,t)=>{const n=document.getElementById("salon-revenue-chart")?.getContext("2d");if(!n)return;let a=[],o=[],i=[],s={},d={};if(e.forEach((e=>{const n=e.date.toDate();let a;"daily"===t?a=n.getHours():"this-year"===t||"last-year"===t?a=n.getMonth():isNaN(parseInt(t))||(a=n.getDate());let o=0;techniciansAndStaff.forEach((t=>{o+=e[t.name.toLowerCase()]||0})),o+=e.sellGiftCard||0;const i=o-((e.totalCredit||0)+(e.check||0)+(e.returnGiftCard||0)+(e.venmo||0)+(e.square||0));void 0!==a&&(s[a]=(s[a]||0)+o,d[a]=(d[a]||0)+i)})),"daily"===t)a=Array.from({length:24},((e,t)=>`${t}:00`)),o=a.map(((e,t)=>s[t]||0)),i=a.map(((e,t)=>d[t]||0));else if("this-year"===t||"last-year"===t)a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=a.map(((e,t)=>s[t]||0)),i=a.map(((e,t)=>d[t]||0));else if(!isNaN(parseInt(t))){const e=(new Date).getFullYear(),n=parseInt(t),r=new Date(e,n+1,0).getDate();a=Array.from({length:r},((e,t)=>t+1)),o=a.map((e=>s[e]||0)),i=a.map((e=>d[e]||0))}salonRevenueChart=initializeChart(salonRevenueChart,n,"line",{labels:a,datasets:[{label:"Total Revenue",data:o,backgroundColor:"rgba(219, 39, 119, 0.5)",borderColor:"rgba(219, 39, 119, 1)",borderWidth:1,tension:.1},{label:"Cash Revenue",data:i,backgroundColor:"rgba(16, 185, 129, 0.5)",borderColor:"rgba(16, 185, 129, 1)",borderWidth:1,tension:.1}]},{responsive:!0,maintainAspectRatio:!1})},It=(e,t,n)=>{const a=document.getElementById("my-earnings-chart")?.getContext("2d");if(!a)return;const o=n.toLowerCase(),i=[],s={earning:{label:"Total Earning",data:[],backgroundColor:"rgba(219, 39, 119, 0.5)",borderColor:"rgba(219, 39, 119, 1)"},payout:{label:"Total Payout",data:[],backgroundColor:"rgba(16, 185, 129, 0.5)",borderColor:"rgba(16, 185, 129, 1)"},cash:{label:"Cash Payout",data:[],backgroundColor:"rgba(245, 158, 11, 0.5)",borderColor:"rgba(245, 158, 11, 1)"},check:{label:"Check Payout",data:[],backgroundColor:"rgba(59, 130, 246, 0.5)",borderColor:"rgba(59, 130, 246, 1)"}},d={};e.forEach((e=>{const n=e.date.toDate();let a;"daily"===t?a=n.getHours():"this-year"===t||"last-year"===t?a=n.getMonth():isNaN(parseInt(t))||(a=n.getDate()),void 0!==a&&(d[a]||(d[a]={earning:0}),d[a].earning+=e[o]||0)}));const r=techniciansAndStaff.find((e=>e.name===n)),l=(r&&r.commissionRate?r.commissionRate:70)/100,c=e=>{const t=d[e]?.earning||0,n=t*l,a=.7*n,o=n-a;s.earning.data.push(t),s.payout.data.push(n),s.cash.data.push(o),s.check.data.push(a)};if("daily"===t)for(let e=0;e<24;e++)i.push(`${e}:00`),c(e);else if("this-year"===t||"last-year"===t){i.push("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");for(let e=0;e<12;e++)c(e)}else if(!isNaN(parseInt(t))){const e=(new Date).getFullYear(),n=parseInt(t),a=new Date(e,n+1,0).getDate();for(let e=1;e<=a;e++)i.push(e),c(e)}const m={labels:i,datasets:Object.values(s).map((e=>({...e,borderWidth:1,tension:.1})))};myEarningsChart=initializeChart(myEarningsChart,a,"line",m,{responsive:!0,maintainAspectRatio:!1})};document.getElementById("dashboard-date-filter").addEventListener("change",bt),document.getElementById("staff-dashboard-date-filter").addEventListener("change",vt);const wt=()=>{P.innerHTML="",H.innerHTML="",Object.keys(servicesData).forEach((e=>{const t=document.createElement("button");t.type="button",t.className="category-button p-4 border border-gray-200 rounded-lg text-left bg-white hover:border-pink-300 hover:bg-pink-50 transition-all duration-200 shadow-sm",t.dataset.category=e,t.innerHTML=`<h3 class="text-lg font-bold text-pink-700">${e}</h3><span class="text-sm text-gray-500 mt-1 block">Click to select</span><span class="selection-count hidden mt-2 bg-pink-600 text-white text-xs font-bold px-2 py-1 rounded-full"></span>`,P.appendChild(t),servicesData[e].forEach((t=>{const n=`${t.p||""}${t.name}${t.price?" "+t.price:""}`,a=document.createElement("input");a.type="checkbox",a.name="service",a.value=n,a.dataset.category=e,H.appendChild(a)}))}))},Bt=(e,t,n,a)=>{let o=e;return t&&(o=o.filter((e=>e.name.toLowerCase().includes(t)))),"All"!==n&&"Any Technician"!==n?o=o.filter((e=>e.technician===n)):"Any Technician"===n&&(o=o.filter((e=>"Any Technician"===e.technician))),a&&(o=o.filter((e=>!!e.checkOutTimestamp&&cn(new Date(1e3*e.checkOutTimestamp.seconds))===a))),o},Lt=e=>{const t=document.querySelector("#clients-table tbody");t&&(t.innerHTML=0===e.length?'<tr><td colspan="7" class="py-6 text-center text-gray-400">No clients in the queue.</td></tr>':"",e.forEach(((e,n)=>{const a=e.technician||"Unassigned",o=t.insertRow();o.className="bg-white border-b",o.innerHTML=`\n                <td class="px-6 py-4 text-center font-medium text-gray-900">${n+1}</td>\n                <td class="px-6 py-4">\n                    <span data-client-name="${e.name}" class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span>\n                </td>\n                \n                <td class="px-6 py-4 text-center">${e.people||1}</td>\n                \n                <td class="px-6 py-4">${a}</td>\n                \n                <td class="px-6 py-4">${e.services}</td>\n                \n                <td class="px-6 py-4">${e.checkInTime}</td>\n                \n                <td class="px-6 py-4 text-center space-x-4">\n                    <button data-id="${e.id}" class="check-out-btn-processing" title="Fast Check Out"><i class="fas fa-receipt text-lg text-green-500 hover:text-green-700"></i></button>\n                    \n                    <button data-id="${e.id}" class="move-to-processing-btn" title="Move to Processing"><i class="fas fa-arrow-right text-lg text-blue-500 hover:text-blue-700"></i></button>\n                    \n                    <button data-id="${e.id}" class="detail-btn-active" title="View Details"><i class="fas fa-info-circle text-lg text-gray-500 hover:text-gray-700"></i></button>\n                </td>\n            `})))},kt=e=>{const t=document.querySelector("#processing-table tbody");t&&(t.innerHTML=0===e.length?'<tr><td colspan="6" class="py-6 text-center text-gray-400">No clients are being processed.</td></tr>':"",e.forEach(((e,n)=>{const a=t.insertRow();a.className="bg-white border-b",a.innerHTML=`<td class="px-6 py-4 text-center font-medium text-gray-900">${n+1}</td><td class="px-6 py-4"><span data-client-name="${e.name}" \n                          class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span></td><td class="px-6 py-4 text-center">${e.people||1}</td> <td class="px-6 py-4">${e.technician}</td><td class="px-6 py-4">${e.services}</td><td class="px-6 py-4">${e.checkInTime}</td><td class="px-6 py-4 text-center"><button data-id="${e.id}" class="check-out-btn-processing" title="Check Out"><i class="fas fa-check-circle text-lg text-green-500 hover:text-green-700"></i></button> </td>`})))},Ct=e=>{const t=document.querySelector("#finished-clients-table tbody");t&&(t.innerHTML=0===e.length?'<tr><td colspan="7" class="py-6 text-center text-gray-400">No finished clients found.</td></tr>':"",e.forEach(((e,n)=>{const a=t.insertRow();a.className="bg-white border-b",a.innerHTML=`\n    <td class="px-6 py-4 text-center font-medium text-gray-900">${n+1}</td>\n    <td class="px-6 py-4"><span data-client-name="${e.name}" \n                          class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span></td>\n    <td class="px-6 py-4">${e.people}</td>\n    <td class="px-6 py-4">${e.services}</td>\n    <td class="px-6 py-4">${e.checkInTime}</td>\n    <td class="px-6 py-4 text-center text-yellow-400 ${e.rating?"cursor-pointer view-review-rating":""}" data-id="${e.id}">${e.rating?"".repeat(e.rating):"N/A"}</td>\n    <td class="px-6 py-4 text-center space-x-2">\n        ${e.review?`<button data-id="${e.id}" class="feature-review-btn text-lg ${e.isFeatured?"text-green-500":"text-gray-400"}" title="Feature on Homepage"><i class="fas fa-certificate"></i></button>`:""}\n        <button data-id="${e.id}" class="view-feedback-btn" title="View Details"><i class="fas fa-info-circle text-lg text-gray-500 hover:text-gray-700"></i></button>\n        <button data-id="${e.id}" class="delete-btn-finished" title="Delete"><i class="fas fa-trash-alt text-lg text-red-500 hover:text-red-700"></i></button>\n    </td>`})))},$t=document.getElementById("checkout-star-rating-container");$t&&$t.addEventListener("click",(e=>{const t=e.target.closest(".fa-star");if(!t)return;const n=parseInt(t.dataset.value,10);document.getElementById("checkout-rating-value").value=n,$t.querySelectorAll("i").forEach(((e,t)=>{e.classList.toggle("text-yellow-400",t<n)}))}));const Dt=()=>{if(!allFinishedClients||!allClients){const e=document.querySelector("#clients-list-table tbody");return void(e&&(e.innerHTML='<tr><td colspan="5" class="py-6 text-center text-gray-400">Loading client data...</td></tr>'))}const e=new Map;allFinishedClients.forEach((t=>{if(!t.name)return;const n=t.name.toLowerCase();e.has(n)||e.set(n,{name:t.name,phone:t.phone||"",email:t.email||"",lastVisit:t.checkOutTimestamp.toMillis(),techCounts:{},colorCounts:{}});const a=e.get(n);t.checkOutTimestamp.toMillis()>a.lastVisit&&(a.lastVisit=t.checkOutTimestamp.toMillis(),a.phone=t.phone||a.phone,a.email=t.email||a.email),t.technician&&(a.techCounts[t.technician]=(a.techCounts[t.technician]||0)+1),t.colorCode&&(a.colorCounts[t.colorCode]=(a.colorCounts[t.colorCode]||0)+1)}));let t=Array.from(e.values()).map((e=>{const t=e=>Object.keys(e).length>0?Object.keys(e).reduce(((t,n)=>e[t]>e[n]?t:n)):"N/A";return{...e,favoriteTech:t(e.techCounts),favoriteColor:t(e.colorCounts)}}));const n=new Map(allClients.map((e=>[e.name.toLowerCase(),{dob:e.dob,id:e.id,phone:e.phone,email:e.email}])));let a=t.map((e=>{const t=e.name.toLowerCase(),a=n.get(t);return{...e,id:a?a.id:null,dob:a?a.dob:"",phone:a&&a.phone?a.phone:e.phone,email:a&&a.email?a.email:e.email}}));allClients.forEach((t=>{e.has(t.name.toLowerCase())||a.push({...t,lastVisit:null,favoriteTech:"N/A",favoriteColor:"N/A"})})),We=a;const o=document.getElementById("search-clients-list").value.toLowerCase(),i=We.filter((e=>e.name.toLowerCase().includes(o))),s=document.querySelector("#clients-list-table tbody");s&&(s.innerHTML="",0!==i.length?i.forEach((e=>{const t=s.insertRow();t.className="bg-white border-b",t.innerHTML=`<td class="px-6 py-3 font-medium">\n                    <span data-client-name="${e.name}" \n                          class="view-profile-btn cursor-pointer text-indigo-700 hover:text-indigo-900 hover:underline font-semibold">\n                        ${e.name}\n                    </span>\n                </td><td class="px-6 py-4">${e.phone||"N/A"}</td><td class="px-6 py-4">${e.email||"N/A"}</td><td class="px-6 py-4">${e.lastVisit?new Date(e.lastVisit).toLocaleDateString():"N/A"}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="text-indigo-500 hover:text-indigo-700 view-client-profile-btn" title="View Profile"><i class="fas fa-user-circle text-lg"></i></button><button data-id="${e.id}" class="text-blue-500 hover:text-blue-700 edit-client-btn" title="Edit Client"><i class="fas fa-edit text-lg"></i></button><button data-id="${e.id}" class="text-red-500 hover:text-red-700 delete-client-btn" title="Delete Client"><i class="fas fa-trash-alt text-lg"></i></button></td>`})):s.innerHTML='<tr><td colspan="5" class="py-6 text-center text-gray-400">No clients found.</td></tr>')},St=(e,t,n,a,o,i)=>{let s=e;"admin"!==o?s=s.filter((e=>e.staffName===i)):"All"!==t&&(s=s.filter((e=>e.staffName===t)));const{startDate:d,endDate:r}=yt(a,n);return d&&r&&(s=s.filter((e=>{const t=e.date.toDate();return t>=d&&t<=r}))),s},Tt=(t,n,a,o)=>{const i=document.querySelector(`#${n} tbody`);if(!i)return{totalEarning:0,totalTip:0};const s="admin"===e?7:6;i.innerHTML=0===t.length?`<tr><td colspan="${s}" class="py-6 text-center text-gray-400">No earnings found.</td></tr>`:"",t.sort(((e,t)=>t.date.seconds-e.date.seconds)).forEach(((t,n)=>{const a=i.insertRow();a.className="bg-white border-b";const o=t.date?new Date(1e3*t.date.seconds):null;let s=`\n            <td class="px-6 py-4">${n+1}</td> <td class="px-6 py-4">${o?o.toLocaleDateString():"N/A"}</td> <td class="px-6 py-4 font-medium text-gray-900">${t.staffName||"N/A"}</td>\n            <td class="px-6 py-4">${t.service||""}</td>\n            <td class="px-6 py-4">$${t.earning?t.earning.toFixed(2):"0.00"}</td>\n            <td class="px-6 py-4">$${t.tip?t.tip.toFixed(2):"0.00"}</td>\n        `;"admin"===e&&(s+=`<td class="px-6 py-4 text-center space-x-2"><button data-id="${t.id}" class="edit-earning-btn text-blue-500 hover:text-blue-700" title="Edit Earning"><i class="fas fa-edit text-lg"></i></button><button data-id="${t.id}" class="delete-earning-btn text-red-500 hover:text-red-700" title="Delete Earning"><i class="fas fa-trash-alt text-lg"></i></button></td>`),a.innerHTML=s}));const d=t.reduce(((e,t)=>e+(t.earning||0)),0),r=t.reduce(((e,t)=>e+(t.tip||0)),0),l=document.getElementById(a),c=document.getElementById(o);return l&&(l.textContent=`$${d.toFixed(2)}`),c&&(c.textContent=`$${r.toFixed(2)}`),{totalEarning:d,totalTip:r}},Mt=()=>{const n=St(Ve,Me,Ae,Ne,e,t),{totalEarning:a,totalTip:o}=Tt(n,"staff-earning-table","total-earning","total-tip"),i=document.getElementById("filtered-earning-total-main"),s=document.getElementById("filtered-earning-total-tip");i&&(i.textContent=`Total ($${a.toFixed(2)})`),s&&(s.textContent=`Tip ($${o.toFixed(2)})`);const d=St(Ve,He,je,Ue,e,t),{totalEarning:r,totalTip:l}=Tt(d,"dashboard-staff-earning-table-full","dashboard-total-earning","dashboard-total-tip"),c=document.getElementById("dashboard-filtered-earning-total-main"),m=document.getElementById("dashboard-filtered-earning-total-tip");c&&(c.textContent=`Total ($${r.toFixed(2)})`),m&&(m.textContent=`Tip ($${l.toFixed(2)})`);const u=d.length,p=document.getElementById("dashboard-staff-earning-title");p&&(p.textContent=`Staff Earning Report (${u} Client${1===u?"":"s"})`)},At=(e,t,n)=>{let a=[...e];const{startDate:o,endDate:i}=yt(n,t);return o&&i&&(a=a.filter((e=>{const t=e.date.toDate();return t>=o&&t<=i}))),a},Nt=e=>{const t=document.querySelector("#salon-earning-table tbody"),n=document.querySelector("#salon-earning-table-foot");if(!t||!n)return;t.innerHTML="";const a=techniciansAndStaff.map((e=>e.name.toLowerCase()));if([...a,"sell-gc","return-gc","check","no-credit","total-credit","venmo","square","total","cash"].forEach((e=>{const t=document.getElementById(`total-${e.replace(/_/g,"-")}`);t&&(t.textContent="no-credit"===e?"0":"$0.00")})),a.forEach((e=>{document.getElementById(`commission-${e}`).textContent="$0.00",document.getElementById(`check70-${e}`).textContent="$0.00",document.getElementById(`cash30-${e}`).textContent="$0.00"})),0===e.length)return void(t.innerHTML=`<tr><td colspan="${a.length+10}" class="py-6 text-center text-gray-400">No salon earnings found for this period.</td></tr>`);let o={};a.forEach((e=>o[e]=0)),o.sellGiftCard=0,o.returnGiftCard=0,o.check=0,o.noOfCredit=0,o.totalCredit=0,o.venmo=0,o.square=0,o.total=0,o.cash=0,e.sort(((e,t)=>t.date.seconds-e.date.seconds)).forEach((e=>{const n=t.insertRow();n.className="bg-white border-b";let i=`<td class="px-6 py-4">${new Date(1e3*e.date.seconds).toLocaleDateString()}</td>`,s=0;a.forEach((t=>{const n=e[t]||0;i+=`<td class="px-6 py-4">$${n.toFixed(2)}</td>`,s+=n,o[t]+=n}));const d=s+(e.sellGiftCard||0),r=d-((e.totalCredit||0)+(e.check||0)+(e.returnGiftCard||0)+(e.venmo||0)+(e.square||0));i+=`\n            <td class="px-6 py-4">$${(e.sellGiftCard||0).toFixed(2)}</td>\n            <td class="px-6 py-4">$${(e.returnGiftCard||0).toFixed(2)}</td>\n            <td class="px-6 py-4">$${(e.check||0).toFixed(2)}</td>\n            <td class="px-6 py-4">${e.noOfCredit||0}</td>\n            <td class="px-6 py-4">$${(e.totalCredit||0).toFixed(2)}</td>\n            <td class="px-6 py-4">$${(e.venmo||0).toFixed(2)}</td>\n            <td class="px-6 py-4">$${(e.square||0).toFixed(2)}</td>\n            <td class="px-6 py-4 font-bold">$${d.toFixed(2)}</td>\n            <td class="px-6 py-4 font-bold">$${r.toFixed(2)}</td>\n            <td class="px-6 py-4 text-center space-x-2">\n                <button data-id="${e.id}" class="edit-salon-earning-btn text-blue-500 hover:text-blue-700" title="Edit Salon Earning"><i class="fas fa-edit text-lg"></i></button>\n                <button data-id="${e.id}" class="delete-salon-earning-btn text-red-500 hover:text-red-700" title="Delete Salon Earning"><i class="fas fa-trash-alt text-lg"></i></button>\n            </td>`,n.innerHTML=i,o.sellGiftCard+=e.sellGiftCard||0,o.returnGiftCard+=e.returnGiftCard||0,o.check+=e.check||0,o.noOfCredit+=e.noOfCredit||0,o.totalCredit+=e.totalCredit||0,o.venmo+=e.venmo||0,o.square+=e.square||0,o.total+=d,o.cash+=r})),document.getElementById("total-sell-gc").textContent=`$${o.sellGiftCard.toFixed(2)}`,document.getElementById("total-return-gc").textContent=`$${o.returnGiftCard.toFixed(2)}`,document.getElementById("total-check").textContent=`$${o.check.toFixed(2)}`,document.getElementById("total-no-credit").textContent=o.noOfCredit,document.getElementById("total-total-credit").textContent=`$${o.totalCredit.toFixed(2)}`,document.getElementById("total-venmo").textContent=`$${o.venmo.toFixed(2)}`,document.getElementById("total-square").textContent=`$${o.square.toFixed(2)}`,document.getElementById("total-total").textContent=`$${o.total.toFixed(2)}`,document.getElementById("total-cash").textContent=`$${o.cash.toFixed(2)}`,a.forEach((e=>{document.getElementById(`total-${e}`).textContent=`$${(o[e]||0).toFixed(2)}`})),a.forEach((e=>{const t=techniciansAndStaff.find((t=>t.name.toLowerCase()===e)),n=t?t.payoutType:"standard",a=o[e]||0;let i;const s=(t&&t.commissionRate?t.commissionRate:70)/100;if("commission_plus_tips"===n){const{startDate:t,endDate:n}=yt(_e,Oe);i=a*s+Ve.filter((a=>a.staffName.toLowerCase()===e&&a.date.toDate()>=t&&a.date.toDate()<=n)).reduce(((e,t)=>e+(t.tip||0)),0)}else i=a*s;const d=.7*i,r=i-d;document.getElementById(`commission-${e}`).textContent=`$${i.toFixed(2)}`,document.getElementById(`check70-${e}`).textContent=`$${d.toFixed(2)}`,document.getElementById(`cash30-${e}`).textContent=`$${r.toFixed(2)}`}))};for(let e=1;e<=20;e++)q.appendChild(new Option(e,e));for(let e=1;e<=20;e++)document.getElementById("appointment-people").appendChild(new Option(e,e));const Ft=()=>{const e=O.querySelector(".modal-checkbox");if(!e)return j.classList.add("hidden"),void j.classList.remove("flex");const t=e.dataset.sourceContainer||"hidden-checkbox-container",n=document.getElementById(t),a="appointment-hidden-checkboxes"===t?"appointment-services-container":"services-container",o=document.getElementById(a);O.querySelectorAll(".modal-checkbox").forEach((e=>{const t=n.querySelector(`input[value="${e.value}"]`);t&&(t.checked=e.checked)})),j.classList.add("hidden"),j.classList.remove("flex"),o&&o.querySelectorAll(".category-button").forEach((e=>{const t=e.dataset.category,a=n.querySelectorAll(`input[data-category="${t}"]:checked`).length,o=e.querySelector(".selection-count");a>0?(o.textContent=`${a} selected`,o.classList.remove("hidden")):o.classList.add("hidden")}))};P.addEventListener("click",(e=>{const t=e.target.closest(".category-button");var n;t&&(n=t.dataset.category,U.textContent=n,O.innerHTML="",servicesData[n].forEach((e=>{const t=`${e.p||""}${e.name}${e.price?" "+e.price:""}`,n=H.querySelector(`input[value="${t}"]`),a=document.createElement("label");a.className="flex items-center p-3 hover:bg-pink-50 cursor-pointer rounded-lg",a.innerHTML=`<input type="checkbox" class="form-checkbox modal-checkbox" data-source-container="hidden-checkbox-container" value="${t}" ${n&&n.checked?"checked":""}><span class="ml-3 text-gray-700 flex-grow">${e.name}</span>${e.price?`<span class="font-semibold">${e.price}</span>`:""}`,O.appendChild(a)})),j.classList.add("flex"),j.classList.remove("hidden"))})),_.addEventListener("click",Ft),G.addEventListener("click",Ft),R.addEventListener("submit",(async e=>{e.preventDefault();const t=Array.from(document.querySelectorAll('input[name="service"]:checked')).map((e=>e.value));if(!document.getElementById("full-name").value||0===t.length)return alert("Please enter a name and select at least one service.");try{await addDoc(collection(db,"active_queue"),{name:document.getElementById("full-name").value,phone:document.getElementById("phone-number").value||"N/A",people:document.getElementById("people-count").value,bookingType:document.getElementById("booking-type").value,services:t,checkInTimestamp:serverTimestamp(),status:"waiting",technician:document.getElementById("checkin-technician-select").value}),R.reset(),H.querySelectorAll("input").forEach((e=>e.checked=!1)),document.querySelectorAll(".category-button").forEach((e=>{const t=e.dataset.category,n=H.querySelectorAll(`input[data-category="${t}"]:checked`).length,a=e.querySelector(".selection-count");n>0?(a.textContent=`${n} selected`,a.classList.remove("hidden")):a.classList.add("hidden")}))}catch(e){console.error("Error adding document: ",e),alert("Could not add client to the queue.")}})),document.getElementById("queue-content").addEventListener("click",(async e=>{const t=e.target.closest(".move-to-processing-btn"),n=e.target.closest(".detail-btn-active");if(t)await updateDoc(doc(db,"active_queue",t.dataset.id),{status:"processing"});else if(n){const e=allActiveClients.find((e=>e.id===n.dataset.id));jt(e,"Booking Detail")}})),document.getElementById("processing-content").addEventListener("click",(async e=>{const t=e.target.closest(".check-out-btn-processing");if(t){const e=t.dataset.id,n=allActiveClients.find((t=>t.id===e));n&&(document.getElementById("technician-name-select").value=n.technician),document.getElementById("checkout-client-id").value=e,document.getElementById("checkout-source-collection").value="active_queue",Y.classList.remove("hidden"),Y.classList.add("flex")}})),document.addEventListener("click",(async e=>{const t=e.target.closest("#clients-table .check-out-btn-processing");if(t){e.preventDefault();const n=t.dataset.id,a=allActiveClients.find((e=>e.id===n));a&&(document.getElementById("technician-name-select").value=a.technician),document.getElementById("checkout-client-id").value=n,document.getElementById("checkout-source-collection").value="active_queue",Y.classList.remove("hidden"),Y.classList.add("flex")}}));const Rt=document.getElementById("matrix-btn-earning"),qt=document.getElementById("matrix-btn-tip"),Pt=document.getElementById("matrix-toggle-slider");if(Rt&&qt&&Pt){const e=e=>{"earning"===e?(Pt.style.transform="translateX(0)",Rt.classList.add("text-pink-600","font-bold"),Rt.classList.remove("text-gray-500","font-medium"),qt.classList.add("text-gray-500","font-medium"),qt.classList.remove("text-green-600","font-bold")):(Pt.style.transform="translateX(100%) translateX(4px)",Rt.classList.add("text-gray-500","font-medium"),Rt.classList.remove("text-pink-600","font-bold"),qt.classList.add("text-green-600","font-bold"),qt.classList.remove("text-gray-500","font-medium"))};Rt.addEventListener("click",(()=>{"earning"!==currentMatrixViewType&&(currentMatrixViewType="earning",e("earning"),renderEarningsMatrix(allStaffEarnings))})),qt.addEventListener("click",(()=>{"tip"!==currentMatrixViewType&&(currentMatrixViewType="tip",e("tip"),renderEarningsMatrix(allStaffEarnings))}))}const Ht=document.getElementById("matrix-month-filter");Ht&&Ht.addEventListener("change",(()=>{renderEarningsMatrix(allStaffEarnings)}));const jt=(e,t="Client Details")=>{if(!e)return;document.getElementById("view-detail-title").textContent=t;const n=document.getElementById("view-detail-content"),a=document.getElementById("view-detail-actions");let o='<div class="space-y-2"><h4 class="text-lg font-semibold text-gray-800 border-b pb-1">Appointment Details</h4>',i="N/A";e.appointmentTimestamp?i=new Date(1e3*e.appointmentTimestamp.seconds).toLocaleString():e.checkInTimestamp&&(i=new Date(1e3*e.checkInTimestamp.seconds).toLocaleString()),o+=`<div><strong class="font-semibold text-gray-700">Date:</strong> ${i}</div>`,o+=`<div><strong class="font-semibold text-gray-700">Services:</strong> ${Array.isArray(e.services)?e.services.join(", "):e.services||"N/A"}</div>`,o+=`<div><strong class="font-semibold text-gray-700">Technician:</strong> ${e.technician||"N/A"}</div>`,o+=`<div><strong class="font-semibold text-gray-700">Booking Type:</strong> ${e.bookingType||"N/A"}</div>`,e.colorCode&&(o+=`<div><strong class="font-semibold text-gray-700">Color Code:</strong> ${e.colorCode}</div>`),e.notes&&(o+=`<div><strong class="font-semibold text-gray-700">Notes:</strong> ${e.notes}</div>`),o+="</div>";const s=allFinishedClients.filter((t=>t.name===e.name&&t.id!==e.id)).sort(((e,t)=>t.checkOutTimestamp.toMillis()-e.checkOutTimestamp.toMillis()))[0];let d="";s&&(d=`<div class="space-y-2"><h4 class="text-lg font-semibold text-gray-800 border-b pb-1">Previous Visit</h4><div><strong class="font-semibold text-gray-700">Date:</strong> ${new Date(1e3*s.checkOutTimestamp.seconds).toLocaleString()}</div><div><strong class="font-semibold text-gray-700">Services:</strong> ${s.services||"N/A"}</div><div><strong class="font-semibold text-gray-700">Color Code:</strong> ${s.colorCode||"N/A"}</div><div><strong class="font-semibold text-gray-700">Technician:</strong> ${s.technician||"N/A"}</div>${s.notes?`<div><strong class="font-semibold text-gray-700">Notes:</strong> ${s.notes}</div>`:""}</div>`);const r=allAppointments.filter((t=>t.name===e.name&&t.appointmentTimestamp.toMillis()>Date.now())).sort(((e,t)=>e.appointmentTimestamp.toMillis()-t.appointmentTimestamp.toMillis()))[0];let l=`<div class="space-y-2"><h4 class="text-lg font-semibold text-gray-800 border-b pb-1">Next Appointment</h4><div class="font-bold text-pink-600">${r?new Date(1e3*r.appointmentTimestamp.seconds).toLocaleString():"Not scheduled"}</div></div>`;n.innerHTML=`<div class="space-y-2"><h4 class="text-lg font-semibold text-gray-800 border-b pb-1">Client Details</h4><div><strong class="font-semibold text-gray-700">Name:</strong> ${e.name||"N/A"}</div><div><strong class="font-semibold text-gray-700">Phone:</strong> ${e.phone||"N/A"}</div><div><strong class="font-semibold text-gray-700">Group Size:</strong> ${e.people||"1"}</div></div>${o}${d}${l}`,a.innerHTML='<button type="button" id="view-detail-close-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Close</button>',e.appointmentTimestamp&&"waiting"!==e.status&&"processing"!==e.status&&a.insertAdjacentHTML("afterbegin",`<button type="button" data-id="${e.id}" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg booking-action-btn" data-action="edit">Edit</button>\n             <button type="button" data-id="${e.id}" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg booking-action-btn" data-action="checkin">Check In</button>\n             <button type="button" data-id="${e.id}" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg booking-action-btn" data-action="cancel">No Show</button>`),document.getElementById("view-detail-close-btn").addEventListener("click",Ut),V.classList.remove("hidden"),V.classList.add("flex")},Ut=()=>{V.classList.add("hidden"),V.classList.remove("flex")};document.getElementById("view-detail-close-btn").addEventListener("click",Ut),document.querySelector(".view-detail-modal-overlay").addEventListener("click",Ut),document.getElementById("view-detail-actions").addEventListener("click",(async e=>{if(e.target.classList.contains("booking-action-btn")){const t=e.target.dataset.action,n=e.target.dataset.id,a=allAppointments.find((e=>e.id===n));if(!a)return;"cancel"===t?mt("Are you sure you want to cancel this booking?",(async()=>{await deleteDoc(doc(db,"appointments",n))})):"checkin"===t?(await addDoc(collection(db,"active_queue"),{name:a.name,phone:a.phone,people:a.people||1,bookingType:"Booked - Calendar",services:Array.isArray(a.services)?a.services:[a.services],technician:a.technician,notes:a.notes||"",checkInTimestamp:serverTimestamp(),status:"waiting"}),await deleteDoc(doc(db,"appointments",n))):"edit"===t&&openAddAppointmentModal(null,null,a),Ut()}}));const Ot=async e=>{const t=allClients.find((t=>t.id===e.id));if(!t)return console.error("Could not find data for client:",e.id),void alert("Could not load client profile.");const n=allFinishedClients.filter((e=>e.name===t.name)),a=allAppointments.filter((e=>e.name===t.name&&e.appointmentTimestamp.toDate()>new Date));let o=n.reduce(((e,t)=>e+((Array.isArray(t.services)?t.services.join(", "):t.services).match(/\$\d+/g)||[]).map((e=>Number(e.slice(1)))).reduce(((e,t)=>e+t),0)),0);let i=Qe.filter((t=>t.createdBy===e.id)).reduce(((e,t)=>e+t.amount),0),s=0;if(t.membership&&t.membership.tierId){const e=allMembershipTiers.find((e=>e.id===t.membership.tierId));e&&(s=e.price)}const d=o+i+s;document.getElementById("note-client-id").value=t.id||"",document.getElementById("profile-client-name").textContent=t.name,document.getElementById("profile-client-phone").textContent=t.phone||"No phone number",document.getElementById("profile-total-visits").textContent=n.length,document.getElementById("profile-total-spent").textContent=`$${d.toFixed(2)}`;const r=We.find((t=>t.id===e.id))||{};document.getElementById("profile-fav-tech").textContent=r.favoriteTech||"N/A",document.getElementById("profile-fav-color").textContent=r.favoriteColor||"N/A";document.getElementById("profile-history-table-body").innerHTML=n.length>0?n.map((e=>`<tr>\n            <td class="px-4 py-2">${e.checkOutTimestamp.toDate().toLocaleDateString()}</td>\n            <td class="px-4 py-2">${Array.isArray(e.services)?e.services.join(", "):e.services}</td>\n            <td class="px-4 py-2">${e.technician}</td>\n        </tr>`)).join(""):'<tr><td colspan="3" class="text-center p-4 text-gray-500">No visit history found.</td></tr>';document.getElementById("profile-upcoming-appts").innerHTML=a.length>0?a.map((e=>`<div class="bg-blue-50 p-2 rounded-md"><p class="font-semibold">${e.appointmentTimestamp.toDate().toLocaleString()}</p><p class="text-sm">${e.services.join(", ")}</p></div>`)).join(""):'<p class="text-sm text-gray-500">No upcoming appointments.</p>';const l=document.getElementById("profile-client-notes-list");if(l.innerHTML="",t.notes&&t.notes.length>0){t.notes.sort(((e,t)=>t.timestamp.seconds-e.timestamp.seconds)).forEach((e=>{const n=document.createElement("div");n.className="bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-300";const a=t.id?`\n                    <button data-client-id="${t.id}"\n                            data-note-time="${e.timestamp.seconds}"\n                            class="delete-note-btn text-red-500 hover:text-red-700 ml-2 p-1 rounded-full hover:bg-red-50 transition duration-150"\n                            title="Delete Note">\n                        <i class="fas fa-trash-alt text-sm"></i>\n                    </button>\n                  `:"";n.innerHTML=`\n                <p class="text-sm text-gray-800">${e.text}</p>\n                <p class="text-xs text-gray-500 mt-1 text-right">${new Date(1e3*e.timestamp.seconds).toLocaleString()}  ${a}</p>\n            `,l.appendChild(n)}))}else l.innerHTML='<p class="text-sm text-gray-500 text-center">No notes for this client yet.</p>';ye.classList.remove("hidden")};const _t=async e=>{if(!e||!e.id)return void A("error","Cannot open reward tracker: Invalid client data.");const t=document.getElementById("membership-reward-modal");document.getElementById("reward-client-id").value=e.id,document.getElementById("log-cash-spending-form").reset();const n=doc(db,"clients",e.id),a=await getDoc(n);if(!a.exists())return void A("error","Client document not found.");const o=a.data(),i=o.membership?.rewardProgress||0,s=o.membership?.rewardHistory||[],d=membershipRewardSettings.threshold||500,r=s.filter((e=>"reward"===e.type)).reduce(((e,t)=>e+(t.rewardAmount||0)),0),l=s.filter((e=>"spending"===e.type)).reduce(((e,t)=>e+(t.amount||0)),0);document.getElementById("reward-client-name").innerHTML=`\n        ${e.name} \n        \n        <span class="text-base font-normal text-green-600 ml-2 py-1 px-3 bg-green-50 rounded-full shadow-inner">\n            Reward Earned: $${r.toFixed(2)}\n        </span>\n\n        <span class="text-base font-normal text-pink-600 ml-2 py-1 px-3 bg-pink-50 rounded-full shadow-inner">\n            Total Cash Spent: $${l.toFixed(2)}\n        </span>\n    `;const c=Math.min(100,i/d*100);document.getElementById("reward-progress-text").textContent=`$${i.toFixed(2)} / $${d.toFixed(2)}`,document.getElementById("reward-progress-bar").style.width=`${c}%`,function(e,t){const n=document.getElementById(e);n&&(n.innerHTML="",t&&0!==t.length?(t.sort(((e,t)=>t.timestamp.seconds-e.timestamp.seconds)),t.forEach((e=>{const t=document.createElement("div"),a=e.timestamp.toDate().toLocaleDateString();"reward"===e.type?(t.className="p-3 rounded-lg bg-green-100 border-l-4 border-green-500",t.innerHTML=`\n                <div class="flex justify-between items-center">\n                    <span class="font-bold text-green-700">REWARD EARNED</span>\n                    <span class="font-bold text-green-700">-${e.rewardAmount.toFixed(2)} (Threshold Met)</span>\n                </div>\n                <p class="text-xs text-gray-500">${a}</p>`):(t.className="p-3 rounded-lg bg-white border",t.innerHTML=`\n                <div class="flex justify-between items-center">\n                    <span class="font-medium text-gray-700">Cash Payment Logged</span>\n                    <span class="font-medium text-gray-900">+$${e.amount.toFixed(2)}</span>\n                </div>\n                <p class="text-xs text-gray-500">${a}</p>`),n.appendChild(t)}))):n.innerHTML='<p class="text-sm text-gray-500 text-center">No history found.</p>')}("reward-history-container",s),t.classList.remove("hidden"),t.classList.add("flex")};document.getElementById("finished-content").addEventListener("click",(async e=>{const t=e.target.closest(".delete-btn-finished"),n=e.target.closest(".view-feedback-btn"),a=e.target.closest(".draft-sms-btn"),o=e.target.closest(".feature-review-btn"),i=e.target.closest(".view-review-rating");if(i){const e=i.dataset.id,t=allFinishedClients.find((t=>t.id===e));t&&(e=>{e&&e.rating&&(document.getElementById("view-review-modal-title").textContent=`Review from ${e.name}`,document.getElementById("view-review-stars").innerHTML=renderStars(e.rating),document.getElementById("view-review-text").textContent=e.review||"No written review was provided.",pt.classList.remove("hidden"))})(t)}else if(o){const e=o.dataset.id,t=allFinishedClients.find((t=>t.id===e));if(t)try{await updateDoc(doc(db,"finished_clients",e),{isFeatured:!t.isFeatured})}catch(e){console.error("Error toggling feature status:",e)}}else if(t)mt("Are you sure you want to delete this client record?",(async()=>{try{await deleteDoc(doc(db,"finished_clients",t.dataset.id))}catch(e){console.error("Error deleting finished client: ",e),alert("Could not delete finished client.")}}));else if(n){const e=allFinishedClients.find((e=>e.id===n.dataset.id));e&&jt(e,"Booking Detail")}else if(a){const e=allFinishedClients.find((e=>e.id===a.dataset.id));e&&async function(e){const t=document.getElementById("gemini-sms-textarea"),n=document.getElementById("gemini-sms-send-link");t.value="",t.placeholder="Generating message...",n.classList.add("pointer-events-none","opacity-50"),ee.classList.remove("hidden"),ee.classList.add("flex");const a=`Write a single, friendly, and short SMS message to a nail salon client named ${e.name}. Thank them for their recent visit where they received the following services: ${e.services}. Mention that their technician was ${e.technician}. Ask them to come back soon. Keep it concise and professional.`;try{const o={contents:[{role:"user",parts:[{text:a}]}]},i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${firebaseConfig.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),s=await i.json();let d="Sorry, could not generate a message.";s.candidates?.[0]?.content?.parts?.[0]&&(d=s.candidates[0].content.parts[0].text),t.value=d,e.phone&&"N/A"!==e.phone?(n.href=`sms:${e.phone}?body=${encodeURIComponent(d)}`,n.classList.remove("pointer-events-none","opacity-50")):(n.href="#",n.onclick=()=>alert("Client phone number is not available."),n.classList.remove("pointer-events-none","opacity-50"))}catch(e){console.error("Error generating SMS:",e),t.value="Error connecting to the AI service.",n.classList.remove("pointer-events-none","opacity-50")}}(e)}}));const Gt=()=>{W.reset(),he.classList.add("hidden"),Y.classList.add("hidden"),Y.classList.remove("flex");const e=document.querySelectorAll("#checkout-star-rating-container i");e&&e.forEach((e=>e.classList.remove("text-yellow-400")));const t=document.getElementById("checkout-rating-value");t&&(t.value="")};fe.addEventListener("change",(e=>{"other"===e.target.value?he.classList.remove("hidden"):he.classList.add("hidden")}));const Yt=document.getElementById("technician-name-select"),Wt=document.getElementById("technician-name-other");Yt.addEventListener("change",(e=>{"other"===e.target.value?Wt.classList.remove("hidden"):Wt.classList.add("hidden")})),W.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("checkout-client-id").value,n=document.getElementById("checkout-source-collection").value;let a;if("waitlist"===n){const e=allWaitlistEntries.find((e=>e.id===t));a={name:e.clientName,phone:e.clientPhone,people:e.people||1,bookingType:"Waitlist",services:e.services,technician:e.technician,notes:e.notes||"",checkInTimestamp:e.createdAt}}else a=allActiveClients.find((e=>e.id===t));if(a)try{const e=query(collection(db,"clients"),where("name","==",a.name));(await getDocs(e)).empty&&await addDoc(collection(db,"clients"),{name:a.name,phone:a.phone||"",dob:""});const o={...a};o.id&&delete o.id,o.checkOutTimestamp=serverTimestamp(),o.colorCode=document.getElementById("color-code").value||"";let i=document.getElementById("technician-name-select").value;"other"===i&&(i=document.getElementById("technician-name-other").value),o.technician=i;let s=fe.value;if("2w"===s||"3w"===s){const e="2w"===s?14:21;let t=new Date;t.setDate(t.getDate()+e),o.rebook=t.toLocaleString(),await addDoc(collection(db,"appointments"),{name:a.name,phone:a.phone,people:a.people,bookingType:"Rebooked",services:a.services,technician:o.technician,appointmentTimestamp:Timestamp.fromDate(t)})}else if("other"===s){const e=document.getElementById("rebook-other-input").value;e?(o.rebook=new Date(e).toLocaleString(),await addDoc(collection(db,"appointments"),{name:a.name,phone:a.phone,people:a.people,bookingType:"Rebooked",services:a.services,technician:o.technician,appointmentTimestamp:Timestamp.fromDate(new Date(e))})):o.rebook="Other"}else o.rebook="No";const d=parseInt(document.getElementById("checkout-rating-value").value,10)||null,r=document.getElementById("checkout-review-text").value.trim()||"";o.rating=d,o.review=r,o.isFeatured=!1,await addDoc(collection(db,"finished_clients"),o),"waitlist"===n?await deleteDoc(doc(db,"waitlist",t)):await deleteDoc(doc(db,"active_queue",t)),Gt(),A("success",`${a.name} has been checked out.`)}catch(e){console.error("Error checking out client: ",e),A("error","Could not check out client.")}else A("error","Could not find the client data to check out.")})),document.getElementById("checkout-cancel-btn").addEventListener("click",Gt),document.querySelector(".checkout-modal-overlay").addEventListener("click",Gt);onSnapshot(query(collection(db,"active_queue"),orderBy("checkInTimestamp","asc")),(e=>{allActiveClients=e.docs.map((e=>({id:e.id,checkInTime:e.data().checkInTimestamp?new Date(1e3*e.data().checkInTimestamp.seconds).toLocaleString():"Pending...",services:(e.data().services||[]).join(", "),...e.data()})));const t=allActiveClients.filter((e=>"waiting"===e.status)),n=allActiveClients.filter((e=>"processing"===e.status));be.textContent=t.length,Ie.textContent=n.length,Lt(Bt(t,document.getElementById("search-active").value.toLowerCase(),$e,null)),kt(Bt(n,document.getElementById("search-processing").value.toLowerCase(),De,null)),T()})),onSnapshot(query(collection(db,"finished_clients"),orderBy("checkOutTimestamp","desc")),(e=>{allFinishedClients=e.docs.map((e=>({id:e.id,checkInTime:e.data().checkInTimestamp?new Date(1e3*e.data().checkInTimestamp.seconds).toLocaleString():"N/A",checkOutTimestamp:e.data().checkOutTimestamp,services:(e.data().services||[]).join(", "),...e.data()}))),ve.textContent=allFinishedClients.length,Ct(Bt(allFinishedClients,document.getElementById("search-finished").value.toLowerCase(),Se,Te)),Dt();const t=document.getElementById("client-names-list"),n=document.getElementById("checkin-client-names"),a=document.getElementById("appointment-client-phones"),o=document.getElementById("checkin-client-phones"),i=[...new Set(allFinishedClients.map((e=>e.name)))],s=[...new Set(allFinishedClients.filter((e=>e.phone&&"N/A"!==e.phone)).map((e=>e.phone)))],d=i.map((e=>`<option value="${e}"></option>`)).join(""),r=s.map((e=>`<option value="${e}"></option>`)).join("");t&&(t.innerHTML=d),n&&(n.innerHTML=d),a&&(a.innerHTML=r),o&&(o.innerHTML=r),ft()})),onSnapshot(query(collection(db,"appointments"),orderBy("appointmentTimestamp","asc")),(e=>{e.docChanges().forEach((e=>{if("added"===e.type&&initialAppointmentsLoaded){const t=e.doc.data();if(t.appointmentTimestamp.seconds>C.seconds){const e=new Date(1e3*t.appointmentTimestamp.seconds).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n=Array.isArray(t.services)?t.services[0]:t.services;A("booking",`New booking from ${t.name} for ${n} at ${e}`)}}})),allAppointments=e.docs.map((e=>({id:e.id,appointmentTime:e.data().appointmentTimestamp?new Date(1e3*e.data().appointmentTimestamp.seconds).toLocaleString():"N/A",...e.data()}))),Xt(ke,Le,Ce),En(),ft(),T(),initialAppointmentsLoaded||(initialAppointmentsLoaded=!0)})),onSnapshot(query(collection(db,"earnings"),orderBy("date","desc")),(e=>{if(Ve=e.docs.map((e=>({id:e.id,...e.data()}))),"admin"===currentUserRole){const t=new Set;e.docChanges().forEach((e=>{const n=cn(e.doc.data().date.toDate());t.add(n)})),t.forEach((e=>(async e=>{const t=new Date(e+"T00:00:00"),n=Timestamp.fromDate(t),a=Timestamp.fromDate(new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999)),o=query(collection(db,"earnings"),where("date",">=",n),where("date","<=",a)),i=await getDocs(o),s={};techniciansAndStaff.forEach((e=>{s[e.name]=0})),i.forEach((e=>{const t=e.data();s[t.staffName]=(s[t.staffName]||0)+t.earning}));const d={};Object.keys(s).forEach((e=>{d[e.toLowerCase()]=s[e]})),d.date=Timestamp.fromDate(t);const r=doc(db,"salon_earnings",e);await setDoc(r,d,{merge:!0})})(e)))}Mt(),ft()})),onSnapshot(query(collection(db,"salon_earnings"),orderBy("date","desc")),(e=>{Xe=e.docs.map((e=>({id:e.id,...e.data()}))),Nt(At(Xe,Oe,_e)),ft()})),onSnapshot(query(collection(db,"expenses"),orderBy("date","desc")),(e=>{ze=e.docs.map((e=>({id:e.id,...e.data()}))),function(){const e=[...new Set(ze.map((e=>{const t=new Date(1e3*e.date.seconds);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`})))].sort().reverse();Xn.innerHTML='<option value="all">All Months</option>',e.forEach((e=>{const[t,n]=e.split("-");Xn.innerHTML+=`<option value="${e}">${new Date(t,n-1,1).toLocaleString("default",{month:"long",year:"numeric"})}</option>`})),Xn.value=Ge||"all"}(),Kn()})),onSnapshot(query(collection(db,"clients"),orderBy("name")),(e=>{allClients=e.docs.map((e=>({id:e.id,...e.data()}))),Dt()})),document.getElementById("search-active").addEventListener("input",(e=>{Lt(Bt(allActiveClients.filter((e=>"waiting"===e.status)),e.target.value.toLowerCase(),$e,null))})),document.getElementById("search-processing").addEventListener("input",(e=>{kt(Bt(allActiveClients.filter((e=>"processing"===e.status)),e.target.value.toLowerCase(),De,null))})),document.getElementById("search-finished").addEventListener("input",(e=>{Ct(Bt(allFinishedClients,e.target.value.toLowerCase(),Se,Te))})),document.getElementById("finished-date-filter").addEventListener("input",(e=>{Te=e.target.value,Ct(Bt(allFinishedClients,document.getElementById("search-finished").value.toLowerCase(),Se,Te))})),document.getElementById("search-clients-list").addEventListener("input",(()=>Dt())),document.getElementById("search-gift-cards").addEventListener("input",(e=>{const t=e.target.value.toLowerCase(),n=Qe.filter((e=>e.code.toLowerCase().includes(t)||e.recipientName.toLowerCase().includes(t)));$a(n)})),document.getElementById("search-gift-cards").addEventListener("input",(e=>{const t=e.target.value.toLowerCase(),n=Qe.filter((e=>e.code.toLowerCase().includes(t)||e.recipientName.toLowerCase().includes(t)));$a(n)})),document.getElementById("export-clients-btn").addEventListener("click",(()=>{const e=We.map((e=>({Name:e.name,Phone:e.phone||"",Email:e.email||"",DOB:e.dob||"","Favorite Tech":e.favoriteTech||"","Favorite Color":e.favoriteColor||"","Last Visit":e.lastVisit?new Date(e.lastVisit).toLocaleDateString():""}))),t=XLSX.utils.json_to_sheet(e),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,t,"Clients"),XLSX.writeFile(n,"clients_list.xlsx")})),document.getElementById("full-name").addEventListener("input",(e=>{const t=allFinishedClients.find((t=>t.name===e.target.value));t&&(document.getElementById("phone-number").value=t.phone)})),document.getElementById("phone-number").addEventListener("input",(e=>{const t=allFinishedClients.find((t=>t.phone===e.target.value));t&&(document.getElementById("full-name").value=t.name)})),document.getElementById("main-tabs").addEventListener("click",(e=>{const t=e.target.closest("button");t&&(document.querySelectorAll("#main-tabs .tab-btn").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.querySelectorAll(".tab-content").forEach((e=>e.classList.add("hidden"))),document.getElementById(t.id.replace("-tab","-content")).classList.remove("hidden"))}));const Vt=(e,t)=>{document.getElementById(e).addEventListener("click",(n=>{const a=n.target.closest("button");if(!a)return;document.querySelectorAll(`#${e} .sub-tab-btn`).forEach((e=>e.classList.remove("active"))),a.classList.add("active"),document.querySelectorAll(`.${t}`).forEach((e=>e.classList.add("hidden")));const o=document.getElementById(a.id.replace("-tab","-content"));if(o&&o.classList.remove("hidden"),"reports-sub-tabs"===e)switch(a.id){case"salon-earning-report-tab":Nt(At(Xe,Oe,_e));break;case"staff-earning-report-tab":Mt()}}))};function Xt(e,t,n="All"){Be.textContent=`${new Date(e,t).toLocaleString("default",{month:"long"})} ${e}`,we.innerHTML="";const a=new Date;for(let n=0;n<new Date(e,t,1).getDay();n++)we.insertAdjacentHTML("beforeend","<div></div>");for(let n=1;n<=new Date(e,t+1,0).getDate();n++){const o=document.createElement("div"),i=`${e}-${String(t+1).padStart(2,"0")}-${String(n).padStart(2,"0")}`;o.className="calendar-day border p-2",n===a.getDate()&&t===a.getMonth()&&e===a.getFullYear()&&o.classList.add("is-today"),holidaySettings.dates.includes(i)&&o.classList.add("is-holiday"),o.dataset.date=i,o.innerHTML=`<div class="font-bold">${n}</div><div id="day-${n}" class="appointments"></div>`,we.appendChild(o)}let o=allAppointments.filter((n=>{const a=n.appointmentTimestamp.toDate();return a.getFullYear()===e&&a.getMonth()===t}));"All"!==n&&"Any Technician"!==n?o=o.filter((e=>e.technician===n)):"Any Technician"===n&&(o=o.filter((e=>"Any Technician"===e.technician))),o.sort(((e,t)=>e.appointmentTimestamp.seconds-t.appointmentTimestamp.seconds)),o.forEach((e=>{const t=e.appointmentTimestamp.toDate(),n=document.getElementById(`day-${t.getDate()}`);if(n){const a=t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0}),o=Array.isArray(e.services)?e.services[0]:e.services,i=e.technician;let s=tt[i]||{card:"bg-gray-100",text:"text-gray-800"};const d=`\n            <div class="appointment-entry ${s.card} p-1" data-id="${e.id}" data-type="appointment">\n                <p class="font-semibold text-xs ${s.text} truncate">${a} - ${e.name}</p>\n                <p class="text-xs text-gray-600 truncate">${o||"Service not specified"}</p>\n            </div>`;n.insertAdjacentHTML("beforeend",d)}})),Ee&&(Ee.textContent=we.querySelectorAll(".appointment-entry").length)}Vt("reports-sub-tabs","sub-tab-content"),Vt("admin-sub-tabs","sub-tab-content"),document.getElementById("prev-month-btn").addEventListener("click",(()=>{Le--,Le<0&&(Le=11,ke--),Xt(ke,Le,Ce)})),document.getElementById("next-month-btn").addEventListener("click",(()=>{Le++,Le>11&&(Le=0,ke++),Xt(ke,Le,Ce)})),we.addEventListener("click",(e=>{const t=e.target.closest(".appointment-entry"),n=e.target.closest(".calendar-day");if(t){const e=allAppointments.find((e=>e.id===t.dataset.id));e&&jt(e,"Booking Detail")}else if(n){if(n.classList.contains("is-holiday"))return void alert(holidaySettings.message||"The salon is closed on this date and cannot be booked.");openAddAppointmentModal(n.dataset.date)}}));const zt=(e,t)=>{document.getElementById(e).addEventListener("click",(n=>{n.target.classList.contains("tech-filter-btn")&&(document.querySelectorAll(`#${e} .tech-filter-btn`).forEach((e=>e.classList.remove("active"))),n.target.classList.add("active"),t(n.target.dataset.tech))}))};zt("tech-filter-container-active",(e=>{$e=e,Lt(Bt(allActiveClients.filter((e=>"waiting"===e.status)),document.getElementById("search-active").value.toLowerCase(),$e,null))})),zt("tech-filter-container-processing",(e=>{De=e,kt(Bt(allActiveClients.filter((e=>"processing"===e.status)),document.getElementById("search-processing").value.toLowerCase(),De,null))})),zt("tech-filter-container-finished",(e=>{Se=e,Ct(Bt(allFinishedClients,document.getElementById("search-finished").value.toLowerCase(),Se,Te))})),zt("tech-filter-container-calendar",(e=>{Ce=e,document.getElementById("list-view").classList.contains("hidden")?Xt(ke,Le,Ce):En()})),zt("tech-filter-container-earning",(e=>{Me=e,Mt()})),zt("dashboard-tech-filter-container-earning",(e=>{He=e,Mt()})),zt("tech-filter-container-earning",(e=>{Me=e,Mt()})),zt("dashboard-tech-filter-container-earning",(e=>{He=e,Mt()})),zt("tech-filter-container-dashboard-appointments",(e=>{Ye=e,bt()})),o("earning-range-filter","earning-date-filter",((e,t)=>{Ae=e,Ne=t,Mt()})),o("dashboard-earning-range-filter","dashboard-earning-date-filter",((e,t)=>{je=e,Ue=t,Mt()})),o("salon-earning-range-filter","salon-earning-date-filter",((e,t)=>{Oe=e,_e=t,Nt(At(Xe,e,t))})),o("dashboard-range-filter","dashboard-date-filter",((e,t)=>{Re=t,Fe=e,bt()})),o("staff-dashboard-range-filter","staff-dashboard-date-filter",((e,t)=>{Pe=t,qe=e,vt()}));const Jt=String((new Date).getMonth()),Zt=document.getElementById("dashboard-range-filter");Zt&&(Zt.value=Jt);const Kt=document.getElementById("staff-dashboard-range-filter");Kt&&(Kt.value=Jt);const Qt=document.getElementById("dashboard-staff-earning-service"),en=document.getElementById("dashboard-staff-earning-full");Qt&&en&&Qt.addEventListener("change",(e=>{const t=e.target.value,n=allServicesList.find((e=>e.name===t));n&&(en.value=n.price.toFixed(2))}));setInterval((()=>{const e=new Date;allAppointments.forEach((t=>{if(nt.includes(t.id))return;const n=t.appointmentTimestamp.toDate(),a=(n.getTime()-e.getTime())/6e4;if(a>0&&a<=60){const e=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=Array.isArray(t.services)?t.services[0]:t.services;A("reminder",`Reminder: ${t.name}'s appointment for ${a} is at ${e}.`),nt.push(t.id)}}))}),6e4),document.getElementById("staff-earning-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("staff-name").value,n=document.getElementById("staff-earning-service").value,a=parseFloat(document.getElementById("staff-earning").value),o=parseFloat(document.getElementById("staff-tip").value)||0,i=document.getElementById("staff-earning-date").value;if(isNaN(a)||!i)return alert("Please ensure Date, and Earning fields are filled out correctly.");try{await addDoc(collection(db,"earnings"),{staffName:t,service:n,earning:a,tip:o,date:Timestamp.fromDate(new Date(i+"T12:00:00"))}),document.getElementById("staff-earning-service").value="",document.getElementById("staff-earning").value="",document.getElementById("staff-tip").value=""}catch(e){console.error("Error adding earning: ",e),alert("Could not add earning.")}})),document.getElementById("dashboard-staff-earning-form-full").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("dashboard-staff-name-full").value,n=document.getElementById("dashboard-staff-earning-service").value,a=parseFloat(document.getElementById("dashboard-staff-earning-full").value),o=parseFloat(document.getElementById("dashboard-staff-tip-full").value)||0,i=document.getElementById("dashboard-staff-earning-date-full").value;if(isNaN(a)||!i)return alert("Please make sure the Date and Earning fields are filled out correctly.");const s=new Date(i+"T12:00:00");try{await addDoc(collection(db,"earnings"),{staffName:t,service:n,earning:a,tip:o,date:Timestamp.fromDate(s)}),document.getElementById("dashboard-staff-earning-service").value="",document.getElementById("dashboard-staff-earning-full").value="",document.getElementById("dashboard-staff-tip-full").value=""}catch(e){console.error("Error saving earning entry: ",e),alert("Could not save the earning entry.")}})),document.getElementById("staff-earning-table").addEventListener("click",(async e=>{const t=e.target.closest(".delete-earning-btn"),n=e.target.closest(".edit-earning-btn");if(t)mt("Delete this earning entry?",(async()=>{await deleteDoc(doc(db,"earnings",t.dataset.id))}));else if(n){const e=Ve.find((e=>e.id===n.dataset.id));e&&fn(e)}})),document.getElementById("dashboard-staff-earning-table-full").addEventListener("click",(async e=>{const t=e.target.closest(".delete-earning-btn"),n=e.target.closest(".edit-earning-btn");if(t)mt("Delete this earning entry?",(async()=>{await deleteDoc(doc(db,"earnings",t.dataset.id))}));else if(n){const e=Ve.find((e=>e.id===n.dataset.id));e&&fn(e)}})),document.getElementById("salon-earning-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("salon-earning-date").value;if(!t)return alert("Please select a date.");const n={date:Timestamp.fromDate(new Date(t+"T12:00:00")),sellGiftCard:parseFloat(document.getElementById("sell-gift-card").value)||0,returnGiftCard:parseFloat(document.getElementById("return-gift-card").value)||0,check:parseFloat(document.getElementById("check-payment").value)||0,noOfCredit:parseInt(document.getElementById("no-of-credit").value)||0,totalCredit:parseFloat(document.getElementById("total-credit").value)||0,venmo:parseFloat(document.getElementById("venmo-payment").value)||0,square:parseFloat(document.getElementById("square-payment").value)||0};techniciansAndStaff.forEach((e=>{const t=document.getElementById(`salon-earning-${e.name.toLowerCase()}`);t&&(n[e.name.toLowerCase()]=parseFloat(t.value)||0)}));try{await setDoc(doc(db,"salon_earnings",t),n,{merge:!0}),e.target.reset(),document.getElementById("salon-earning-date").value=cn()}catch(e){console.error("Error adding salon earning: ",e),alert("Could not add salon earning.")}})),document.getElementById("salon-earning-table").addEventListener("click",(async e=>{const t=e.target.closest(".delete-salon-earning-btn"),n=e.target.closest(".edit-salon-earning-btn");if(t)mt("Delete this salon earning entry?",(async()=>{await deleteDoc(doc(db,"salon_earnings",t.dataset.id))}));else if(n){const e=Xe.find((e=>e.id===n.dataset.id));e&&vn(e)}})),document.getElementById("export-salon-earnings-btn").addEventListener("click",(()=>{const e=At(Xe,Oe,_e),t=e.map((e=>{let t={Date:new Date(1e3*e.date.seconds).toLocaleDateString()},n=0;techniciansAndStaff.forEach((a=>{const o=e[a.name.toLowerCase()]||0;t[a.name]=o,n+=o})),n+=e.sellGiftCard||0;const a=n-((e.totalCredit||0)+(e.check||0)+(e.returnGiftCard||0)+(e.venmo||0)+(e.square||0));return t["Sell GC"]=e.sellGiftCard||0,t["Return GC"]=e.returnGiftCard||0,t.Check=e.check||0,t["# Credit"]=e.noOfCredit||0,t["Total Credit"]=e.totalCredit||0,t.Venmo=e.venmo||0,t.Square=e.square||0,t.Total=n,t.Cash=a,t}));if(e.length>0){let n={Date:"Total:"},a=0;techniciansAndStaff.forEach((t=>{const o=e.reduce(((e,n)=>e+(n[t.name.toLowerCase()]||0)),0);n[t.name]=o,a+=o}));["sellGiftCard","returnGiftCard","check","noOfCredit","totalCredit","venmo","square"].forEach((t=>{n[t]=e.reduce(((e,n)=>e+(n[t]||0)),0)})),a+=n.sellGiftCard,n.total=a,n.cash=a-(n.totalCredit+n.check+n.returnGiftCard+n.venmo+n.square),t.push({},n);const o={Date:"Commission 70%:"},i={Date:"70% of Check:"},s={Date:"30% of Cash:"};techniciansAndStaff.forEach((e=>{const t=n[e.name]||0,a=techniciansAndStaff.find((t=>t.name===e.name)),d=t*((a&&a.commissionRate?a.commissionRate:70)/100),r=.7*d,l=d-r;o[e.name]=d,i[e.name]=r,s[e.name]=l})),t.push(o,i,s)}const n=XLSX.utils.json_to_sheet(t),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,n,"Salon Earnings"),XLSX.writeFile(a,"Salon_Earning_Report.xlsx")}));const tn=document.getElementById("import-salon-earnings-btn"),nn=document.getElementById("import-salon-earnings-input");tn.addEventListener("click",(()=>{nn.click()})),nn.addEventListener("change",(e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async t=>{try{const e=new Uint8Array(t.target.result),n=XLSX.read(e,{type:"array",cellDates:!0}),a=n.Sheets[n.SheetNames[0]],o=XLSX.utils.sheet_to_json(a);if(0===o.length)return void alert("No data found in the Excel file.");const i=writeBatch(db);let s=0;for(const e of o){if(!(e.Date&&e.Date instanceof Date)){console.warn("Skipping row due to invalid or missing date:",e);continue}const t=e.Date,n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,a={date:Timestamp.fromDate(t),sellGiftCard:parseFloat(e["Sell GC"])||0,returnGiftCard:parseFloat(e["Return GC"])||0,check:parseFloat(e.Check)||0,noOfCredit:parseInt(e["No of Credit"])||0,totalCredit:parseFloat(e["Total Credit"])||0,venmo:parseFloat(e.Venmo)||0,square:parseFloat(e.Square)||0};techniciansAndStaff.forEach((t=>{const n=t.name;void 0===e[n]||isNaN(parseFloat(e[n]))||(a[n.toLowerCase()]=parseFloat(e[n]))}));const o=doc(db,"salon_earnings",n);i.set(o,a,{merge:!0}),s++}await i.commit(),alert(`${s} records imported successfully! The data will now appear in your report.`)}catch(e){console.error("Error importing salon earnings:",e),alert("An error occurred during the import. Please check the console for details and ensure your file format is correct.")}finally{e.target.value=""}},n.readAsArrayBuffer(t)}));const an=document.getElementById("membership-card-designer-form"),on=document.getElementById("designer-ms-tier-select"),sn=document.getElementById("ms-card-preview-front"),dn=(document.getElementById("ms-card-preview-back"),document.getElementById("ms-back-signature-name")),rn=document.getElementById("designer-ms-start-date"),ln=document.getElementById("designer-ms-no-start-date"),cn=()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},mn=()=>{const e=on.options[on.selectedIndex],t=e&&e.dataset.name?e.dataset.name:"Select Tier",n=document.getElementById("designer-ms-client-name").value.trim(),a=n||"&nbsp;",o=ln.checked;let i,s=rn.value;i=o||!s?"...../...../.....":new Date(s+"T00:00:00").toLocaleDateString();const d=document.getElementById("designer-ms-id").value.trim()||"................";dn.textContent=n||"",n?dn.style.minHeight="0":(dn.style.minHeight="24px",dn.style.display="block");let r="from-gray-700 via-gray-900 to-black";t.toLowerCase().includes("silver")&&(r="from-gray-400 via-gray-500 to-gray-600"),t.toLowerCase().includes("gold")&&(r="from-yellow-400 via-yellow-500 to-yellow-600"),t.toLowerCase().includes("platinum")&&(r="from-indigo-500 via-purple-600 to-pink-600"),sn.className=`card rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br ${r} text-white`,sn.style.width="400px",sn.style.height="228px",sn.style.textShadow="1px 1px 3px rgba(0,0,0,0.4)",sn.innerHTML=`\n        <div class="flex justify-between items-start">\n            <div class="font-bold text-lg"><p>${t}</p><p class="text-xs font-normal opacity-80">MEMBERSHIP</p></div>\n            <p class="font-parisienne text-3xl">Nails Express</p>\n        </div>\n        <div class="flex justify-between items-end">\n            <div class="text-left"><p class="text-xs opacity-80">MEMBER</p><p class="text-2xl font-semibold tracking-wider">${a}</p></div>\n            <div class="text-right text-xs opacity-80">\n                <p>Member Since: ${i}</p>\n                <p>Member ID: ${d}</p>\n            </div>\n        </div>\n    `};an.addEventListener("input",mn),ln.addEventListener("change",(()=>{const e=ln.checked;rn.disabled=e,rn.required=!e,e?rn.value="":rn.value||(rn.value=cn()),mn()})),document.getElementById("generate-print-ms-cards-btn").addEventListener("click",(async()=>{const e=parseInt(document.getElementById("designer-ms-quantity").value,10),t=document.getElementById("designer-ms-client-name").value.trim(),n=document.getElementById("designer-ms-tier-select").value,a=document.getElementById("designer-ms-id").value.trim(),o=ln.checked,i=rn.value;if(!o&&!i)return void A("error","Please select a Start Date or check 'Write Later'.");if(isNaN(e)||e<1||!n)return void A("error","Please fill in Membership Tier and Quantity.");const s=allMembershipTiers.find((e=>e.id===n));if(!s)return void A("error","Selected tier not found.");let d;d=o||!i?"...../...../.....":new Date(i+"T00:00:00").toLocaleDateString();const r=t||"&nbsp;",l=1===e&&a?a:"................";let c="\n        <html>\n        <head>\n            <title>Print Membership Cards</title>\n            <style>\n                /* Reuse your existing print styles here */\n                @media print {\n                    @page { size: A4 landscape; margin: 10mm; }\n                    body { font-family: 'Poppins', sans-serif; }\n                    .print-page { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }\n                    .card-container { width: 420px; height: 260px; break-inside: avoid; display: flex; flex-direction: column; gap: 4px; }\n                    .card { width: 400px; height: 228px; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; padding: 16px; box-sizing: border-box; font-size: 14px; position: relative; }\n                    .bg-gradient-to-br { background: linear-gradient(to bottom right, #333, #111); }\n                    .text-white { color: white; }\n                    .text-gray-800 { color: #1f2937; }\n                    .font-parisienne { font-family: 'Parisienne', cursive; }\n                }\n            </style>\n        </head>\n        <body>\n        <div class=\"print-page\">\n    ";for(let n=0;n<e;n++){let e="from-gray-700 via-gray-900 to-black";s.name.toLowerCase().includes("silver")&&(e="from-gray-400 via-gray-500 to-gray-600"),s.name.toLowerCase().includes("gold")&&(e="from-yellow-400 via-yellow-500 to-yellow-600"),s.name.toLowerCase().includes("platinum")&&(e="from-indigo-500 via-purple-600 to-pink-600");const n=t||'<span style="font-size: 0.1px;">.</span>',a=t?"":'style="padding-top: 10px;"';c+=`\n            <div class="card-container">\n                <div class="card rounded-lg p-4 flex flex-col justify-between bg-gradient-to-br ${e} text-white">\n                     <div class="flex justify-between items-start">\n                        <div class="font-bold text-lg"><p>${s.name}</p><p class="text-xs font-normal opacity-80">MEMBERSHIP</p></div>\n                        <p class="font-parisienne text-3xl">Nails Express</p>\n                    </div>\n                    <div class="flex justify-between items-end">\n                        <div class="text-left"><p class="text-xs opacity-80">MEMBER</p><p class="text-2xl font-semibold tracking-wider">${r}</p></div>\n                        <div class="text-right text-xs opacity-80">\n                            <p>Member Since: ${d}</p>\n                            <p>Member ID: ${l}</p>\n                        </div>\n                    </div>\n                </div>\n                <div class="card rounded-lg p-4 flex flex-col justify-between bg-white text-gray-800 border" style="text-shadow: none;">\n                    <div class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n                    <p>\n                        Welcome, VIP! This card must be presented to receive benefits. Membership is non-transferable.\n                    </p>\n                    <p class="font-bold mt-2">\n                        Clients must pay with cash only to earn credit towards their cash reward.\n                    </p>\n                </div>\n                    <div class="px-4 pb-2 text-center" ${a}>\n                        <p class="font-parisienne text-2xl text-gray-700">${n}</p> \n                        <div class="w-full border-t border-dashed border-gray-400 pt-1 mt-1"></div>\n                        <p class="text-xs text-gray-500">Member Signature</p>\n                    </div>\n                    <div class="text-center text-xs pb-2">\n                        <p class="font-bold">Nails Express</p>\n                        <p>1560 Hustonville Rd #345, Danville, KY 40422</p>\n                    </div>\n                </div>\n            </div>\n        `}c+="</div></body></html>",1===e&&a&&t&&document.getElementById("designer-client-id").value;const m=window.open("","_blank");m.document.write(c),m.document.close(),m.focus(),setTimeout((()=>{m.print(),m.close()}),500)})),document.getElementById("membership-management-tab").addEventListener("click",(()=>{an.reset(),rn.value=cn(),ln.checked=!1,rn.disabled=!1,document.getElementById("designer-ms-quantity").value=1,on.innerHTML='<option value="">Select Tier...</option>',void 0!==allMembershipTiers&&allMembershipTiers.length>0&&allMembershipTiers.forEach((e=>{on.innerHTML+=`<option value="${e.id}" data-name="${e.name}" data-price="${e.price}" data-discount="${e.discount}">${e.name}</option>`})),mn()}));const un=async(e,t)=>{const n=document.getElementById(e);if(!n)return console.error(`Element with ID ${e} not found for download.`),void A("error","Download failed: Preview card element not found.");try{const e=document.createElement("div");e.style.position="absolute",e.style.left="-9999px",e.style.width="400px",e.style.height="228px";const a=n.cloneNode(!0);"none"===a.style.display&&(a.style.display="block"),e.appendChild(a),document.body.appendChild(e);const o=await html2canvas(a,{scale:3,logging:!1,useCORS:!0});document.body.removeChild(e);const i=o.toDataURL("image/png"),s=document.createElement("a");s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),A("info",`${t} download initiated.`)}catch(e){console.error(`Error generating image for ${t}:`,e),A("error",`Failed to download ${t}. Check console for details.`)}},pn=async()=>{const e=document.getElementById("designer-ms-name")?.value||"Client",t=document.getElementById("designer-ms-id")?.value||"MEM-XXXXX",n=document.getElementById("designer-ms-tier-select"),a=`${(n?.options[n.selectedIndex]?.dataset.name||"Membership").replace(/\s/g,"_")}_${e.replace(/\s/g,"_")}_${t}`;A("info","Starting Membership Card image download..."),await un("ms-card-preview-front",`${a}_FRONT.png`),await new Promise((e=>setTimeout(e,500))),await un("ms-card-preview-back",`${a}_BACK.png`),A("success","Membership Card downloads complete.")},gn=document.getElementById("download-ms-card-images-btn");gn&&gn.addEventListener("click",pn);const yn=async()=>{const e=document.getElementById("designer-gc-recipient")?.value||"Recipient",t=`GiftCard_Value${document.getElementById("designer-gc-amount")?.value||"0"}_${e.replace(/\s/g,"_")}`;A("info","Starting Gift Card image download..."),await un("printable-gift-card",`${t}_FRONT.png`),await new Promise((e=>setTimeout(e,500))),await un("gc-card-preview-back",`${t}_BACK.png`),A("success","Gift Card downloads complete.")},hn=document.getElementById("download-gc-images-btn");hn&&hn.addEventListener("click",yn),document.getElementById("print-salon-earnings-btn").addEventListener("click",(()=>{const e=document.getElementById("salon-earning-table");if(!e)return;const t=document.createElement("table");t.className=e.className;const n=techniciansAndStaff.map((e=>e.name)),a=e.querySelector("thead"),o=a.cloneNode(!0),i=o.querySelector("tr");i.innerHTML="",i.insertAdjacentHTML("beforeend",'<th scope="col" class="px-2 py-1">Date</th>'),n.forEach((e=>{i.insertAdjacentHTML("beforeend",`<th scope="col" class="px-2 py-1">${e}</th>`)})),t.appendChild(o);const s=e.querySelector("tbody"),d=document.createElement("tbody");s.querySelectorAll("tr").forEach((e=>{const t=d.insertRow();t.appendChild(e.cells[0].cloneNode(!0)),n.forEach((n=>{const o=Array.from(a.querySelectorAll("th")).findIndex((e=>e.textContent===n));o>-1&&t.appendChild(e.cells[o].cloneNode(!0))}))})),t.appendChild(d);const r=e.querySelector("tfoot").cloneNode(!0);r.querySelectorAll("tr").forEach(((e,t)=>{if(t>0){for(e.querySelector("td").colSpan=1;e.cells.length>n.length+1;)e.deleteCell(-1)}else for(;e.cells.length>n.length+1;)e.deleteCell(-1)})),t.appendChild(r);const l=new Date,c=`Printed on: ${l.toLocaleDateString()} at ${l.toLocaleTimeString()}`,m=window.open("","_blank","height=800,width=1000");m.document.write("<html><head><title>Print Staff Earnings</title>"),m.document.write('<script src="https://cdn.tailwindcss.com"><\/script>'),m.document.write("\n            <style> \n                body { padding: 15px; font-family: sans-serif; } \n                table { width: 100%; border-collapse: collapse; font-size: 10px; } \n                th, td { border: 1px solid #ddd; padding: 2px 4px; text-align: left; } \n                thead { background-color: #f2f2f2; } \n                tfoot { font-weight: bold; }\n                @media print { \n                    body { -webkit-print-color-adjust: exact; padding: 10px; } \n                    h1 { font-size: 1.25rem; }\n                    p { font-size: 0.75rem; }\n                } \n            </style>\n        "),m.document.write("</head><body>"),m.document.write(`\n            <div class="flex justify-between items-center mb-4 border-b pb-2">\n                <div>\n                    <h1 class="text-xl font-bold mb-1">Staff Earning Report</h1>\n                    <p class="text-xs text-gray-500">${c}</p>\n                </div>\n                <img src="https://placehold.co/100x100/d63384/FFFFFF?text=NE" alt="Salon Logo" class="h-12 w-12 rounded-full">\n            </div>\n        `),m.document.write(t.outerHTML),m.document.write("</body></html>"),m.document.close(),m.focus(),setTimeout((()=>{m.print(),m.close()}),500)}));const fn=e=>{z.reset(),document.getElementById("edit-earning-id").value=e.id,document.getElementById("edit-staff-earning-date").value=new Date(1e3*e.date.seconds).toISOString().split("T")[0],document.getElementById("edit-staff-name").value=e.staffName,document.getElementById("edit-staff-earning-service").value=e.service||"",document.getElementById("edit-staff-earning").value=e.earning,document.getElementById("edit-staff-tip").value=e.tip;const t=document.getElementById("edit-staff-earning-services-list");t&&(t.innerHTML=Object.keys(servicesData).flatMap((e=>servicesData[e].map((e=>`<option value="${e.name}"></option>`)))).join("")),X.classList.remove("hidden"),X.classList.add("flex")},bn=()=>{X.classList.add("hidden"),X.classList.remove("flex")};document.getElementById("edit-earning-cancel-btn").addEventListener("click",bn),document.querySelector(".edit-earning-modal-overlay").addEventListener("click",bn),z.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-earning-id").value;if(t)try{await updateDoc(doc(db,"earnings",t),{staffName:document.getElementById("edit-staff-name").value,service:document.getElementById("edit-staff-earning-service").value,earning:parseFloat(document.getElementById("edit-staff-earning").value),tip:parseFloat(document.getElementById("edit-staff-tip").value),date:Timestamp.fromDate(new Date(document.getElementById("edit-staff-earning-date").value+"T12:00:00"))}),bn()}catch(e){console.error("Error updating earning:",e),alert("Could not update earning.")}}));const vn=e=>{Z.reset(),document.getElementById("edit-salon-earning-id").value=e.id,document.getElementById("edit-salon-earning-date").value=new Date(1e3*e.date.seconds).toISOString().split("T")[0];const t=document.getElementById("edit-salon-earning-inputs");t.innerHTML="",techniciansAndStaff.forEach((n=>{const a=n.name.toLowerCase();t.innerHTML+=`<div><label for="edit-${a}-earning" class="block text-sm font-medium text-gray-600">${n.name}</label><input type="number" step="0.01" id="edit-${a}-earning" value="${e[a]||0}" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Amount"></div>`})),document.getElementById("edit-sell-gift-card").value=e.sellGiftCard||0,document.getElementById("edit-return-gift-card").value=e.returnGiftCard||0,document.getElementById("edit-check-payment").value=e.check||0,document.getElementById("edit-no-of-credit").value=e.noOfCredit||0,document.getElementById("edit-total-credit").value=e.totalCredit||0,document.getElementById("edit-venmo-payment").value=e.venmo||0,document.getElementById("edit-square-payment").value=e.square||0,J.classList.remove("hidden"),J.classList.add("flex")},xn=()=>{J.classList.add("hidden"),J.classList.remove("flex")};document.getElementById("edit-salon-earning-cancel-btn").addEventListener("click",xn),document.querySelector(".edit-salon-earning-modal-overlay").addEventListener("click",xn),Z.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-salon-earning-id").value;if(!t)return;const n={date:Timestamp.fromDate(new Date(document.getElementById("edit-salon-earning-date").value+"T12:00:00")),sellGiftCard:parseFloat(document.getElementById("edit-sell-gift-card").value)||0,returnGiftCard:parseFloat(document.getElementById("edit-return-gift-card").value)||0,check:parseFloat(document.getElementById("check-payment").value)||0,noOfCredit:parseInt(document.getElementById("edit-no-of-credit").value)||0,totalCredit:parseFloat(document.getElementById("edit-total-credit").value)||0,venmo:parseFloat(document.getElementById("edit-venmo-payment").value)||0,square:parseFloat(document.getElementById("edit-square-payment").value)||0};techniciansAndStaff.forEach((e=>{const t=document.getElementById(`edit-${e.name.toLowerCase()}-earning`);t&&(n[e.name.toLowerCase()]=parseFloat(t.value)||0)}));try{await updateDoc(doc(db,"salon_earnings",t),n),xn()}catch(e){console.error("Error updating salon earning:",e),alert("Could not update salon earning.")}}));const En=()=>{xe.textContent=allAppointments.filter((e=>e.appointmentTimestamp.toDate()>new Date)).length,xt("today-bookings-table-container",allAppointments,Ce)};document.getElementById("today-btn").addEventListener("click",(()=>{document.getElementById("month-view").classList.add("hidden"),document.getElementById("month-nav").classList.add("hidden"),document.getElementById("list-view").classList.remove("hidden"),document.getElementById("today-btn").classList.add("hidden"),document.getElementById("month-view-btn").classList.remove("hidden"),En()})),document.getElementById("month-view-btn").addEventListener("click",(()=>{document.getElementById("list-view").classList.add("hidden"),document.getElementById("month-view-btn").classList.add("hidden"),document.getElementById("month-view").classList.remove("hidden"),document.getElementById("month-nav").classList.remove("hidden"),document.getElementById("today-btn").classList.remove("hidden")}));const In=document.getElementById("today-bookings-table");In&&In.addEventListener("click",(async e=>{if(e.target.classList.contains("checkin-today-btn")){const t=allAppointments.find((t=>t.id===e.target.dataset.id));if(!t)return;try{await addDoc(collection(db,"active_queue"),{name:t.name,phone:t.phone,people:t.people||1,bookingType:"Booked - Calendar",services:Array.isArray(t.services)?t.services:[t.services],technician:t.technician,notes:t.notes||"",checkInTimestamp:serverTimestamp(),status:"waiting"}),await deleteDoc(doc(db,"appointments",e.target.dataset.id))}catch(e){console.error("Error checking in from today's view:",e),alert("Could not check in this client.")}}}));const wn=document.getElementById("live-clock"),Bn=document.getElementById("live-date"),Ln=document.getElementById("copyright-year"),kn=()=>{const e=new Date;wn.textContent=e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),Bn.textContent=e.toLocaleDateString([],{weekday:"long",year:"numeric",month:"long",day:"numeric"}),Ln.textContent=e.getFullYear()};kn(),setInterval(kn,6e4),document.getElementById("clients-list-report-content").addEventListener("click",(e=>{const t=e.target.closest(".view-client-profile-btn"),n=e.target.closest(".edit-client-btn"),a=e.target.closest(".delete-client-btn");if(t){const e=We.find((e=>e.id===t.dataset.id));e?Ot(e):console.warn("Could not find client data for ID:",t.dataset.id)}else if(n){const e=We.find((e=>e.id===n.dataset.id));e?Fa(e):console.warn("Could not find client data for ID:",n.dataset.id)}else if(a){const e=a.dataset.id,t=We.find((t=>t.id===e));t?mt(`Delete all records for ${t.name}? This cannot be undone.`,(async()=>{try{await deleteDoc(doc(db,"clients",e)),alert(`${t.name} has been deleted.`)}catch(e){console.error("Error deleting client:",e),alert("Could not delete the client.")}})):console.warn("Could not find client data for ID:",e)}})),document.getElementById("gemini-sms-close-btn").addEventListener("click",(()=>{ee.classList.add("hidden"),ee.classList.remove("flex")})),document.querySelector(".gemini-sms-modal-overlay").addEventListener("click",(()=>{ee.classList.add("hidden"),ee.classList.remove("flex")})),document.getElementById("floating-booking-btn").addEventListener("click",(()=>{openAddAppointmentModal(cn())}));const Cn=document.getElementById("staff-details-date-filter");Cn&&Cn.addEventListener("change",vt);const $n=document.getElementById("add-user-form"),Dn=document.querySelector("#users-table tbody");onSnapshot(collection(db,"users"),(e=>{const t=e.docs.map((e=>({id:e.id,...e.data()})));techniciansAndStaff=t.filter((e=>"technician"===e.role||"staff"===e.role)),technicians=t.filter((e=>"technician"===e.role)),tt={},technicians.forEach(((e,t)=>{tt[e.name]=colorPalette[t%colorPalette.length]})),(e=>{Dn.innerHTML="",e.forEach((e=>{const t=Dn.insertRow(),n="commission_plus_tips"===e.payoutType?"Comm. + Tips":"Standard";t.innerHTML=`<td class="px-6 py-4">${e.name}</td><td class="px-6 py-4">${e.email}</td><td class="px-6 py-4">${e.phone}</td><td class="px-6 py-4">${e.role}</td><td class="px-6 py-4">${n}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="edit-user-btn text-blue-500"><i class="fas fa-edit"></i></button><button data-id="${e.id}" class="delete-user-btn text-red-500"><i class="fas fa-trash"></i></button></td>`}))})(t),(()=>{const e=document.querySelectorAll("#appointment-technician-select, #technician-name-select, #staff-name, #edit-staff-name, #checkin-technician-select, #dashboard-staff-name-full"),t=document.querySelectorAll(".tech-filter-container"),n=Object.keys(servicesData).flatMap((e=>servicesData[e].map((e=>`<option value="${e.name}"></option>`)))).join(""),a=document.getElementById("staff-earning-services-list");a&&(a.innerHTML=n);const o=document.getElementById("dashboard-staff-earning-services-list");o&&(o.innerHTML=n),t.forEach((e=>{const t=e.id.includes("earning")?techniciansAndStaff:technicians;e.querySelectorAll(".dynamic-tech-btn").forEach((e=>e.remove())),t.forEach((t=>{const n=document.createElement("button");n.className="tech-filter-btn dynamic-tech-btn px-3 py-1 rounded-full text-sm",n.dataset.tech=t.name,n.textContent=t.name,e.appendChild(n)}))})),e.forEach((e=>{if(!e)return;const t=e.id.includes("staff-name")?techniciansAndStaff:technicians,n=e.options[0];e.innerHTML="",!n||"Any Technician"!==n.value&&""!==n.value||e.appendChild(n),t.forEach((t=>{e.appendChild(new Option(t.name,t.name))})),"technician-name-select"===e.id&&e.appendChild(new Option("Other","other")),"staff-name"!==e.id&&"dashboard-staff-name-full"!==e.id||(e.value="TJ")}));const i=document.getElementById("salon-earning-inputs"),s=document.getElementById("salon-earning-table-head"),d=document.getElementById("salon-earning-table-foot");i.innerHTML="";let r='<tr><th scope="col" class="px-6 py-3">Date</th>',l='<tr><td class="px-6 py-3 text-right font-bold">Total:</td>';techniciansAndStaff.forEach((e=>{const t=e.name.toLowerCase();i.innerHTML+=`<div><label for="salon-earning-${t}" class="block text-sm font-medium text-gray-600">${e.name}</label><input type="number" step="0.01" id="salon-earning-${t}" class="form-input mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Amount"></div>`,r+=`<th scope="col" class="px-6 py-3">${e.name}</th>`,l+=`<td id="total-${t}" class="px-6 py-3"></td>`})),r+='<th scope="col" class="px-6 py-3">Sell GC</th><th scope="col" class="px-6 py-3">Return GC</th><th scope="col" class="px-6 py-3">Check</th><th scope="col" class="px-6 py-3">No of Credit</th><th scope="col" class="px-6 py-3">Total Credit</th><th scope="col" class="px-6 py-3">Venmo</th><th scope="col" class="px-6 py-3">Square</th><th scope="col" class="px-6 py-3 font-bold">Total</th><th scope="col" class="px-6 py-3 font-bold">Cash</th><th scope="col" class="px-6 py-3 text-center">Action</th></tr>',l+='<td id="total-sell-gc" class="px-6 py-3"></td><td id="total-return-gc" class="px-6 py-3"></td><td id="total-check" class="px-6 py-3"></td><td id="total-no-credit" class="px-6 py-3"></td><td id="total-total-credit" class="px-6 py-3"></td><td id="total-venmo" class="px-6 py-3"></td><td id="total-square" class="px-6 py-3"></td><td id="total-total" class="px-6 py-3 font-bold"></td><td id="total-cash" class="px-6 py-3 font-bold"></td><td class="px-6 py-3"></td></tr>';let c='<tr class="text-center"><td class="px-6 py-3 text-right font-bold border-t-2 border-gray-300">Total Payout:</td>',m='<tr class="text-center"><td class="px-6 py-3 text-right font-bold">Check Payout:</td>',u='<tr class="text-center"><td class="px-6 py-3 text-right font-bold">Cash Payout:</td>';techniciansAndStaff.forEach((e=>{const t=e.name.toLowerCase();c+=`<td id="commission-${t}" class="px-6 py-3 border-t-2 border-gray-300"></td>`,m+=`<td id="check70-${t}" class="px-6 py-3"></td>`,u+=`<td id="cash30-${t}" class="px-6 py-3"></td>`})),c+='<td class="border-t-2 border-gray-300" colspan="10"></td></tr>',m+='<td colspan="10"></td></tr>',u+='<td colspan="10"></td></tr>',s.innerHTML=r,d.innerHTML=l+c+m+u})(),"admin"===currentUserRole&&(async e=>{try{const t=e.filter((e=>"technician"===e.role)).map((e=>e.name)),n=doc(db,"public_data","technicians");await setDoc(n,{names:t})}catch(e){console.error("Error updating public technician list:",e)}})(t)})),$n.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-user-id").value,n=document.getElementById("new-user-name").value,a=document.getElementById("new-user-phone").value,o=document.getElementById("new-user-email").value,i=document.getElementById("user-role").value,s=document.getElementById("payout-type").value,d=parseFloat(document.getElementById("new-user-commission").value),r=document.getElementById("new-user-uid").value;if(isNaN(d)||d<0||d>100)return void A("error","Please enter a valid commission rate (0-100).");const l={name:n,phone:a,email:o,role:i,payoutType:s,commissionRate:d};try{if(t)await setDoc(doc(db,"users",t),l,{merge:!0}),A("success","User updated successfully!");else{if(!r)return void A("error","User UID is required. Please get it from the Firebase Console.");await setDoc(doc(db,"users",r),l),A("success","User profile created successfully!")}$n.reset(),document.getElementById("edit-user-id").value="",document.getElementById("new-user-email").disabled=!1,document.getElementById("new-user-uid").disabled=!1,document.getElementById("new-user-uid").value=""}catch(e){console.error("Error saving user document:",e),A("error","Error saving user profile: "+e.message)}})),Dn.addEventListener("click",(async e=>{const t=e.target.closest(".edit-user-btn"),n=e.target.closest(".delete-user-btn");if(t){const e=await getDoc(doc(db,"users",t.dataset.id));if(e.exists()){const n=e.data();document.getElementById("edit-user-id").value=t.dataset.id,document.getElementById("new-user-name").value=n.name,document.getElementById("new-user-phone").value=n.phone,document.getElementById("new-user-email").value=n.email,document.getElementById("new-user-email").disabled=!0,document.getElementById("user-role").value=n.role,document.getElementById("payout-type").value=n.payoutType||"standard",document.getElementById("new-user-commission").value=n.commissionRate||70;const a=document.getElementById("new-user-uid");a.value=t.dataset.id,a.disabled=!0}}n&&mt("Delete this user?",(async()=>{await deleteDoc(doc(db,"users",n.dataset.id)),alert("User role deleted. Login must be deleted from Firebase console.")}))}));const Sn=document.getElementById("add-product-form"),Tn=document.querySelector("#inventory-table tbody"),Mn=document.getElementById("product-supplier"),An=document.querySelector("#inventory-report-table tbody");onSnapshot(query(collection(db,"inventory_usage"),orderBy("timestamp","desc")),(e=>{Ke=e.docs.map((e=>({id:e.id,...e.data()})))}));document.getElementById("inventory-report-tab").addEventListener("click",(()=>{const e=Je.filter((e=>e.quantity<=e.lowStockAlert));if(An.innerHTML="",0===e.length)return void(An.innerHTML='<tr><td colspan="5" class="py-6 text-center text-gray-400">No items are currently low on stock.</td></tr>');const t=new Date;t.setDate(t.getDate()-30);const n=Timestamp.fromDate(t),a=Ke.filter((e=>e.timestamp>=n));e.forEach((e=>{const t=a.filter((t=>t.productId===e.id)).reduce(((e,t)=>e+t.quantityUsed),0),n=Math.max(0,t-e.quantity),o=An.insertRow();o.className="bg-white border-b hover:bg-yellow-50",o.innerHTML=`<td class="px-6 py-4 font-medium text-gray-900">${e.name}</td><td class="px-6 py-4 text-center text-red-600 font-bold">${e.quantity}</td><td class="px-6 py-4 text-center">${e.lowStockAlert}</td><td class="px-6 py-4 text-center">${t}</td><td class="px-6 py-4 text-center font-bold text-blue-600">${n}</td>`}))}));onSnapshot(query(collection(db,"inventory"),orderBy("name")),(e=>{e.docChanges().forEach((e=>{if(("added"===e.type||"modified"===e.type)&&initialInventoryLoaded){const t={id:e.doc.id,...e.doc.data()};if("admin"===currentUserRole&&t.quantity<=t.lowStockAlert)notifications.some((e=>e.itemId===t.id))||A("stock",`${t.name} is low in stock (${t.quantity} left).`,t.id);else{const e=notifications.findIndex((e=>e.itemId===t.id));e>-1&&(notifications.splice(e,1),M())}}})),initialInventoryLoaded=!0,Je=e.docs.map((e=>({id:e.id,...e.data()}))),Tn.innerHTML="",Je.forEach((e=>{const t=Tn.insertRow(),n=e.quantity<=e.lowStockAlert;t.className=n?"bg-yellow-100":"bg-white",t.innerHTML=`<td class="px-6 py-4">${e.name} ${n?'<span class="text-xs font-bold text-yellow-700 ml-2">LOW</span>':""}</td><td class="px-6 py-4">${e.category||""}</td><td class="px-6 py-4">${e.supplier||""}</td><td class="px-6 py-4 text-center">${e.quantity}</td><td class="px-6 py-4 text-right">$${e.price.toFixed(2)}</td><td class="px-6 py-4 text-right">$${(e.quantity*e.price).toFixed(2)}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="edit-product-btn text-blue-500"><i class="fas fa-edit"></i></button><button data-id="${e.id}" class="delete-product-btn text-red-500"><i class="fas fa-trash"></i></button></td>`})),ft()})),Sn.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-product-id").value,n={name:document.getElementById("product-name").value,category:document.getElementById("product-category").value,supplier:document.getElementById("product-supplier").value,quantity:parseInt(document.getElementById("product-quantity").value,10),price:parseFloat(document.getElementById("product-price").value),lowStockAlert:parseInt(document.getElementById("low-stock-alert").value,10)};try{t?await updateDoc(doc(db,"inventory",t),n):await addDoc(collection(db,"inventory"),n),Nn()}catch(e){console.error("Error saving product:",e),alert("Could not save product.")}}));const Nn=()=>{Sn.reset(),document.getElementById("edit-product-id").value="",document.getElementById("add-product-btn").textContent="Add Product",document.getElementById("cancel-edit-product-btn").classList.add("hidden")};document.getElementById("cancel-edit-product-btn").addEventListener("click",Nn),Tn.addEventListener("click",(e=>{const t=e.target.closest(".edit-product-btn"),n=e.target.closest(".delete-product-btn");if(t){const e=Je.find((e=>e.id===t.dataset.id));e&&(document.getElementById("edit-product-id").value=e.id,document.getElementById("product-name").value=e.name,document.getElementById("product-category").value=e.category||"",document.getElementById("product-supplier").value=e.supplier||"",document.getElementById("product-quantity").value=e.quantity,document.getElementById("product-price").value=e.price,document.getElementById("low-stock-alert").value=e.lowStockAlert||10,document.getElementById("add-product-btn").textContent="Update Product",document.getElementById("cancel-edit-product-btn").classList.remove("hidden"))}else n&&mt("Delete this product from inventory?",(async()=>{await deleteDoc(doc(db,"inventory",n.dataset.id))}))}));const Fn=()=>{se.reset(),ie.classList.add("hidden"),ie.classList.remove("flex")};document.getElementById("log-usage-btn").addEventListener("click",(()=>{const e=document.getElementById("log-usage-product-select");e.innerHTML='<option value="">Select a product...</option>',Je.forEach((t=>{e.appendChild(new Option(t.name,t.id))})),ie.classList.remove("hidden"),ie.classList.add("flex")})),document.getElementById("log-usage-cancel-btn").addEventListener("click",Fn),document.querySelector(".log-usage-modal-overlay").addEventListener("click",Fn),se.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("log-usage-product-select").value,n=parseInt(document.getElementById("log-usage-quantity").value,10);if(!t||isNaN(n)||n<=0)return void alert("Please select a product and enter a valid quantity.");const a=Je.find((e=>e.id===t));if(a)if(a.quantity<n)alert(`Not enough stock. Only ${a.quantity} units available.`);else try{await addDoc(collection(db,"inventory_usage"),{productId:t,productName:a.name,quantityUsed:n,timestamp:serverTimestamp()});const e=a.quantity-n;await updateDoc(doc(db,"inventory",t),{quantity:e}),alert("Usage logged successfully."),Fn()}catch(e){console.error("Error logging usage:",e),alert("Could not log usage.")}else alert("Product not found.")}));const Rn=document.getElementById("settings-form"),qn=document.getElementById("min-booking-hours"),Pn=document.getElementById("max-login-attempts"),Hn=document.getElementById("login-lockout-minutes"),jn=document.getElementById("feature-toggles-form");document.getElementById("salon-hours-form").addEventListener("submit",(async e=>{e.preventDefault();const t={};["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach((e=>{const n=document.getElementById(`is-open-${e}`).closest(".grid"),a=n.querySelectorAll('input[type="time"]');t[e]={isOpen:n.querySelector('input[type="checkbox"]').checked,open:a[0].value,close:a[1].value}}));try{await setDoc(doc(db,"settings","salonHours"),t),salonHours=t,alert("Salon hours saved!")}catch(e){console.error("Error saving salon hours:",e),alert("Could not save salon hours.")}}));jn.addEventListener("change",(async e=>{if("checkbox"===e.target.type){const e={showShop:document.getElementById("toggle-shop").checked,showClientLogin:document.getElementById("toggle-client-login").checked,showPromotions:document.getElementById("toggle-promotions").checked,showGiftCards:document.getElementById("toggle-gift-card").checked,showNailArt:document.getElementById("toggle-nails-idea").checked,showMemberships:document.getElementById("toggle-memberships").checked,showRoyaltyCard:document.getElementById("toggle-royalty-card").checked};await setDoc(doc(db,"settings","features"),e,{merge:!0})}}));(async()=>{const e=await getDoc(doc(db,"settings","booking"));if(e.exists()){const t=e.data();bookingSettings={...bookingSettings,...t}}qn.value=bookingSettings.minBookingHours,document.getElementById("default-service-duration").value=bookingSettings.defaultDuration,document.getElementById("booking-buffer-time").value=bookingSettings.bufferTime;const t=await getDoc(doc(db,"settings","security"));if(t.exists()){const e=t.data();loginSecuritySettings=e,Pn.value=e.maxAttempts||3,Hn.value=e.lockoutMinutes||120}const n=await getDoc(doc(db,"settings","birthday_rewards"));if(n.exists()){const e=n.data();document.getElementById("toggle-birthday-rewards").checked=e.enabled||!1,document.getElementById("birthday-email-subject").value=e.subject||"A Special Birthday Gift from Nails Express!",document.getElementById("birthday-email-body").value=e.body||"Hi {clientName},\n\nHappy birthday from all of us at Nails Express! To celebrate, we'd like to offer you 15% off your next visit.\n\nWe hope to see you soon!\n\nThe Nails Express Team"}else document.getElementById("birthday-email-subject").value="A Special Birthday Gift from Nails Express!",document.getElementById("birthday-email-body").value="Hi {clientName},\n\nHappy birthday from all of us at Nails Express! To celebrate, we'd like to offer you 15% off your next visit.\n\nWe hope to see you soon!\n\nThe Nails Express Team"})(),(async()=>{const e=await getDoc(doc(db,"settings","features"));if(e.exists()){const t=e.data();document.getElementById("toggle-shop").checked=!1!==t.showShop,document.getElementById("toggle-client-login").checked=!1!==t.showClientLogin,document.getElementById("toggle-promotions").checked=!1!==t.showPromotions,document.getElementById("toggle-gift-card").checked=!1!==t.showGiftCards,document.getElementById("toggle-nails-idea").checked=!1!==t.showNailArt,document.getElementById("toggle-memberships").checked=!1!==t.showMemberships,document.getElementById("toggle-royalty-card").checked=!1!==t.showRoyaltyCard}else document.getElementById("toggle-shop").checked=!0,document.getElementById("toggle-client-login").checked=!0,document.getElementById("toggle-promotions").checked=!0,document.getElementById("toggle-gift-card").checked=!0,document.getElementById("toggle-nails-idea").checked=!0,document.getElementById("toggle-memberships").checked=!0,document.getElementById("toggle-royalty-card").checked=!0})(),(async()=>{const e=document.getElementById("salon-hours-inputs"),t=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];let n={};const a=await getDoc(doc(db,"settings","salonHours"));a.exists()?n=a.data():t.forEach((e=>{n[e.toLowerCase()]={isOpen:"Sunday"!==e,open:"09:00",close:"20:00"}})),salonHours=n,e.innerHTML=t.map((e=>{const t=e.toLowerCase(),a=n[t]||{isOpen:!0,open:"09:00",close:"20:00"};return`<div class="grid grid-cols-4 gap-2 items-center"><label class="font-semibold text-gray-700 col-span-1">${e}</label><div class="flex items-center gap-2"><input type="checkbox" id="is-open-${t}" class="form-checkbox" ${a.isOpen?"checked":""}><label for="is-open-${t}">Open</label></div><input type="time" value="${a.open}" class="form-input p-1 border rounded" ${a.isOpen?"":"disabled"}><input type="time" value="${a.close}" class="form-input p-1 border rounded" ${a.isOpen?"":"disabled"}></div>`})).join(""),t.forEach((e=>{const t=e.toLowerCase(),n=document.getElementById(`is-open-${t}`),a=n.closest(".grid").querySelectorAll('input[type="time"]');n.addEventListener("change",(()=>{a.forEach((e=>e.disabled=!n.checked))}))}))})();const Un=document.getElementById("payment-guide-form"),On=document.getElementById("gift-card-payment-guide-textarea");getDoc(doc(db,"settings","paymentGuide")).then((e=>{e.exists()&&(On.value=e.data().text||"")})),Un.addEventListener("submit",(async e=>{e.preventDefault();try{await setDoc(doc(db,"settings","paymentGuide"),{text:On.value}),alert("Payment guide saved successfully!")}catch(e){console.error("Error saving payment guide:",e),alert("Could not save payment guide.")}})),Rn.addEventListener("submit",(async e=>{e.preventDefault();const t=parseInt(qn.value,10),n=parseInt(document.getElementById("default-service-duration").value,10),a=parseInt(document.getElementById("booking-buffer-time").value,10),o=parseInt(Pn.value,10),i=parseInt(Hn.value,10);if(isNaN(t)||t<0||isNaN(n)||isNaN(a)||isNaN(o)||o<1||isNaN(i)||i<1)return alert("Please enter valid, positive numbers for all settings.");try{await setDoc(doc(db,"settings","booking"),{minBookingHours:t,defaultDuration:n,bufferTime:a}),await setDoc(doc(db,"settings","security"),{maxAttempts:o,lockoutMinutes:i}),bookingSettings={minBookingHours:t,defaultDuration:n,bufferTime:a},loginSecuritySettings={maxAttempts:o,lockoutMinutes:i},alert("Settings saved!")}catch(e){console.error("Error saving settings: ",e),alert("Could not save settings.")}}));const _n=(e,t,n,a)=>{const o=document.getElementById(t),i=document.getElementById(n),s=document.getElementById(a);onSnapshot(collection(db,e),(t=>{const n=t.docs.map((e=>({id:e.id,...e.data()})));"expense_categories"===e?it=n:"payment_accounts"===e?st=n:"suppliers"===e&&(dt=n),s.innerHTML=n.map((e=>`<div class="flex justify-between items-center p-1 hover:bg-gray-100"><span>${e.name}</span><button data-id="${e.id}" class="delete-item-btn text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button></div>`)).join(""),Zn()})),o.addEventListener("submit",(async t=>{t.preventDefault();const n=i.value.trim();n&&(await addDoc(collection(db,e),{name:n}),i.value="")})),s.addEventListener("click",(t=>{const n=t.target.closest(".delete-item-btn");n&&mt("Delete this item?",(async()=>{await deleteDoc(doc(db,e,n.dataset.id))}))}))};_n("expense_categories","add-expense-category-form","new-expense-category-name","expense-categories-list"),_n("payment_accounts","add-payment-account-form","new-payment-account-name","payment-accounts-list");const Gn=document.getElementById("add-supplier-form"),Yn=document.querySelector("#suppliers-table tbody");onSnapshot(collection(db,"suppliers"),(e=>{dt=e.docs.map((e=>({id:e.id,...e.data()}))),Yn.innerHTML="",dt.forEach((e=>{Yn.insertRow().innerHTML=`<td class="px-6 py-4">${e.name}</td><td class="px-6 py-4">${e.phone||""}</td><td class="px-6 py-4">${e.email||""}</td><td class="px-6 py-4">${e.website?`<a href="${e.website}" target="_blank" class="text-blue-500">Link</a>`:""}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="edit-supplier-btn text-blue-500"><i class="fas fa-edit"></i></button><button data-id="${e.id}" class="delete-supplier-btn text-red-500"><i class="fas fa-trash"></i></button></td>`})),Zn(),(()=>{const e=Mn.options[0];Mn.innerHTML="",Mn.appendChild(e),dt.forEach((e=>{Mn.appendChild(new Option(e.name,e.name))}))})()})),Gn.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-supplier-id").value,n={name:document.getElementById("supplier-name").value,phone:document.getElementById("supplier-phone").value,email:document.getElementById("supplier-email").value,website:document.getElementById("supplier-website").value};t?await updateDoc(doc(db,"suppliers",t),n):await addDoc(collection(db,"suppliers"),n),Wn()}));const Wn=()=>{Gn.reset(),document.getElementById("edit-supplier-id").value="",document.getElementById("add-supplier-btn").textContent="Add Supplier",document.getElementById("cancel-edit-supplier-btn").classList.add("hidden")};document.getElementById("cancel-edit-supplier-btn").addEventListener("click",Wn),Yn.addEventListener("click",(e=>{const t=e.target.closest(".edit-supplier-btn"),n=e.target.closest(".delete-supplier-btn");if(t){const e=dt.find((e=>e.id===t.dataset.id));e&&(document.getElementById("edit-supplier-id").value=e.id,document.getElementById("supplier-name").value=e.name,document.getElementById("supplier-phone").value=e.phone||"",document.getElementById("supplier-email").value=e.email||"",document.getElementById("supplier-website").value=e.website||"",document.getElementById("add-supplier-btn").textContent="Update",document.getElementById("cancel-edit-supplier-btn").classList.remove("hidden"))}else n&&mt("Delete this supplier?",(async()=>{await deleteDoc(doc(db,"suppliers",n.dataset.id))}))}));const Vn=document.getElementById("add-expense-form"),Xn=document.getElementById("expense-month-filter"),zn=document.querySelector("#expense-table tbody"),Jn=document.getElementById("total-expense"),Zn=()=>{const e=document.getElementById("expense-category"),t=document.getElementById("expense-supplier"),n=document.getElementById("expense-payment-account"),a=document.getElementById("expense-category-filter"),o=document.getElementById("expense-supplier-filter"),i=(e,t,n)=>{if(!e)return;const a=e.options[0]||document.createElement("option");a.value="All"===n?"all":"",a.textContent="All"===n?"All "+(e.id.includes("category")?"Categories":"Suppliers"):`Select ${n}`,e.innerHTML="",e.appendChild(a),t.forEach((t=>e.appendChild(new Option(t.name,t.name))))};i(e,it,"Category"),i(t,dt,"Supplier"),i(n,st,"Account"),i(a,it,"All"),i(o,dt,"All")};const Kn=()=>{let e=ze;if(Ge&&"all"!==Ge){const[t,n]=Ge.split("-").map(Number);e=e.filter((e=>{const a=new Date(1e3*e.date.seconds);return a.getFullYear()===t&&a.getMonth()+1===n}))}rt&&"all"!==rt&&(e=e.filter((e=>e.category===rt))),lt&&"all"!==lt&&(e=e.filter((e=>e.supplier===lt))),zn.innerHTML=0===e.length?'<tr><td colspan="8" class="py-6 text-center text-gray-400">No expenses found for the selected filters.</td></tr>':"",e.forEach((e=>{const t=zn.insertRow();t.className="bg-white border-b",t.innerHTML=`<td class="px-6 py-4">${new Date(1e3*e.date.seconds).toLocaleDateString()}</td><td class="px-6 py-4">${e.name}</td><td class="px-6 py-4">${e.category||""}</td><td class="px-6 py-4">${e.supplier||""}</td><td class="px-6 py-4">${e.paymentAccount||""}</td><td class="px-6 py-4">${e.attachmentURL?`<a href="${e.attachmentURL}" target="_blank" class="text-blue-500 hover:underline">View</a>`:"N/A"}</td><td class="px-6 py-4 text-right">$${e.amount.toFixed(2)}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="edit-expense-btn text-blue-500"><i class="fas fa-edit"></i></button><button data-id="${e.id}" class="delete-expense-btn text-red-500"><i class="fas fa-trash"></i></button></td>`})),Jn.textContent=`$${e.reduce(((e,t)=>e+t.amount),0).toFixed(2)}`};Xn.addEventListener("change",(e=>{Ge=e.target.value,Kn()})),document.getElementById("expense-category-filter").addEventListener("change",(e=>{rt=e.target.value,Kn()})),document.getElementById("expense-supplier-filter").addEventListener("change",(e=>{lt=e.target.value,Kn()}));const Qn=document.getElementById("export-expenses-btn");Qn&&Qn.addEventListener("click",(()=>{let e=[...ze];if(Ge&&"all"!==Ge){const[t,n]=Ge.split("-").map(Number);e=e.filter((e=>{const a=new Date(1e3*e.date.seconds);return a.getFullYear()===t&&a.getMonth()+1===n}))}if(rt&&"all"!==rt&&(e=e.filter((e=>e.category===rt))),lt&&"all"!==lt&&(e=e.filter((e=>e.supplier===lt))),0===e.length)return void alert("There is no data to export for the current filters.");const t=e.map((e=>({Date:new Date(1e3*e.date.seconds).toLocaleDateString(),"Expense Name":e.name,Category:e.category||"",Supplier:e.supplier||"","Paid Via":e.paymentAccount||"",Amount:e.amount}))),n=e.reduce(((e,t)=>e+t.amount),0);t.push({}),t.push({Date:"Total:",Amount:n});const a=XLSX.utils.json_to_sheet(t);a["!cols"]=[{wch:12},{wch:30},{wch:20},{wch:20},{wch:20},{wch:12}];for(let e=2;e<=t.length+1;e++){const t=`F${e}`;a[t]&&"number"==typeof a[t].v&&(a[t].t="n",a[t].z="$#,##0.00")}const o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,a,"Expenses Report"),XLSX.writeFile(o,`NailsExpress_Expenses_${(new Date).toISOString().split("T")[0]}.xlsx`)}));const ea=document.getElementById("print-expenses-btn");ea&&ea.addEventListener("click",(()=>{const e=document.getElementById("expense-table");if(e){const t="Expense Report",n=new Date,a=`Printed on: ${n.toLocaleDateString()} at ${n.toLocaleTimeString()}`,o="https://placehold.co/100x100/d63384/FFFFFF?text=NE",i=e.outerHTML,s=window.open("","_blank","height=800,width=1000");s.document.write("<html><head><title>Nails Express-Print Expenses</title>"),s.document.write('<script src="https://cdn.tailwindcss.com"><\/script>'),s.document.write("<style> body { padding: 20px; font-family: sans-serif; } @media print { body { -webkit-print-color-adjust: exact; } .no-print { display: none; } } </style>"),s.document.write("</head><body>"),s.document.write(`\n                    <div class="flex justify-between items-center mb-4 border-b pb-4">\n                        <div>\n                            <h1 class="text-2xl font-bold mb-2">${t}</h1>\n                            <p class="text-sm text-gray-500">${a}</p>\n                        </div>\n                        <img src="${o}" alt="Salon Logo" class="h-16 w-16 rounded-full">\n                    </div>\n                `),s.document.write(i),s.document.write("</body></html>"),s.document.close(),s.focus(),setTimeout((()=>{s.print(),s.close()}),500)}})),Vn.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-expense-id").value,n=document.getElementById("expense-attachment").files[0];let a=document.getElementById("current-attachment-info").dataset.url||null;if(n){const e=ref(storage,`expenses/${Date.now()}_${n.name}`);await uploadBytes(e,n),a=await getDownloadURL(e)}const o={name:document.getElementById("expense-name").value,amount:parseFloat(document.getElementById("expense-amount").value),date:Timestamp.fromDate(new Date(document.getElementById("expense-date").value+"T12:00:00")),category:document.getElementById("expense-category").value,supplier:document.getElementById("expense-supplier").value,paymentAccount:document.getElementById("expense-payment-account").value,attachmentURL:a};try{t?await updateDoc(doc(db,"expenses",t),o):await addDoc(collection(db,"expenses"),o),ta()}catch(e){console.error("Error saving expense:",e),alert("Could not save expense.")}}));const ta=()=>{Vn.reset(),document.getElementById("edit-expense-id").value="",document.getElementById("expense-date").value=cn(),document.getElementById("add-expense-btn").textContent="Add Expense",document.getElementById("cancel-edit-expense-btn").classList.add("hidden"),document.getElementById("current-attachment-info").textContent="",document.getElementById("current-attachment-info").dataset.url=""};document.getElementById("cancel-edit-expense-btn").addEventListener("click",ta),zn.addEventListener("click",(e=>{const t=e.target.closest(".delete-expense-btn"),n=e.target.closest(".edit-expense-btn");if(t)mt("Delete this expense?",(async()=>{await deleteDoc(doc(db,"expenses",t.dataset.id))}));else if(n){const e=ze.find((e=>e.id===n.dataset.id));if(e){document.getElementById("edit-expense-id").value=e.id,document.getElementById("expense-name").value=e.name,document.getElementById("expense-amount").value=e.amount,document.getElementById("expense-date").value=new Date(1e3*e.date.seconds).toISOString().split("T")[0],document.getElementById("expense-category").value=e.category||"",document.getElementById("expense-supplier").value=e.supplier||"",document.getElementById("expense-payment-account").value=e.paymentAccount||"";const t=document.getElementById("current-attachment-info");t.textContent=e.attachmentURL?"Current attachment exists.":"",t.dataset.url=e.attachmentURL||"",document.getElementById("add-expense-btn").textContent="Update Expense",document.getElementById("cancel-edit-expense-btn").classList.remove("hidden")}}}));const na=document.getElementById("service-categories-admin"),aa=document.getElementById("add-category-form"),oa=document.getElementById("add-service-form"),ia=document.getElementById("edit-service-section");onSnapshot(collection(db,"services"),(e=>{var t;servicesData={},e.forEach((e=>{servicesData[e.id]=e.data().items})),t=servicesData,na.innerHTML="",Object.entries(t).forEach((([e,t])=>{const n=document.createElement("div");n.className="p-3 border rounded-lg",n.innerHTML=`<div class="flex justify-between items-center mb-2"><h4 class="font-bold">${e}</h4><div><button class="add-service-to-category-btn text-green-500 mr-2" data-category="${e}"><i class="fas fa-plus-circle"></i></button><button class="edit-category-btn text-blue-500 mr-2" data-category="${e}"><i class="fas fa-edit"></i></button><button class="delete-category-btn text-red-500" data-category="${e}"><i class="fas fa-trash"></i></button></div></div><ul class="service-list space-y-1 pl-4">${t.map(((t,n)=>`<li class="flex justify-between items-center text-sm"><span>${t.name} - ${t.price} (${t.duration||"N/A"} min)</span><div><button class="edit-service-btn text-blue-500 mr-2" data-category="${e}" data-index="${n}"><i class="fas fa-edit"></i></button><button class="delete-service-btn text-red-500" data-category="${e}" data-index="${n}"><i class="fas fa-times-circle"></i></button></div></li>`)).join("")}</ul>`,na.appendChild(n)})),wt()})),aa.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("new-category-name").value;t&&(await setDoc(doc(db,"services",t),{items:[]}),aa.reset())})),na.addEventListener("click",(async e=>{const t=e.target.closest(".delete-category-btn"),n=e.target.closest(".edit-category-btn"),a=e.target.closest(".add-service-to-category-btn"),o=e.target.closest(".edit-service-btn"),i=e.target.closest(".delete-service-btn");if(t&&mt(`Delete category "${t.dataset.category}"?`,(async()=>{await deleteDoc(doc(db,"services",t.dataset.category))})),n){const e=n.dataset.category,t=prompt("New category name:",e);if(t&&t!==e){const n=await getDoc(doc(db,"services",e));n.exists()&&(await setDoc(doc(db,"services",t),n.data()),await deleteDoc(doc(db,"services",e)))}}if(a&&(oa.reset(),document.getElementById("edit-category-id").value=a.dataset.category,document.getElementById("edit-service-index").value="",document.getElementById("edit-service-title").textContent=`Add Service to ${a.dataset.category}`,ia.classList.remove("hidden")),o){const e=o.dataset.category,t=o.dataset.index,n=servicesData[e][t];oa.reset(),document.getElementById("edit-category-id").value=e,document.getElementById("edit-service-index").value=t,document.getElementById("service-prefix").value=n.p||"",document.getElementById("service-name").value=n.name,document.getElementById("service-price").value=n.price,document.getElementById("service-duration").value=n.duration||"",document.getElementById("edit-service-title").textContent=`Edit Service in ${e}`,ia.classList.remove("hidden")}if(i){const e=i.dataset.category,t=parseInt(i.dataset.index,10);mt("Delete this service?",(async()=>{const n=[...servicesData[e]];n.splice(t,1),await updateDoc(doc(db,"services",e),{items:n})}))}})),oa.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-category-id").value,n=document.getElementById("edit-service-index").value,a={p:document.getElementById("service-prefix").value,name:document.getElementById("service-name").value,price:document.getElementById("service-price").value,duration:parseInt(document.getElementById("service-duration").value,10)||40},o=[...servicesData[t]];""!==n?o[parseInt(n,10)]=a:o.push(a),await updateDoc(doc(db,"services",t),{items:o}),oa.reset(),ia.classList.add("hidden")}));document.getElementById("nails-idea-gallery");const sa=document.getElementById("add-nail-idea-form"),da=document.querySelector("#nail-ideas-table tbody"),ra=document.querySelectorAll('input[name="imageSource"]'),la=document.getElementById("nail-idea-file-upload-container"),ca=document.getElementById("nail-idea-url-container"),ma=document.getElementById("nail-idea-image"),ua=document.getElementById("nail-idea-image-url");ra.forEach((e=>{e.addEventListener("change",(()=>{"upload"===e.value?(la.classList.remove("hidden"),ca.classList.add("hidden"),ua.value=""):(la.classList.add("hidden"),ca.classList.remove("hidden"),ma.value="")}))}));const pa=()=>{const e=document.getElementById("nail-idea-search").value.toLowerCase(),t=document.getElementById("nail-idea-shape-filter").value,n=document.querySelector("#nail-idea-tag-filter-container .tech-filter-btn.active"),a=n?n.dataset.category:"",o=Ze.filter((n=>{const o=n.name.toLowerCase().includes(e)||n.categories.some((t=>t.toLowerCase().includes(e))),i=!t||n.shape===t,s=!a||n.categories.includes(a);return o&&i&&s}));renderNailIdeasGallery(o)},ga=document.getElementById("nail-idea-tag-filter-container");ga&&ga.addEventListener("click",(e=>{const t=e.target.closest(".tech-filter-btn");t&&(ga.querySelectorAll(".tech-filter-btn").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),pa())})),onSnapshot(query(collection(db,"nail_ideas"),orderBy("createdAt","desc")),(e=>{Ze=e.docs.map((e=>({id:e.id,...e.data()})));const t=document.getElementById("nail-shapes-list");if(t){const e=[...new Set(Ze.map((e=>e.shape)).filter(Boolean))];t.innerHTML=e.map((e=>`<option value="${e}"></option>`)).join("")}const n=[...new Set(Ze.map((e=>e.shape)).filter(Boolean))];document.getElementById("nail-idea-shape-filter").innerHTML='<option value="">All Shapes</option>'+n.map((e=>`<option value="${e}">${e}</option>`)).join("");const a=[...new Set(Ze.flatMap((e=>e.categories)).filter(Boolean))],o=document.getElementById("nail-idea-tag-filter-container");o.innerHTML='<span class="text-sm font-semibold text-gray-600 mr-2">Tags:</span>';const i=document.createElement("button");var s;i.className="tech-filter-btn px-3 py-1 rounded-full text-sm active",i.dataset.category="",i.textContent="All",o.appendChild(i),a.sort().forEach((e=>{const t=document.createElement("button");t.className="tech-filter-btn px-3 py-1 rounded-full text-sm",t.dataset.category=e,t.textContent=e,o.appendChild(t)})),pa(),s=Ze,da.innerHTML="",s.forEach((e=>{da.insertRow().innerHTML=`<td class="px-6 py-4"><img src="${e.imageURLs&&e.imageURLs[0]||e.imageURL}" alt="${e.name}" class="w-16 h-16 object-cover rounded"></td><td class="px-6 py-4">${e.name}</td><td class="px-6 py-4">${e.shape}</td><td class="px-6 py-4">${e.categories.join(", ")}</td><td class="px-6 py-4 text-center space-x-2"><button data-id="${e.id}" class="edit-nail-idea-btn text-blue-500"><i class="fas fa-edit"></i></button><button data-id="${e.id}" class="delete-nail-idea-btn text-red-500"><i class="fas fa-trash"></i></button></td>`}))})),document.getElementById("nail-idea-search").addEventListener("input",pa),document.getElementById("nail-idea-shape-filter").addEventListener("change",pa),sa.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-nail-idea-id").value,n=document.querySelector('input[name="imageSource"]:checked').value,a=document.getElementById("nail-idea-image").files[0],o=document.getElementById("nail-idea-image-url").value;let i=[];const s=document.getElementById("add-nail-idea-btn");s.disabled=!0,s.textContent="Saving...";try{if("upload"===n){if(!t&&!a)throw new Error("Please select an image to upload.");if(a){const e=ref(storage,`nail_ideas/${Date.now()}_${a.name}`);await uploadBytes(e,a),i.push(await getDownloadURL(e))}}else if(i=o.split("\n").map((e=>e.trim())).filter(Boolean),0===i.length)throw new Error("Please enter at least one image URL.");const e={name:document.getElementById("nail-idea-name").value,description:document.getElementById("nail-idea-description").value,color:document.getElementById("nail-idea-color").value,shape:document.getElementById("nail-idea-shape").value,categories:document.getElementById("nail-idea-categories").value.split(",").map((e=>e.trim())).filter(Boolean)};if(t){const n=Ze.find((e=>e.id===t));if(i.length>0&&(e.imageURLs=i,n.imageURLs&&n.imageURLs[0]&&n.imageURLs[0].includes("firebasestorage")))try{const e=ref(storage,n.imageURLs[0]);await deleteObject(e)}catch(e){console.warn("Could not delete old image, it might not exist:",e)}await updateDoc(doc(db,"nail_ideas",t),e)}else e.imageURLs=i,e.createdAt=serverTimestamp(),await addDoc(collection(db,"nail_ideas"),e);ya()}catch(e){console.error("Error saving nail idea:",e),alert(`Could not save nail idea: ${e.message}`)}finally{s.disabled=!1,s.textContent=document.getElementById("edit-nail-idea-id").value?"Update Idea":"Add Idea"}}));const ya=()=>{sa.reset(),document.getElementById("edit-nail-idea-id").value="",document.getElementById("nail-idea-description").value="",document.getElementById("add-nail-idea-btn").textContent="Add Idea",document.getElementById("cancel-edit-nail-idea-btn").classList.add("hidden")};document.getElementById("cancel-edit-nail-idea-btn").addEventListener("click",ya),da.addEventListener("click",(e=>{const t=e.target.closest(".edit-nail-idea-btn"),n=e.target.closest(".delete-nail-idea-btn");if(t){const e=Ze.find((e=>e.id===t.dataset.id));if(e){document.getElementById("edit-nail-idea-id").value=e.id,document.getElementById("nail-idea-name").value=e.name,document.getElementById("nail-idea-color").value=e.color,document.getElementById("nail-idea-shape").value=e.shape,document.getElementById("nail-idea-description").value=e.description||"",document.getElementById("nail-idea-categories").value=e.categories.join(", ");const t=document.getElementById("nail-idea-image-url");e.imageURLs&&e.imageURLs.length>0?t.value=e.imageURLs.join("\n"):e.imageURL&&(t.value=e.imageURL),document.getElementById("add-nail-idea-btn").textContent="Update Idea",document.getElementById("cancel-edit-nail-idea-btn").classList.remove("hidden")}}else if(n){const e=n.dataset.id;mt("Delete this nail idea? This will also delete the image.",(async()=>{const t=Ze.find((t=>t.id===e));if(t){if(t.imageURL&&t.imageURL.includes("firebasestorage")){const e=ref(storage,t.imageURL);await deleteObject(e).catch((e=>console.error("Error deleting image from storage",e)))}await deleteDoc(doc(db,"nail_ideas",e))}}))}}));let ha=!1;const fa=e=>{const t=document.getElementById("color-group-filter"),n=document.getElementById("color-search-input"),a=[...new Set(e.colors.map((e=>e.group||"Uncategorized")))],o=t.value;t.innerHTML='<option value="all">All Groups</option>',a.sort().forEach((e=>{const n=e===o?"selected":"";t.innerHTML+=`<option value="${e}" ${n}>${e}</option>`}));const i=t.value,s=n.value.toLowerCase();let d=e.colors;i&&"all"!==i&&(d=d.filter((e=>(e.group||"Uncategorized")===i))),s&&(d=d.filter((e=>e.name.toLowerCase().includes(s)))),ba(d)},ba=e=>{const t=document.getElementById("color-swatches-container");t.innerHTML="",0===e.length?t.innerHTML='<p class="col-span-full text-sm text-gray-500">No colors match your filter.</p>':e.forEach((e=>{t.innerHTML+=`\n                <div class="text-center">\n                    <div class="color-swatch mx-auto" data-color="${e.hex}" style="background-color: ${e.hex};"></div>\n                    <p class="text-xs mt-1">${e.name}</p>\n                </div>\n            `}))},va=async()=>{if(ha)return;const e={Almond:'<svg viewBox="0 0 100 150"><path class="nail" d="M50,0 C10,0 0,60 0,130 L100,130 C100,60 90,0 50,0 Z"/></svg>',Square:'<svg viewBox="0 0 100 150"><path class="nail" d="M5,0 L95,0 C98,0 100,2 100,5 L100,150 L0,150 L0,5 C0,2 2,0 5,0 Z"/></svg>',Squoval:'<svg viewBox="0 0 100 150"><path class="nail" d="M20,0 L80,0 C91,0 100,9 100,20 L100,150 L0,150 L0,20 C0,9 9,0 20,0 Z"/></svg>',Round:'<svg viewBox="0 0 100 150"><path class="nail" d="M100,150 L0,150 L0,50 C0,22.4 22.4,0 50,0 C77.6,0 100,22.4 100,50 Z"/></svg>',Stiletto:'<svg viewBox="0 0 100 150"><path class="nail" d="M50,0 C50,0 100,130 100,130 L100,150 L0,150 L0,130 C0,130 50,0 50,0 Z"/></svg>',Coffin:'<svg viewBox="0 0 100 150"><path class="nail" d="M30,0 L70,0 L100,150 L0,150 Z"/></svg>'},t=document.getElementById("nail-shape-preview-container");t.innerHTML="";let n='<div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-6">';for(const t in e)n+=`\n        <div class="text-center">\n            <div class="nail-shape-svg-wrapper">${e[t]}</div>\n            <p class="text-xs font-semibold text-gray-600 mt-1">${t}</p>\n        </div>\n    `;n+="</div>",t.innerHTML=n;const a=document.getElementById("color-brands-tabs");a.innerHTML="",allColorBrands.forEach(((e,t)=>{const n=document.createElement("button");n.className="color-brand-btn px-3 py-1 rounded-full text-sm",n.textContent=e.name,n.dataset.brandId=e.id,0===t&&(n.classList.add("active"),fa(e)),a.appendChild(n)}));const o=()=>{const e=a.querySelector(".color-brand-btn.active");if(e){const t=allColorBrands.find((t=>t.id===e.dataset.brandId));fa(t)}};a.addEventListener("click",(e=>{const t=e.target.closest(".color-brand-btn");t&&(a.querySelectorAll(".color-brand-btn").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.getElementById("color-group-filter").value="all",document.getElementById("color-search-input").value="",o())})),document.getElementById("color-group-filter").addEventListener("change",o),document.getElementById("color-search-input").addEventListener("input",o),document.getElementById("color-swatches-container").addEventListener("click",(e=>{const t=e.target.closest(".color-swatch");if(t){const e=t.dataset.color;document.querySelectorAll("#nail-shape-preview-container .nail").forEach((t=>{t.style.fill=e}))}})),ha=!0};document.getElementById("add-color-brand-form")?.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("new-color-brand-name"),n=t.value.trim();if(n)try{await setDoc(doc(db,"color_brands",n),{name:n,colors:[]}),t.value=""}catch(e){console.error("Error adding new color brand: ",e),alert("Could not add new brand.")}})),document.getElementById("color-brands-admin-list")?.addEventListener("click",(e=>{const t=e.target.closest(".delete-color-brand-btn");if(t){const e=t.dataset.id,n=allColorBrands.find((t=>t.id===e));mt(`Are you sure you want to delete the brand "${n.name}" and all its colors?`,(async()=>{await deleteDoc(doc(db,"color_brands",e))}))}})),onSnapshot(query(collection(db,"color_brands"),orderBy("name")),(e=>{e.empty?(async()=>{writeBatch(db);const e={DND:[],DC:[],DD:[],"Royal Cat Eye":[]};for(const t in e){const n=doc(db,"color_brands",t);await setDoc(n,{name:t,colors:e[t]},{merge:!0})}try{console.log("Successfully pre-filled and merged color chart data.")}catch(e){console.error("Error pre-filling color data: ",e)}})():(allColorBrands=e.docs.map((e=>({id:e.id,...e.data()}))),(()=>{const e=document.getElementById("color-brands-admin-list");e&&(e.innerHTML="",allColorBrands.forEach((t=>{const n=document.createElement("div");n.className="p-3 border rounded-lg bg-white flex justify-between items-center",n.innerHTML=`\n            <span class="font-bold">${t.name}</span>\n            <div>\n                <span class="text-sm text-gray-500 mr-4">${t.colors.length} colors</span>\n                \n                <button data-id="${t.id}" class="edit-color-brand-btn text-blue-500 hover:text-blue-700 mr-2" title="Edit Colors"><i class="fas fa-palette"></i></button>\n\n                <button data-id="${t.id}" class="delete-color-brand-btn text-red-500 hover:text-red-700" title="Delete Brand"><i class="fas fa-trash"></i></button>\n            </div>\n        `,e.appendChild(n)})))})(),ha&&(ha=!1,va()))}));const xa=document.getElementById("edit-colors-modal"),Ea=document.getElementById("close-edit-colors-modal-btn"),Ia=document.getElementById("add-new-color-form"),wa=document.getElementById("existing-colors-list"),Ba=e=>{document.getElementById("edit-colors-modal-title").textContent=`Edit Colors for ${e.name}`,document.getElementById("edit-color-brand-id").value=e.id,(e=>{wa.innerHTML="",0!==e.colors.length?e.colors.forEach(((e,t)=>{const n=document.createElement("div");n.className="flex items-center justify-between p-2 bg-gray-50 rounded",n.innerHTML=`\n            <div class="flex items-center gap-3">\n                <div class="w-6 h-6 rounded-full border" style="background-color: ${e.hex};"></div>\n                <div>\n                    <span class="font-medium">${e.name}</span>\n                    <p class="text-xs text-gray-500">${e.group||"No Group"}</p>\n                </div>\n            </div>\n            <button data-index="${t}" class="delete-color-btn text-red-400 hover:text-red-700"><i class="fas fa-times-circle"></i></button>\n        `,wa.appendChild(n)})):wa.innerHTML='<p class="text-sm text-gray-500 text-center p-4">No colors added yet.</p>'})(e),xa.classList.remove("hidden")},La=()=>{xa.classList.add("hidden"),Ia.reset()};document.getElementById("color-brands-admin-list")?.addEventListener("click",(e=>{const t=e.target.closest(".edit-color-brand-btn");if(t){const e=t.dataset.id,n=allColorBrands.find((t=>t.id===e));n&&Ba(n)}})),Ia.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-color-brand-id").value,n=allColorBrands.find((e=>e.id===t));if(!n)return;const a={name:document.getElementById("new-color-name").value,hex:document.getElementById("new-color-hex").value,group:document.getElementById("new-color-group").value.trim()||"Uncategorized"},o=[...n.colors,a];try{await updateDoc(doc(db,"color_brands",t),{colors:o}),Ia.reset()}catch(e){console.error("Error adding new color:",e),alert("Could not add the color.")}})),wa.addEventListener("click",(async e=>{const t=e.target.closest(".delete-color-btn");if(t){const e=document.getElementById("edit-color-brand-id").value,n=allColorBrands.find((t=>t.id===e));if(!n)return;const a=parseInt(t.dataset.index,10),o=n.colors.filter(((e,t)=>t!==a));try{await updateDoc(doc(db,"color_brands",e),{colors:o})}catch(e){console.error("Error deleting color:",e),alert("Could not delete the color.")}}})),Ea.addEventListener("click",La),xa.querySelector(".modal-overlay").addEventListener("click",La);const ka=document.querySelector("#gift-cards-table tbody"),Ca=document.querySelector("#gift-cards-table-admin tbody"),$a=e=>{[ka,Ca].forEach((t=>{t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=t.insertRow(),a=void 0!==e.balance?e.balance:e.amount;let o=e.status||"Active",i="bg-gray-200 text-gray-800";switch(o){case"Active":i="bg-green-100 text-green-800";break;case"Pending":i="bg-yellow-100 text-yellow-800";break;case"Depleted":i="bg-red-100 text-red-800"}let s=`<button data-id="${e.id}" class="print-gift-card-btn text-gray-500 hover:text-gray-700" title="View/Print Card"><i class="fas fa-print text-lg"></i></button>\n                     <button data-id="${e.id}" class="edit-gift-card-btn text-blue-500 hover:text-blue-700" title="Manage Card"><i class="fas fa-edit text-lg"></i></button>\n                     <button data-id="${e.id}" class="delete-gift-card-btn text-red-500 hover:text-red-700" title="Delete Card"><i class="fas fa-trash-alt text-lg"></i></button>`;"Pending"===o&&(s=`<button data-id="${e.id}" class="activate-gift-card-btn text-green-500 hover:text-green-700" title="Activate Card"><i class="fas fa-check-circle text-lg"></i></button>`+s);let d="N/A";e.buyerInfo&&(d=`\n                    <div>\n                        <p class="font-semibold">${e.buyerInfo.name||"N/A"}</p>\n                        <p class="text-xs text-gray-600">${e.buyerInfo.phone||"No Phone"}</p>\n                        <p class="text-xs text-gray-600">${e.buyerInfo.email||"No Email"}</p>\n                    </div>\n                `,e.recipientName&&e.recipientName!==e.buyerInfo.name&&(d+=`<div class="mt-1 border-t border-gray-200 pt-1 text-sm"><span class="font-semibold text-gray-500">To:</span> ${e.recipientName}</div>`)),n.innerHTML=`<td class="px-6 py-4">${new Date(1e3*e.createdAt.seconds).toLocaleDateString()}</td>\n                             <td class="px-6 py-4 font-mono text-xs">${e.code}</td>\n                             <td class="px-6 py-4">$${e.amount.toFixed(2)}</td>\n                             <td class="px-6 py-4 font-bold">$${a.toFixed(2)}</td>\n                             <td class="px-6 py-4">${d}</td>\n                             <td class="px-6 py-4">${e.senderName}</td>\n                             <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${i}">${o}</span></td>\n                             <td class="px-6 py-4 text-center space-x-4">${s}</td>`})):t.innerHTML='<tr><td colspan="8" class="py-6 text-center text-gray-400">No gift cards have been sold.</td></tr>')}))};onSnapshot(query(collection(db,"gift_cards"),orderBy("createdAt","desc")),(e=>{Qe=e.docs.map((e=>({id:e.id,...e.data()}))),$a(Qe)}));const Da=document.getElementById("add-promotion-form"),Sa=document.querySelector("#promotions-table tbody"),Ta=(document.getElementById("promotions-container-landing"),document.getElementById("email-marketing-modal")),Ma=document.getElementById("email-marketing-form"),Aa=(e=null)=>{Ma.reset(),e?(document.getElementById("email-marketing-modal-title").textContent=`Email Campaign for "${e.title}"`,document.getElementById("email-marketing-subject").value=e.title,document.getElementById("email-marketing-body").value=e.description):document.getElementById("email-marketing-modal-title").textContent="Create Email Campaign",Ta.classList.remove("hidden")},Na=()=>Ta.classList.add("hidden");document.getElementById("open-email-marketing-btn").addEventListener("click",(()=>Aa())),document.getElementById("close-email-marketing-modal-btn").addEventListener("click",Na),Ta.querySelector(".modal-overlay").addEventListener("click",Na),Sa.addEventListener("click",(e=>{const t=e.target.closest(".email-promo-btn");if(t){const e=et.find((e=>e.id===t.dataset.id));e&&Aa(e)}})),Ma.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("email-marketing-subject").value,n=document.getElementById("email-marketing-body").value,a=allClients.filter((e=>e.email));if(0!==a.length){if(confirm(`This will send an email to ${a.length} clients. Are you sure you want to proceed?`))try{const e=writeBatch(db);a.forEach((a=>{const o=doc(collection(db,"mail")),i=n.replace(/{clientName}/g,a.name).replace(/\n/g,"<br>");e.set(o,{to:a.email,message:{subject:t,html:i}})})),await e.commit(),alert(`Email campaign has been queued for ${a.length} clients!`),Na()}catch(e){console.error("Error sending email campaign:",e),alert("Could not send the email campaign. Please check the console for details.")}}else alert("No clients with email addresses found.")}));onSnapshot(query(collection(db,"promotions"),orderBy("startDate","desc")),(e=>{et=e.docs.map((e=>({id:e.id,...e.data()}))),(e=>{Sa.innerHTML="";const t=new Date;e.forEach((e=>{const n=e.startDate.toDate(),a=e.endDate.toDate();let o,i;t<n?(o="Scheduled",i="text-blue-600"):t>a?(o="Expired",i="text-gray-500"):(o="Active",i="text-green-600");const s=Sa.insertRow();let d=`\n    <button data-id="${e.id}" class="send-promo-notification-btn text-purple-500" title="Send In-App Notification"><i class="fas fa-bell"></i></button>\n    <button data-id="${e.id}" class="email-promo-btn text-blue-500" title="Create Email Campaign"><i class="fas fa-paper-plane"></i></button>\n    <button data-id="${e.id}" class="edit-promotion-btn text-yellow-500"><i class="fas fa-edit"></i></button>\n    <button data-id="${e.id}" class="delete-promotion-btn text-red-500"><i class="fas fa-trash"></i></button>\n`;s.innerHTML=`<td class="px-6 py-4">${e.title}</td><td class="px-6 py-4">${e.description}</td><td class="px-6 py-4">${n.toLocaleDateString()} - ${a.toLocaleDateString()}</td><td class="px-6 py-4 font-bold ${i}">${o}</td><td class="px-6 py-4 text-center space-x-3">${d}</td>`}))})(et),renderPromotionsLanding(et)})),Da.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-promotion-id").value,n={title:document.getElementById("promotion-title").value,description:document.getElementById("promotion-description").value,startDate:Timestamp.fromDate(new Date(document.getElementById("promotion-start-date").value+"T00:00:00")),endDate:Timestamp.fromDate(new Date(document.getElementById("promotion-end-date").value+"T23:59:59"))};try{t?await updateDoc(doc(db,"promotions",t),n):(n.createdAt=serverTimestamp(),await addDoc(collection(db,"promotions"),n)),Da.reset(),document.getElementById("edit-promotion-id").value=""}catch(e){console.error("Error saving promotion:",e),alert("Could not save promotion.")}})),Sa.addEventListener("click",(e=>{const t=e.target.closest(".edit-promotion-btn"),n=e.target.closest(".delete-promotion-btn"),a=e.target.closest(".send-promo-notification-btn");if(t){const e=et.find((e=>e.id===t.dataset.id));e&&(document.getElementById("edit-promotion-id").value=e.id,document.getElementById("promotion-title").value=e.title,document.getElementById("promotion-description").value=e.description,document.getElementById("promotion-start-date").value=e.startDate.toDate().toISOString().split("T")[0],document.getElementById("promotion-end-date").value=e.endDate.toDate().toISOString().split("T")[0],document.getElementById("add-promotion-btn").textContent="Update Promotion",document.getElementById("cancel-edit-promotion-btn").classList.remove("hidden"))}else if(n)mt("Are you sure you want to delete this promotion?",(async()=>{await deleteDoc(doc(db,"promotions",n.dataset.id))}));else if(a){const e=et.find((e=>e.id===a.dataset.id));e&&mt(`Send a notification for "${e.title}" to all clients?`,(()=>{A("promo",`New Promotion: ${e.title}! ${e.description}`),alert("Promotion notification sent!")}))}})),document.getElementById("cancel-edit-promotion-btn").addEventListener("click",(()=>{Da.reset(),document.getElementById("edit-promotion-id").value="",document.getElementById("add-promotion-btn").textContent="Add Promotion",document.getElementById("cancel-edit-promotion-btn").classList.add("hidden")}));const Fa=(e=null)=>{Q.reset();const t=document.getElementById("client-form-title");e?(t.textContent="Edit Client Information",document.getElementById("edit-client-id").value=e.id,document.getElementById("client-form-name").value=e.name,document.getElementById("client-form-phone").value=e.phone||"",document.getElementById("client-form-email").value=e.email||"",document.getElementById("client-form-dob").value=e.dob||""):(t.textContent="Create New Client",document.getElementById("edit-client-id").value=""),K.classList.remove("hidden"),K.classList.add("flex")},Ra=()=>{K.classList.add("hidden"),K.classList.remove("flex")};document.getElementById("create-new-client-btn").addEventListener("click",(()=>Fa())),document.getElementById("client-form-cancel-btn").addEventListener("click",Ra),document.querySelector(".client-form-modal-overlay").addEventListener("click",Ra),Q.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-client-id").value.trim(),n={name:document.getElementById("client-form-name").value.trim(),phone:document.getElementById("client-form-phone").value.trim()||"",email:document.getElementById("client-form-email").value.trim()||"",dob:document.getElementById("client-form-dob").value.trim()||""};if(n.name)try{t?(n.lastUpdated=serverTimestamp(),await updateDoc(doc(db,"clients",t),n)):(n.createdAt=serverTimestamp(),await addDoc(collection(db,"clients"),n)),Ra()}catch(e){console.error("Error saving client:",e),alert("Could not save client data.")}else alert("Client name is required.")}));const qa=document.getElementById("import-clients-btn"),Pa=document.getElementById("import-clients-input");qa.addEventListener("click",(()=>Pa.click())),Pa.addEventListener("change",(e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async e=>{const t=new Uint8Array(e.target.result),n=XLSX.read(t,{type:"array"}),a=n.Sheets[n.SheetNames[0]],o=XLSX.utils.sheet_to_json(a);if(0===o.length)return void alert("No clients found in the file.");const i=writeBatch(db);o.forEach((e=>{const t=doc(collection(db,"clients"));i.set(t,{name:e.Name||"N/A",phone:e.Phone||"",dob:e.DOB||""})}));try{await i.commit(),alert(`${o.length} clients imported successfully!`)}catch(e){console.error("Error importing clients: ",e),alert("An error occurred during import.")}},n.readAsArrayBuffer(t),e.target.value=""}));const Ha=document.getElementById("physical-gift-card-form"),ja=document.getElementById("designer-background-tabs"),Ua=document.getElementById("designer-background-options"),Oa=(document.getElementById("printable-gift-card-area"),document.getElementById("printable-gift-card")),_a=document.getElementById("save-and-print-btn"),Ga=document.getElementById("edit-gift-card-form");Ga.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-gift-card-id").value,n=Qe.find((e=>e.id===t));if(!n)return void alert("Could not find the gift card to update.");const a=document.getElementById("edit-gc-transaction-type").value,o=parseFloat(document.getElementById("edit-gc-transaction-amount").value),i=document.getElementById("edit-gc-transaction-notes").value.trim(),s=document.getElementById("edit-gc-code-input").value.trim();if(!s)return void alert("Gift card code cannot be empty.");if(isNaN(o)||o<=0)return void alert("Please enter a valid, positive amount for the transaction.");let d=n.balance;if("redeem"===a){if(o>n.balance)return void alert("Cannot redeem an amount greater than the current balance.");d-=o}else d+=o;const r={type:a,amount:o,notes:i,timestamp:Timestamp.now()};let l=d<=0?"Depleted":"Active";try{const e=doc(db,"gift_cards",t);await updateDoc(e,{balance:d,status:l,history:arrayUnion(r),code:s}),alert("Transaction applied successfully!"),ge.classList.add("hidden")}catch(e){console.error("Error applying transaction:",e),alert("Could not apply the transaction. Please try again.")}}));const Ya=()=>{const e=document.getElementById("designer-show-to").checked,t=document.getElementById("designer-show-from").checked,n=document.getElementById("designer-set-expiry").checked,a=document.getElementById("designer-no-expiry").checked;document.getElementById("preview-to").parentElement.style.display=e?"":"none",document.getElementById("preview-from").parentElement.style.display=t?"":"none",document.getElementById("designer-to-wrapper").style.display=e?"":"none",document.getElementById("designer-from-wrapper").style.display=t?"":"none",document.getElementById("preview-to").textContent=document.getElementById("designer-to").value||"Recipient",document.getElementById("preview-from").textContent=document.getElementById("designer-from").value||"Sender";const o=parseFloat(document.getElementById("designer-amount").value)||0;document.getElementById("preview-amount").textContent=`$${o.toFixed(2)}`;const i=document.getElementById("designer-code").value.trim(),s=document.getElementById("preview-code");s.textContent=i||"GC-";const d=document.getElementById("preview-expiry");if(a)d.textContent="Expires: ____/____/____",d.style.display="block";else if(n){const e=parseInt(document.getElementById("designer-expiry-value").value,10),t=document.getElementById("designer-expiry-unit").value;if(e>0){const n=new Date;"months"===t?n.setMonth(n.getMonth()+e):n.setFullYear(n.getFullYear()+e),d.textContent=`Expires: ${n.toLocaleDateString()}`,d.style.display="block"}else d.style.display="none"}else d.style.display="none"},Wa=e=>{Ua.innerHTML=giftCardBackgrounds[e].map((e=>`<button type="button" data-bg="${e}" class="w-full h-16 bg-cover bg-center rounded-md border-2 border-transparent hover:border-pink-400" style="background-image: url('${e}')"></button>`)).join("");const t=Ua.querySelector("button");t&&(t.classList.add("ring-2","ring-pink-500"),Oa.style.backgroundImage=`url('${t.dataset.bg}')`)};ja.addEventListener("click",(e=>{const t=e.target.closest("button");t&&(ja.querySelectorAll("button").forEach((e=>e.classList.remove("bg-gray-200","border-gray-300","border-b-0"))),t.classList.add("bg-gray-200","border-gray-300","border-b-0"),Wa(t.dataset.category))})),Ua.addEventListener("click",(e=>{const t=e.target.closest("button");t&&t.dataset.bg&&(Ua.querySelectorAll("button").forEach((e=>e.classList.remove("ring-2","ring-pink-500"))),t.classList.add("ring-2","ring-pink-500"),Oa.style.backgroundImage=`url('${t.dataset.bg}')`)}));document.getElementById("designer-show-to").addEventListener("change",Ya),document.getElementById("designer-show-from").addEventListener("change",Ya),document.getElementById("designer-set-expiry").addEventListener("change",(e=>{document.getElementById("designer-expiry-inputs").classList.toggle("hidden",!e.target.checked),Ya()})),Ha.addEventListener("input",Ya),_a.addEventListener("click",(async()=>{const e=parseInt(document.getElementById("designer-quantity").value,10);if(isNaN(e)||e<1)return void alert("Please enter a valid quantity.");const t=parseFloat(document.getElementById("designer-amount").value);if(isNaN(t)||t<=0)return void alert("Please enter a valid amount.");const n=writeBatch(db),a=[],o=document.getElementById("designer-set-expiry").checked,i=document.getElementById("designer-no-expiry").checked,s=document.getElementById("designer-code").value.trim();for(let i=0;i<e;i++){let i="";i=s&&1===e?s:"GC-";const d={amount:t,balance:t,history:[],recipientName:document.getElementById("designer-show-to").checked?document.getElementById("designer-to").value:"",senderName:document.getElementById("designer-show-from").checked?document.getElementById("designer-from").value:"",code:i,status:"Active",type:"Physical",createdAt:serverTimestamp(),backgroundUrl:Oa.style.backgroundImage.slice(5,-2).replace(/"/g,"")};if(o){const e=parseInt(document.getElementById("designer-expiry-value").value,10),t=document.getElementById("designer-expiry-unit").value,n=new Date;"months"===t?n.setMonth(n.getMonth()+e):n.setFullYear(n.getFullYear()+e),d.expiresAt=Timestamp.fromDate(n)}const r=doc(collection(db,"gift_cards"));"GC-"!==i&&n.set(r,d),a.push(d)}try{a.some((e=>"GC-"!==e.code))&&await n.commit();let e='\n            <html><head><title>Print Gift Cards</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&family=Parisienne&display=swap" rel="stylesheet">\n            <style>\n                body{font-family:\'Poppins\',sans-serif;margin:0;background-color:#f0f0f0;}\n                .font-parisienne{font-family:\'Parisienne\',cursive;}\n                .print-page { display: flex; flex-wrap: wrap; justify-content: start; align-content: start; gap: 10mm; padding: 10mm; page-break-after: always; }\n                .card-container{display:grid;grid-template-columns:repeat(2, 1fr);gap:0; width: fit-content;}\n                .card{width:400px;height:228px;text-shadow:1px 1px 3px rgba(0,0,0,0.6);box-shadow: 0 4px 8px rgba(0,0,0,0.2);-webkit-print-color-adjust: exact !important; color-adjust: exact !important;}\n                @media print {\n                    body { padding: 0; background-color: #fff; }\n                    .card { box-shadow: none; border: 1px solid #eee; }\n                }\n            </style></head><body><div class="print-page">\n        ';a.forEach((t=>{let n="",a="none";i?(n="Expires: ____/____/____",a="block"):t.expiresAt&&(n=`Expires: ${t.expiresAt.toDate().toLocaleDateString()}`,a="block"),e+=`\n                <div class="card-container">\n                    <div class="card rounded-lg p-4 flex flex-col justify-between bg-cover bg-center text-white" style="background-image: url('${t.backgroundUrl}');">\n                        <div class="flex justify-between items-start"><img src="https://placehold.co/100x100/d63384/FFFFFF?text=NE" class="w-12 h-12 rounded-full border-2 border-white" /><div class="text-right"><p class="font-parisienne text-3xl">Gift Card</p><p class="text-xs font-semibold tracking-wider">Nails Express</p></div></div>\n                        <div class="text-center"><p class="text-5xl font-bold">$${t.amount.toFixed(2)}</p></div>\n                        <div class="text-xs"><div class="flex justify-between font-semibold"><span style="display:${t.recipientName?"inline":"none"}">FOR: <span class="font-normal">${t.recipientName}</span></span><span style="display:${t.senderName?"inline":"none"}">FROM: <span class="font-normal">${t.senderName}</span></span></div><p class="mt-2 text-center font-mono tracking-widest text-sm">${t.code}</p><p class="mt-1 text-center text-[10px] opacity-80" style="display:${a}">${n}</p></div>\n                    </div>\n                    <div class="card rounded-lg p-4 flex flex-col justify-between bg-white text-gray-800" style="text-shadow: none;">\n                        <div class="w-full h-10 bg-black mt-2"></div>\n                        <p class="text-xs text-center text-gray-600 px-4 leading-relaxed">\n                            This card is redeemable for services at Nails Express. Treat this card like cash; it is not replaceable if lost or stolen. This card is non-refundable and cannot be exchanged for cash.\n                        </p>\n                        <div class="text-center text-xs pb-2">\n                            <p class="font-bold">Nails Express</p>\n                            <p>1560 Hustonville Rd #345, Danville, KY 40422</p>\n                            <p>(859) 236-2873</p>\n                        </div>\n                    </div>\n                </div>\n            `})),e+="</div></body></html>";const t=window.open("","_blank");t.document.write(e),t.document.close(),t.focus()}catch(e){console.error("Error saving physical gift cards:",e),alert("Could not save the gift cards. Please try again.")}}));document.getElementById("close-edit-gift-card-modal-btn").addEventListener("click",(()=>ge.classList.add("hidden"))),ge.querySelector(".modal-overlay").addEventListener("click",(()=>ge.classList.add("hidden")));const Va=e=>{const t=document.getElementById(e);t&&t.addEventListener("click",(e=>{const t=e.target.closest(".activate-gift-card-btn"),n=e.target.closest(".edit-gift-card-btn"),a=e.target.closest(".delete-gift-card-btn"),o=e.target.closest(".print-gift-card-btn");if(o){const e=o.dataset.id,t=Qe.find((t=>t.id===e));t&&openCardForPrint(t)}if(t){const e=t.dataset.id,n=Qe.find((t=>t.id===e));n&&mt(`Activate gift card ${n.code} for $${n.amount.toFixed(2)}?`,(async()=>{try{await updateDoc(doc(db,"gift_cards",e),{status:"Active"}),alert("Gift card has been activated!")}catch(e){console.error("Error activating gift card:",e),alert("Could not activate the gift card.")}}),"Activate")}else if(n){const e=Qe.find((e=>e.id===n.dataset.id));e&&(e=>{Ga.reset(),document.getElementById("edit-gift-card-id").value=e.id,document.getElementById("edit-gc-code-input").value=e.code||"",document.getElementById("edit-gc-original-amount").textContent=`$${e.amount.toFixed(2)}`,document.getElementById("edit-gc-current-balance").textContent=`$${e.balance.toFixed(2)}`;const t=document.getElementById("edit-gc-history");t.innerHTML="",e.history&&e.history.length>0?e.history.slice().reverse().forEach((e=>{const n="redeem"===e.type,a=document.createElement("div");a.className="text-sm p-2 rounded bg-gray-100 flex justify-between",a.innerHTML=`\n                    <div>\n                        <p class="font-semibold ${n?"text-red-600":"text-green-600"}">${n?"Redeemed":"Added"} $${e.amount.toFixed(2)}</p>\n                        <p class="text-xs text-gray-500">${e.notes||""}</p>\n                    </div>\n                    <div class="text-xs text-gray-500 text-right">\n                        ${new Date(1e3*e.timestamp.seconds).toLocaleString()}\n                    </div>\n                `,t.appendChild(a)})):t.innerHTML='<p class="text-sm text-gray-500 text-center">No transactions yet.</p>',ge.classList.remove("hidden"),ge.classList.add("flex")})(e)}else if(a){const e=a.dataset.id,t=Qe.find((t=>t.id===e));t&&mt(`Are you sure you want to delete gift card ${t.code}? This action cannot be undone.`,(async()=>{try{await deleteDoc(doc(db,"gift_cards",e)),alert(`Gift card ${t.code} has been deleted.`)}catch(e){console.error("Error deleting gift card:",e),alert("Could not delete the gift card.")}}))}}))};Va("gift-cards-table"),Va("gift-cards-table-admin"),document.getElementById("close-client-profile-modal-btn").addEventListener("click",(()=>ye.classList.add("hidden"))),ye.querySelector(".modal-overlay").addEventListener("click",(()=>ye.classList.add("hidden"))),onSnapshot(query(collection(db,"clients"),where("membership","!=",null)),(e=>{allClientMemberships=e.docs.map((e=>({id:e.id,...e.data()})));const t=document.getElementById("search-memberships").value.toLowerCase(),n=allClientMemberships.filter((e=>e.name.toLowerCase().includes(t)||e.membership.tierName.toLowerCase().includes(t)));renderClientMembershipsTable(n)})),document.getElementById("search-memberships").addEventListener("input",(()=>{const e=document.getElementById("search-memberships").value.toLowerCase(),t=allClientMemberships.filter((t=>t.name.toLowerCase().includes(e)||t.membership.tierName.toLowerCase().includes(e)));renderClientMembershipsTable(t)})),document.querySelector("#client-memberships-table tbody")?.addEventListener("click",(async e=>{const t=e.target.closest(".activate-membership-btn"),n=e.target.closest(".print-membership-card-btn"),a=e.target.closest(".delete-membership-record-btn"),o=e.target.closest(".reward-tracking-btn");if(o){const e=o.dataset.id,t=allClientMemberships.find((t=>t.id===e));t?_t(t):A("error","Client data not yet loaded. Please try again.")}else if(n){const e=n.dataset.id,t=allClientMemberships.find((t=>t.id===e));if(t&&t.membership){const e=allMembershipTiers.find((e=>e.id===t.membership.tierId));e?openMembershipCardForPrint(t,e):(console.error("Membership tier details not found for tier ID:",t.membership.tierId),A("error","Could not find tier details to print the card."))}else console.error("Client or membership data not found for printing card, ID:",e),A("error","Could not find client data to print the card.")}else if(t){const e=t.dataset.id,n=allClientMemberships.find((t=>t.id===e)),a=n?n.name:"this client";mt(`Activate membership for ${a}?`,(async()=>{try{await updateDoc(doc(db,"clients",e),{"membership.status":"Active"}),A("success",`Membership for ${a} activated!`)}catch(e){console.error("Error activating membership:",e),A("error","Could not activate membership. Please try again.")}}),"Activate")}else if(a){const e=a.dataset.id,t=allClientMemberships.find((t=>t.id===e)),n=t?t.name:"this client";mt(`Remove membership record for ${n}?`,(async()=>{try{await updateDoc(doc(db,"clients",e),{membership:null}),A("success",`Membership removed for ${n}.`)}catch(e){console.error("Error removing membership:",e),A("error","Could not remove membership. Please try again.")}}))}})),document.getElementById("close-membership-reward-modal-btn")?.addEventListener("click",(()=>{document.getElementById("membership-reward-modal").classList.add("hidden")})),document.getElementById("log-cash-spending-form")?.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("reward-client-id").value,n=document.getElementById("cash-spending-amount"),a=parseFloat(n.value);if(!t||isNaN(a)||a<=0)return void A("error","Please enter a valid positive amount.");const o=doc(db,"clients",t);try{await runTransaction(db,(async e=>{const t=await e.get(o);if(!t.exists())throw"Client document not found.";const n=t.data().membership||{};let i=n.rewardProgress||0,s=n.rewardHistory||[];if(i+=a,s.push({type:"spending",amount:a,timestamp:Timestamp.now()}),i>=membershipRewardSettings.threshold){let e=0;"fixed"===membershipRewardSettings.type?e=membershipRewardSettings.value:"percent"===membershipRewardSettings.type&&(e=a*(membershipRewardSettings.value/100)),s.push({type:"reward",rewardAmount:e,timestamp:Timestamp.now()}),i-=membershipRewardSettings.threshold}e.update(o,{"membership.rewardProgress":i,"membership.rewardHistory":s})})),A("success","Cash spending logged successfully!");const e=allClients.find((e=>e.id===t));e?_t(e):document.getElementById("membership-reward-modal").classList.add("hidden")}catch(e){console.error("Error logging cash spending:",e),A("error","Failed to log spending.")}}));const Xa=document.getElementById("membership-tier-modal"),za=document.getElementById("membership-tier-form"),Ja=(e=null)=>{za.reset(),e?(document.getElementById("membership-tier-modal-title").textContent="Edit Tier",document.getElementById("edit-membership-tier-id").value=e.id,document.getElementById("tier-name").value=e.name,document.getElementById("tier-price").value=e.price,document.getElementById("tier-discount").value=e.discount,document.getElementById("tier-benefits").value=e.benefits):(document.getElementById("membership-tier-modal-title").textContent="Add New Tier",document.getElementById("edit-membership-tier-id").value=""),Xa.classList.remove("hidden")},Za=()=>{onSnapshot(query(collection(db,"memberships"),orderBy("price")),(e=>{allMembershipTiers=e.docs.map((e=>({id:e.id,...e.data()}))),(e=>{const t=document.querySelector("#memberships-table tbody");t&&(t.innerHTML="",e.forEach((e=>{t.insertRow().innerHTML=`\n            <td class="px-6 py-4 font-bold">${e.name}</td>\n            <td class="px-6 py-4">$${e.price}/month</td>\n            <td class="px-6 py-4">${e.discount}%</td>\n            <td class="px-6 py-4 whitespace-pre-line">${e.benefits}</td>\n            <td class="px-6 py-4 text-center">\n                <button data-id="${e.id}" class="edit-membership-btn text-blue-500 mr-2"><i class="fas fa-edit"></i></button>\n                <button data-id="${e.id}" class="delete-membership-btn text-red-500"><i class="fas fa-trash"></i></button>\n            </td>\n        `})))})(allMembershipTiers)})),document.getElementById("add-new-membership-tier-btn").addEventListener("click",(()=>Ja())),document.getElementById("cancel-membership-tier-btn").addEventListener("click",(()=>Xa.classList.add("hidden"))),za.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("edit-membership-tier-id").value,n={name:document.getElementById("tier-name").value,price:parseFloat(document.getElementById("tier-price").value),discount:parseInt(document.getElementById("tier-discount").value,10),benefits:document.getElementById("tier-benefits").value};try{t?await updateDoc(doc(db,"memberships",t),n):await addDoc(collection(db,"memberships"),n),Xa.classList.add("hidden")}catch(e){alert("Could not save tier."),console.error(e)}})),document.querySelector("#memberships-table tbody").addEventListener("click",(e=>{const t=e.target.closest(".edit-membership-btn");t&&Ja(allMembershipTiers.find((e=>e.id===t.dataset.id)));const n=e.target.closest(".delete-membership-btn");n&&mt("Delete this tier?",(async()=>{await deleteDoc(doc(db,"memberships",n.dataset.id))}))}))},Ka=document.getElementById("add-client-membership-modal"),Qa=document.getElementById("add-client-membership-btn"),eo=document.getElementById("close-add-client-membership-modal-btn"),to=document.getElementById("add-client-membership-cancel-btn"),no=document.getElementById("add-client-membership-form"),ao=document.getElementById("add-cm-client-list"),oo=document.getElementById("add-cm-tier-select"),io=()=>{no.reset(),ao.innerHTML="";allClients.filter((e=>!e.membership)).forEach((e=>{ao.innerHTML+=`<option value="${e.name}"></option>`})),oo.innerHTML='<option value="">Select a tier...</option>',allMembershipTiers.forEach((e=>{oo.innerHTML+=`<option value="${e.id}">${e.name} ($${e.price}/month)</option>`})),Ka.classList.remove("hidden")},so=()=>{no.reset(),Ka.classList.add("hidden")};Qa&&Qa.addEventListener("click",io),eo&&eo.addEventListener("click",so),to&&to.addEventListener("click",so),Ka&&Ka.querySelector(".modal-overlay").addEventListener("click",so),no&&no.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("add-cm-client-name").value,n=document.getElementById("add-cm-tier-select").value,a=allClients.find((e=>e.name===t)),o=allMembershipTiers.find((e=>e.id===n));if(!a)return void A("error","Please select a valid client from the datalist.");if(!o)return void A("error","Please select a valid membership tier.");if(a.membership)return void A("warning",`${a.name} already has a membership. You can manage it from the table.`);const i={tierId:o.id,tierName:o.name,startDate:serverTimestamp(),status:"Active"};try{const e=doc(db,"clients",a.id);await updateDoc(e,{membership:i}),A("success",`Membership created for ${a.name}!`),so()}catch(e){console.error("Error adding client membership:",e),A("error","Could not create membership for this client.")}}));const ro=document.getElementById("add-client-note-form");ro&&ro.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("note-client-id").value,n=document.getElementById("new-client-note"),a=n.value.trim();if(!t||!a)return void alert("Cannot save an empty note.");const o={text:a,timestamp:Timestamp.now()};try{const e=doc(db,"clients",t);await updateDoc(e,{notes:arrayUnion(o)}),n.value="";const a=allClients.find((e=>e.id===t));a&&Ot(a)}catch(e){console.error("Error saving client note:",e),alert("Could not save the note.")}})),(async()=>{const e=await getDocs(collection(db,"services"));servicesData={},e.forEach((e=>{servicesData[e.id]=e.data().items})),allServicesList=[],Object.values(servicesData).forEach((e=>{e.forEach((e=>{if(e.name&&e.price){const t=parseFloat(String(e.price).replace(/[^0-9.]/g,""));isNaN(t)||allServicesList.push({name:e.name,price:t,duration:e.duration||bookingSettings.defaultDuration})}}))})),wt()})(),(()=>{Ha.reset(),document.getElementById("designer-quantity").value=1,document.getElementById("preview-code").textContent=`GC-${Date.now()}${[...Array(4)].map((()=>Math.floor(10*Math.random()))).join("")}`,ja.innerHTML=Object.keys(giftCardBackgrounds).map((e=>`<button type="button" data-category="${e}" class="px-3 py-1 text-sm font-medium rounded-t-lg">${e}</button>`)).join("");const e=ja.querySelector("button");e&&(e.classList.add("bg-gray-200","border-gray-300","border-b-0"),Wa(e.dataset.category));const t=document.getElementById("designer-set-expiry"),n=document.getElementById("designer-no-expiry"),a=document.getElementById("designer-expiry-inputs");t.addEventListener("change",(e=>{e.target.checked&&(n.checked=!1),a.classList.toggle("hidden",!e.target.checked),Ya()})),n.addEventListener("change",(e=>{e.target.checked&&(t.checked=!1,a.classList.add("hidden")),Ya()})),Ya()})();const lo=cn();const co=(new Date).getMonth();document.getElementById("finished-date-filter").value=lo,Te=lo,Ct(Bt(allFinishedClients,"","All",Te)),document.getElementById("staff-earning-date").value=lo,document.getElementById("earning-date-filter").value=lo,Ae=lo,Mt();const mo=document.getElementById("dashboard-earning-date-filter"),uo=document.getElementById("dashboard-staff-earning-date-full");uo&&(uo.value=lo),mo.value=lo,je=lo,document.getElementById("salon-earning-date").value=lo;const po=document.getElementById("salon-earning-range-filter"),go=document.getElementById("salon-earning-date-filter");po.value=co,go.style.display="none",_e=String(co),Oe="",Nt(At(Xe,Oe,_e)),document.getElementById("expense-date").value=lo,document.getElementById("sign-out-btn").addEventListener("click",(()=>{signOut(auth)})),document.getElementById("floating-booking-btn").addEventListener("click",(()=>{openAddAppointmentModal(cn())})),document.getElementById("staff-details-date-filter").value=lo,setInterval((()=>{const e=new Date;allAppointments.forEach((t=>{if(nt.includes(t.id))return;const n=t.appointmentTimestamp.toDate(),a=(n.getTime()-e.getTime())/6e4;if(a>0&&a<=60){const e=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=Array.isArray(t.services)?t.services[0]:t.services;A("reminder",`Reminder: ${t.name}'s appointment for ${a} is at ${e}.`),nt.push(t.id)}}))}),6e4)}document.getElementById("landing-membership-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("landing-ms-submit-btn");t.disabled=!0,t.textContent="Processing...";const n=document.getElementById("ms-tier-select").value,a=allMembershipTiers.find((e=>e.id===n));if(!a)return addNotification("error","Please select a valid membership tier."),t.disabled=!1,void(t.textContent="Submit Membership Request");try{if(currentUserId&&auth.currentUser&&!auth.currentUser.isAnonymous){const e=doc(db,"clients",currentUserId),t={tierId:a.id,tierName:a.name,startDate:serverTimestamp(),status:"Pending"};await updateDoc(e,{membership:t}),addNotification("success","Success! Your membership request has been sent. It will be activated once payment is confirmed."),closeMembershipPurchaseModal()}else{const e=document.getElementById("ms-buyer-name").value,t=document.getElementById("ms-buyer-email").value,o=document.getElementById("ms-buyer-phone").value;if(!e||!t||!o)throw addNotification("error","Please fill out all your information to create an account."),new Error("Missing buyer info");sessionStorage.setItem("pendingMembershipPurchase",n),sessionStorage.setItem("signupDetails",JSON.stringify({name:e,email:t,phone:o})),await createUserWithEmailAndPassword(auth,t,o),await sendMembershipConfirmationEmail({name:e,email:t,phone:o,tierName:a.name}),closeMembershipPurchaseModal()}}catch(e){"auth/email-already-in-use"===e.code?addNotification("error","An account with this email already exists. Please log in to purchase a membership."):(console.error("Error during membership purchase:",e),alert(`Could not process your request. Error: ${e.message}`))}finally{t.disabled=!1,t.textContent="Submit Membership Request"}}));
